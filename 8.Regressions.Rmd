---
title: "Regressions"
author: "Helena Davies"
date: "24/05/2021"
output: html_document
---

Configure global options for all chunks
```{r Setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  comment = '',
  prompt = FALSE,
  cache = FALSE
  )
```

Clear global environment prior to initiation
```{r Clear global environment}
remove(list = ls())
```

Add the add_numeric function - used to convert character variables into numeric variables
Add the remove_duplicates function - used to deduplicate and remove NAs from IDs
Add the sumscores function - used to generate sumscores
Add the package_check function - used to install and load dependencies
Add the imp_check function - used to check variables for implausible values
```{r Read in functions}
source(file = "/Users/helenadavies/werk/ilovedata/scripts/functions/add_numeric.R")
source(file = "/Users/helenadavies/werk/ilovedata/scripts/functions/remove_duplicates.R")
source(file = "/Users/helenadavies/werk/ilovedata/scripts/functions/package_check.R")
source("./functions.R")
```

Use package_check to install and load dependencies
Load tidyverse last
```{r Install load dependencies}
packages <- c("summarytools",
              "sjlabelled",
              "Amelia",
              "gtsummary",
              "broom",
              "tidyverse")
package_check(packages)
```

Retrieve recent date
We are using the recent date to save files with paste0() as an extension to not overwrite old versions
```{r Recent date}
date <- Sys.Date()
date
```

# Read in data
```{r Read in data}
dat <- readRDS(file = "../data_cleaned/final_dat2022-01-24.rds")
dim(dat)
   colnames(dat)
```

## BASIC MODELS 
### Re-ordering variables / converting to factors
First, re-order all variables to get desired reference category for plotting - put largest category as reference
Age
```{r Re-order age levels}
dat <- dat %>%
  mutate(age_category_COVID_baseline = factor(age_category_COVID_baseline,
                       levels = c("56-65", # Largest category
                                  "16-25",
                                  "26-35",
                                  "36-45",
                                  "46-55",
                                   "66-70",
                                   "71+")
                       )
         )

# Check
dat %>%
  freq(age_category_COVID_baseline)
```

Race
```{r Re-order race levels}
dat <- dat %>%
  mutate(race_binary = factor(race_binary,
                       levels = c("White", # Largest category
                                  "Racially minoritised"
                                  )))
dat %>%
  freq(race_binary)
```

Psychiatric disorder
```{r  Re-order psych disorder levels}
# First recode to "Yes" and "No"
dat <- dat %>%
  mutate(psych_disorder_factor =
           case_when(
            mental_health_diagnosis == "Psychiatric disorder" ~ "Yes", 
            mental_health_diagnosis == "No psychiatric disorder" ~ "No")
  )

# Check 
dat %>%
  freq(psych_disorder_factor)

# Then change order
dat <- dat %>%
  mutate(psych_disorder_factor = factor(psych_disorder_factor,
                       levels = c( "No", # Ref category
                                  "Yes"
                                  )))

# Check again
dat %>%
  freq(psych_disorder_factor)
```

# Binge eating - minimal model
Age, gender, race, education, psych disorder
```{r Binge eating minimal model}
model1 <- glm(NEW_binge_eating_pandemic ~ gender_cleaned + age_category_COVID_baseline +  race_binary + highest_education + psych_disorder_factor,
               data = dat,
               family = "binomial")

tidy(model1,
     conf.int=TRUE,
     exponentiate=TRUE)

fitted(model1) %>% 
  length()

# How many people in this model have the outcome? 
dat %>%
   filter(!is.na(age_category_COVID_baseline) & 
          !is.na(gender_cleaned) &
            !is.na(race_binary) & 
             !is.na(NEW_binge_eating_pandemic) &
             !is.na(highest_education) &
             !is.na(psych_disorder_factor)) %>%
   freq(highest_education)
```

Plot
```{r Binge eating minimal model plot}
dat_plot <- dat %>%
  select("Age" = "age_category_COVID_baseline",
         "Gender" = "gender_cleaned",
         "Race" = "race_binary",
         "Pandemic_binge_eating" = "NEW_binge_eating_pandemic",
         "Education" = "highest_education",
         "Psych_disorder" = "psych_disorder_factor"
         )


# 1. Plot
explanatory <- c("Age",
                 "Gender",
                 "Race",
                 "Education",
                 "Psych_disorder")


dependent <- "Pandemic_binge_eating"

BE_minimal_dat_plot <- dat_plot %>%
  finalfit::or_plot(dependent, explanatory, 
          breaks = c(0.5, 1, 5, 10, 20, 30),
          table_text_size = 3.0,
          title_text_size = 15,
          dependent_label = "New experience of binge eating during pandemic",
          remove_ref = TRUE
          )
```

```{r Save BE minimal level plot}
ggsave(
  paste0("BE_minimal_dat_plot",
                    date,
                    ".png"),
  plot = BE_minimal_dat_plot,
  device = "png", 
  path = "/Users/helenadavies/werk/EDBEHSELFHARM2/gitEDBEHSELFHARM/plots/minimal", 
  scale = 1,
  width = 25,
  height = 12,
  units = "cm"
  )
```

# Low weight - minimal model
Age, gender, race, education, psych disorder
```{r Low weight minimal model}
model2 <- glm(NEW_low_weight_pandemic ~ age_category_COVID_baseline + gender_cleaned + race_binary+ psych_disorder_factor+ highest_education,
               data = dat,
               family = "binomial")

tidy(model2,
     conf.int=TRUE,
     exponentiate=TRUE)

fitted(model2) %>% 
  length()

# How many people in this model have the outcome? n = 1943 (of 19636)
dat %>%
   filter(!is.na(age_category_COVID_baseline) & 
          !is.na(gender_cleaned) &
            !is.na(race_binary) & 
             !is.na(NEW_low_weight_pandemic) &
             !is.na(highest_education) &
             !is.na(psych_disorder_factor)) %>%
   freq(NEW_low_weight_pandemic)
```

Plot
```{r Low weight minimal model plot}
dat_plot <- dat %>%
  select("Age" = "age_category_COVID_baseline",
         "Gender" = "gender_cleaned",
         "Race" = "race_binary",
         "Pandemic_low_weight" = "NEW_low_weight_pandemic",
        "Education" = "highest_education",
         "Psych_disorder" = "psych_disorder_factor")

#1. Plot
explanatory <- c("Age",
                 "Gender",
                 "Race",
                 "Education",
                 "Psych_disorder")


dependent <- "Pandemic_low_weight"

LW_minimal_dat_plot <- dat_plot %>%
  finalfit::or_plot(dependent, explanatory, 
          breaks = c(0.5, 1, 5, 10, 20, 30),
          table_text_size = 3.0,
          title_text_size = 15,
          dependent_label = "New experience of low weight during pandemic",
          remove_ref = TRUE)
```

```{r Save LW minimal level plot}
ggsave(
  paste0("LW_minimal_dat_plot",
                    date,
                    ".png"),
  plot = LW_minimal_dat_plot,
  device = "png", 
  path = "/Users/helenadavies/werk/EDBEHSELFHARM2/gitEDBEHSELFHARM/plots/minimal", 
  scale = 1,
  width = 25,
  height = 12,
  units = "cm"
  )
```

# Harmful ideation - minimal model
Age, gender, race, education, psych disorder, prepandemic experience
```{r PHarmful ideation minimal model}
model3 <- glm(NEW_harmful_ideation_pandemic ~ age_category_COVID_baseline + gender_cleaned + race_binary+ psych_disorder_factor+ highest_education,
               data = dat,
               family = "binomial")

tidy(model3,
     conf.int=TRUE,
     exponentiate=TRUE)

fitted(model3) %>% 
  length() 

# How many people in this model have the outcome? 
dat %>%
   filter(!is.na(age_category_COVID_baseline) & 
          !is.na(gender_cleaned) &
            !is.na(race_binary) & 
             !is.na(NEW_harmful_ideation_pandemic) &
             !is.na(highest_education) &
             !is.na(psych_disorder_factor)) %>%
   freq(NEW_harmful_ideation_pandemic)
```

Plot
```{r Harmful ideation minimal model plot}
dat_plot <- dat %>%
  select("Age" = "age_category_COVID_baseline",
         "Gender" = "gender_cleaned",
         "Race" = "race_binary",
         "Pandemic_harmful_ideation" = "NEW_harmful_ideation_pandemic",
         "Education" = "highest_education",
         "Psych_disorder" = "psych_disorder_factor")

# 1. Plot
explanatory <- c("Age",
                 "Gender",
                 "Race",
                 "Education",
                 "Psych_disorder")


dependent <- "Pandemic_harmful_ideation"


HI_minimal_dat_plot <- dat_plot %>%
  finalfit::or_plot(dependent, explanatory, 
          breaks = c(0.5, 1, 5, 10, 20, 30),
          table_text_size = 3.0,
          title_text_size = 13,
          dependent_label = "Harmful ideation during pandemic",
          remove_ref = TRUE)
```

```{r Save HI minimal level plot}
ggsave(
  paste0("HI_minimal_dat_plot",
                    date,
                    ".png"),
  plot = HI_minimal_dat_plot,
  device = "png", 
  path = "/Users/helenadavies/werk/EDBEHSELFHARM2/gitEDBEHSELFHARM/plots/minimal", 
  scale = 1,
  width = 25,
  height = 12,
  units = "cm"
  )
```

# Self-harm - minimal model
Age, gender, race, education, psych disorder, prepandemic experience
```{r Self-harm minimal model}
model5 <- glm(NEW_selfharm_pandemic ~ age_category_COVID_baseline + gender_cleaned + race_binary + highest_education +psych_disorder_factor,
               data = dat,
               family = "binomial")

tidy(model5,
     conf.int=TRUE,
     exponentiate=TRUE)

fitted(model5) %>% 
  length()

# How many people in this model have the outcome? n = 3,751 (of 35858)
dat %>%
   filter(!is.na(age_category_COVID_baseline) & 
          !is.na(gender_cleaned) &
            !is.na(race_binary) & 
             !is.na(NEW_selfharm_pandemic) &
             !is.na(highest_education) &
             !is.na(psych_disorder_factor)) %>%
   freq(NEW_selfharm_pandemic)
```

Plot
```{r Self-harm minimal model}
dat_plot <- dat %>%
  select("Age" = "age_category_COVID_baseline",
         "Gender" = "gender_cleaned",
         "Race" = "race_binary",
         "Pandemic_selfharm" = "NEW_selfharm_pandemic",
        "Education" = "highest_education",
         "Psych_disorder" = "psych_disorder_factor")

# 1. Plot
explanatory <- c("Age",
                 "Gender",
                 "Race",
                 "Education",
                 "Psych_disorder")


dependent <- "Pandemic_selfharm"

SH_minimal_dat_plot <- dat_plot %>%
  finalfit::or_plot(dependent, explanatory, 
          breaks = c(0.5, 1, 5, 10, 20, 30),
          table_text_size = 3.0,
          title_text_size = 15,
          dependent_label = "Self-harm during pandemic",
          remove_ref = TRUE)
```

```{r Save SH minimal level plot}
ggsave(
  paste0("SH_minimal_dat_plot",
                    date,
                    ".png"),
  plot = SH_minimal_dat_plot,
  device = "png", 
  path = "/Users/helenadavies/werk/EDBEHSELFHARM2/gitEDBEHSELFHARM/plots/minimal", 
  scale = 1,
  width = 25,
  height = 12,
  units = "cm"
  )
```
         
# EXTENDED MODELS
Adding: Key worker/employment status, vulnerable group member, pandemic worry, positive COVID test, loss of loved one, lonelieness, change in main eco activity, change in living situation

## First, re-order / rename additional variables ready for plotting
Employment
```{r Re-order employment variable}
dat <- dat %>%
  mutate(paid_employment_key_worker = factor(paid_employment_key_worker,
                       levels = c("Key worker",
                                  "Paid employment",
                                  "Not paid employment",
                                  "Retired",
                                  "Student"
                                  )))

dat %>%
  freq(paid_employment_key_worker)
```


# First, check number of people in each model
```{r check number of people in each model}
# How many people in this model have the outcome? 
dat %>%
   filter( !is.na(age_category_COVID_baseline) & 
             !is.na(gender_cleaned) &
             !is.na(race_binary) & 
             !is.na(NEW_binge_eating_pandemic) &
             !is.na(highest_education) &
             !is.na(psych_disorder_factor) &
             !is.na(paid_employment_key_worker) & 
             !is.na(vulnerable_group_member) &
             !is.na(panworry_total_score) & 
             !is.na(positive_covid_test_before_BE_final) &
             !is.na(increased_loneliness_during_pandemic) &
             !is.na(main_eco_change_before_BE_final)  &
             !is.na(increased_loneliness_during_pandemic) &
             !is.na(living_situation_change_before_BE_final)
          ) %>%
   freq(NEW_binge_eating_pandemic)

# How many people in this model have highest education data?
dat %>%
   filter( !is.na(age_category_COVID_baseline) & 
             !is.na(gender_cleaned) &
             !is.na(race_binary) & 
             !is.na(NEW_binge_eating_pandemic) &
             !is.na(highest_education) &
             !is.na(psych_disorder_factor) &
             !is.na(paid_employment_key_worker) & 
             !is.na(vulnerable_group_member) &
             !is.na(panworry_total_score) & 
             !is.na(positive_covid_test_before_BE_final) &
             !is.na(increased_loneliness_during_pandemic) &
             !is.na(main_eco_change_before_BE_final)  &
             !is.na(increased_loneliness_during_pandemic) &
             !is.na(living_situation_change_before_BE_final)
          ) %>%
   freq(highest_education)

# How many people in this model have race category data?
dat %>%
   filter( !is.na(age_category_COVID_baseline) & 
             !is.na(gender_cleaned) &
             !is.na(race_binary) & 
             !is.na(NEW_binge_eating_pandemic) &
             !is.na(highest_education) &
             !is.na(psych_disorder_factor) &
             !is.na(paid_employment_key_worker) & 
             !is.na(vulnerable_group_member) &
             !is.na(panworry_total_score) & 
             !is.na(positive_covid_test_before_BE_final) &
             !is.na(increased_loneliness_during_pandemic) &
             !is.na(main_eco_change_before_BE_final)  &
             !is.na(increased_loneliness_during_pandemic) &
             !is.na(living_situation_change_before_BE_final)
          ) %>%
   freq(race_categories)

# How many people in this model have race category data?
dat %>%
   filter( !is.na(age_category_COVID_baseline) & 
             !is.na(gender_cleaned) &
             !is.na(race_binary) & 
             !is.na(NEW_binge_eating_pandemic) &
             !is.na(highest_education) &
             !is.na(psych_disorder_factor) & 
             !is.na(paid_employment_key_worker) & 
             !is.na(vulnerable_group_member) &
             !is.na(panworry_total_score) & 
             !is.na(positive_covid_test_before_BE_final) &
             !is.na(increased_loneliness_during_pandemic) &
             !is.na(main_eco_change_before_BE_final)  &
             !is.na(increased_loneliness_during_pandemic) &
             !is.na(living_situation_change_before_BE_final)
          ) %>%
   freq(race_categories)

# How many people in this model have gender category data?
dat %>%
   filter( !is.na(age_category_COVID_baseline) & 
             !is.na(gender_cleaned) &
             !is.na(race_binary) & 
             !is.na(NEW_binge_eating_pandemic) &
             !is.na(highest_education) &
             !is.na(psych_disorder_factor) &
             !is.na(paid_employment_key_worker) & 
             !is.na(vulnerable_group_member) &
             !is.na(panworry_total_score) & 
             !is.na(positive_covid_test_before_BE_final) &
             !is.na(increased_loneliness_during_pandemic) &
             !is.na(main_eco_change_before_BE_final)  &
             !is.na(increased_loneliness_during_pandemic) &
             !is.na(living_situation_change_before_BE_final)
          ) %>%
   freq(gender)

# How many people in this model have gender category data?
dat %>%
   filter( !is.na(age_category_COVID_baseline) & 
             !is.na(gender_cleaned) &
             !is.na(race_binary) & 
             !is.na(NEW_binge_eating_pandemic) &
             !is.na(highest_education) &
             !is.na(psych_disorder_factor) &
             !is.na(paid_employment_key_worker) & 
             !is.na(vulnerable_group_member) &
             !is.na(panworry_total_score) & 
             !is.na(positive_covid_test_before_BE_final) &
             !is.na(increased_loneliness_during_pandemic) &
             !is.na(main_eco_change_before_BE_final)  &
             !is.na(increased_loneliness_during_pandemic) &
             !is.na(living_situation_change_before_BE_final)
          ) %>%
   freq(transgender)
```

## Binge eating - extended model
Age, gender, race, education, psych disorder, key worker/employment status, vulnerable group member, pandemic worry, positive COVID test, loss of loved one, lonelieness, change in main eco activity, change in living situation

Pandemic worry: If you include a continuous predictor in your logistic regression, the exponentiated coefficient represents the odds ratio for one unit change in the predictor. Often, one unit isn't meaningful and you want the odds ratio for, say, 10 units. To calculate this, just exponentiate the coefficient multiplied by 10: 𝑂𝑅10=exp(𝛽⋅10). 
```{r Binge eating extended model}
model6 <- glm(NEW_binge_eating_pandemic ~  
                 age_category_COVID_baseline +
                 gender_cleaned +
                 race_binary +
                 highest_education +
                 psych_disorder_factor +
                 paid_employment_key_worker +
                 vulnerable_group_member +
                 panworry_total_score + 
                 positive_covid_test_before_BE_final +
                 lost_someone_before_BE_final +
                 increased_loneliness_during_pandemic +
                 main_eco_change_before_BE_final +
                 living_situation_change_before_BE_final,
                 data = dat,
                 family = "binomial"
              )

binge_eating_main <- tidy(model6,
     conf.int=TRUE,
     exponentiate=TRUE)

fitted(model6) %>% 
  length()

# Pseudo R2
DescTools::PseudoR2(model6, which = "McFadden")
DescTools::PseudoR2(model6, which = "McFaddenAdj")
DescTools::PseudoR2(model6, which = "Nagelkerke")

```

Plot
```{r Binge eating extended model plot}
dat_plot <- dat %>%
  select("Age" = "age_category_COVID_baseline",
         "Gender" = "gender_cleaned",
         "Race" = "race_binary",
         "Pandemic_binge_eating" = "NEW_binge_eating_pandemic",
         "Education" = "highest_education",
         "Psych_disorder" = "psych_disorder_factor",
         "Employment" = "paid_employment_key_worker",
         "Vulnerable_group_member" ="vulnerable_group_member",
         "Pandemic_worry" = "panworry_total_score",
         "Covid_test" = "positive_covid_test_before_BE_final", 
         "Loss" = "lost_someone_before_BE_final", 
         "Increased_loneliness" = "increased_loneliness_during_pandemic",
         "Main_eco_act_change" = "main_eco_change_before_BE_final", 
         "Living_sit_change" = "living_situation_change_before_BE_final" 
        )


# 1. Plot
explanatory <- c("Age",
                 "Gender",
                 "Race",
                 "Education",
                 "Psych_disorder",
                 "Employment",
                 "Vulnerable_group_member",
                 "Pandemic_worry",
                 "Covid_test",
                 "Loss",
                 "Increased_loneliness",
                 "Main_eco_act_change",
                 "Living_sit_change"
               )

dependent <- "Pandemic_binge_eating"

BE_extended_dat_plot <- dat_plot %>%
  finalfit::or_plot(dependent,
                    explanatory, 
          breaks = c(0.5, 1, 5, 10, 20, 30),
          table_text_size = 3.0,
          title_text_size = 15,
          dependent_label = "New experience of binge eating during pandemic",
          remove_ref = FALSE) 
```

```{r Save BE extended level plot}
ggsave(
  paste0("BE_extended_dat_plot",
                    date,
                    ".png"),
  plot = BE_extended_dat_plot,
  device = "png", 
  path = "/Users/helenadavies/werk/EDBEHSELFHARM2/gitEDBEHSELFHARM/plots/extended", 
  scale = 1,
  width = 25,
  height = 20,
  units = "cm"
  )
```

# Low weight - extended model
Age, gender, race, education, psych disorder, key worker/employment status, vulnerable group member, pandemic worry, positive COVID test, loss of loved one, lonelieness, change in main eco activity, change in living situation
```{r Low weight extended model}
model7 <- glm(NEW_low_weight_pandemic ~ age_category_COVID_baseline +
                 gender_cleaned +
                 race_binary +
                 highest_education +
                 psych_disorder_factor +
                 paid_employment_key_worker +
                 vulnerable_group_member +
                 panworry_total_score + 
                 positive_covid_test_before_LW_final + 
                 lost_someone_before_LW_final + 
                 increased_loneliness_during_pandemic + 
                 main_eco_change_before_LW_final + 
                 living_situation_change_before_LW_final +
                 ocd.compulsive_beh_mental_act_binary +
                 ocd.repetitive_unpleasant_thoughts_binary,
                 data = dat,
                 family = "binomial")

low_weight_main <- tidy(model7,
     conf.int=TRUE,
     exponentiate=TRUE)

fitted(model7) %>% 
  length()

# Pseudo R2
DescTools::PseudoR2(model7, which = "McFadden")
DescTools::PseudoR2(model7, which = "McFaddenAdj")
DescTools::PseudoR2(model7, which = "Nagelkerke")
```

Plot
```{r Low weight extended model plot}
dat_plot <- dat %>%
  select("Age" = "age_category_COVID_baseline",
         "Gender" = "gender_cleaned",
         "Race" = "race_binary",
         "Pandemic_low_weight" = "NEW_low_weight_pandemic",
         "Education" = "highest_education",
         "Psych_disorder" = "psych_disorder_factor",
         "Employment" = "paid_employment_key_worker",
         "Vulnerable_group_member" ="vulnerable_group_member",
        "Pandemic_worry" = "panworry_total_score",
         "Covid_test" = "positive_covid_test_before_LW_final",
         "Loss" = "lost_someone_before_LW_final",
         "Increased_loneliness" = "increased_loneliness_during_pandemic",
         "Main_eco_act_change" = "main_eco_change_before_LW_final",
         "Living_sit_change" = "living_situation_change_before_LW_final",
        "Compulsive_beh_mental_act" = "ocd.compulsive_beh_mental_act_binary",
         "Repetitive_unpleasant_thoughts" = "ocd.repetitive_unpleasant_thoughts_binary"
        )

# 1. Plot
explanatory <- c("Age",
                 "Gender",
                 "Race",
                 "Education",
                 "Psych_disorder",
                 "Employment",
                 "Vulnerable_group_member",
                 "Pandemic_worry",
                 "Covid_test",
                 "Loss",
                 "Increased_loneliness",
                 "Main_eco_act_change",
                 "Living_sit_change",
                "Compulsive_beh_mental_act",
                "Repetitive_unpleasant_thoughts")

dependent <- "Pandemic_low_weight"

LW_extended_dat_plot <- dat_plot %>%
  finalfit::or_plot(dependent,
                    explanatory, 
          breaks = c(0.5, 1, 5, 10, 20, 30),
          table_text_size = 3.0,
          title_text_size = 15,
          dependent_label = "New experience of low weight during pandemic",
           remove_ref = FALSE) 
```

```{r Save LW extended level plot}
ggsave(
  paste0("LW_extended_dat_plot",
                    date,
                    ".png"),
  plot = LW_extended_dat_plot,
  device = "png", 
  path = "/Users/helenadavies/werk/EDBEHSELFHARM2/gitEDBEHSELFHARM/plots/extended", 
  scale = 1,
  width = 25,
  height = 20,
  units = "cm"
  )
```

# Harmful ideation - extended model
Age, gender, race, education, psych disorder, key worker/employment status, vulnerable group member, pandemic worry, positive COVID test, loss of loved one, lonelieness, change in main eco activity, change in living situation
```{r Harmful ideation extended model}
model8 <- glm(NEW_harmful_ideation_pandemic ~ age_category_COVID_baseline + 
                 gender_cleaned + 
                 race_binary + 
                 highest_education + 
                 psych_disorder_factor + 
                 paid_employment_key_worker + 
                 vulnerable_group_member + 
                 panworry_total_score + 
                 positive_covid_test_before_HI_final + 
                 lost_someone_before_HI_final + 
                 increased_loneliness_during_pandemic +
                 main_eco_change_before_HI_final +
                 living_situation_change_before_HI_final,
               data = dat,
               family = "binomial")

harmful_ideation_main <- tidy(model8,
     conf.int=TRUE,
     exponentiate=TRUE)

fitted(model8) %>% 
  length()

# Psuedo R2
DescTools::PseudoR2(model8, which = "McFadden")
DescTools::PseudoR2(model8, which = "McFaddenAdj")
DescTools::PseudoR2(model8, which = "Nagelkerke")


test <- dat %>%
  filter(!is.na(NEW_harmful_ideation_pandemic) &
                 !is.na(age_category_COVID_baseline) &
                 !is.na(gender_cleaned) &
                 !is.na(race_binary ) &
                 !is.na(highest_education ) &
                 !is.na(psych_disorder_factor ) &
                 !is.na(paid_employment_key_worker ) &
                 !is.na(vulnerable_group_member ) &
                 !is.na(panworry_total_score ) &
                 !is.na(positive_covid_test_before_HI_final ) &
                 !is.na(lost_someone_before_HI_final ) &
                 !is.na(increased_loneliness_during_pandemic ) &
                 !is.na(main_eco_change_before_HI_final ) &
                 !is.na(living_situation_change_before_HI_final))
             

test %>% 
  group_by(NEW_harmful_ideation_pandemic) %>%
  freq(lost_someone_before_HI_final)
```


Plot
```{r Harmful ideation extended model plot}
dat_plot <- dat %>%
  select("Age" = "age_category_COVID_baseline",
         "Gender" = "gender_cleaned",
         "Race" = "race_binary",
         "Pandemic_harmful_ideation" = "NEW_harmful_ideation_pandemic",
         "Education" = "highest_education",
         "Psych_disorder" = "psych_disorder_factor",
         "Employment" = "paid_employment_key_worker",
         "Vulnerable_group_member" ="vulnerable_group_member",
         "Pandemic_worry" = "panworry_total_score",
         "Covid_test" = "positive_covid_test_before_HI_final",
         "Loss" = "lost_someone_before_HI_final",
         "Increased_loneliness" = "increased_loneliness_during_pandemic",
         "Main_eco_act_change" = "main_eco_change_before_HI_final",
         "Living_sit_change" = "living_situation_change_before_HI_final"
         
        )

# 1. Plot
explanatory <- c("Age",
                "Gender",
                 "Race",
                 "Education",
                 "Psych_disorder",
                 "Employment",
                 "Vulnerable_group_member",
                 "Pandemic_worry",
                 "Covid_test",
                 "Loss",
                 "Increased_loneliness",
                 "Main_eco_act_change",
                 "Living_sit_change")

dependent <- "Pandemic_harmful_ideation"

HI_extended_dat_plot <- dat_plot %>%
  finalfit::or_plot(dependent, explanatory, 
          breaks = c(0.5, 1, 5, 10, 20, 30),
          table_text_size = 3.0,
          title_text_size = 13,
          dependent_label = "Harmful ideation during pandemic",
           remove_ref = FALSE) 
```

```{r Save HI extended level plot}
ggsave(
  paste0("HI_extended_dat_plot",
                    date,
                    ".png"),
  plot = HI_extended_dat_plot,
  device = "png", 
  path = "/Users/helenadavies/werk/EDBEHSELFHARM2/gitEDBEHSELFHARM/plots/extended", 
  scale = 1,
  width = 25,
 height = 20,
  units = "cm"
  )
```

## Investigating loss and harmful ideation
```{r regression loss and harmful ideation only}
model8a <- glm(NEW_harmful_ideation_pandemic ~ lost_someone_before_HI_final,
               data = dat,
               family = "binomial")

tidy(model8a,
     conf.int=TRUE,
     exponentiate=TRUE)

fitted(model8a) %>% 
  length()

# Plot
dat_plot <- dat %>%
  select("Pandemic_harmful_ideation" = "NEW_harmful_ideation_pandemic",
         "Loss" = "lost_someone_before_HI_final",
         )

explanatory <- "Loss"

dependent <- "Pandemic_harmful_ideation"

HI_extended_dat_plot_a <- dat_plot %>%
  finalfit::or_plot(dependent,
                    explanatory, 
          breaks = c(0.5, 1, 5, 10, 20, 30),
          table_text_size = 3.0,
          title_text_size = 13,
          dependent_label = "Harmful ideation during pandemic",
           remove_ref = FALSE) 


# Frequency of exposure in model
dat %>%
   filter( !is.na(age_category_COVID_baseline) & 
             !is.na(gender_cleaned) &
             !is.na(race_binary) & 
             !is.na(NEW_harmful_ideation_pandemic) &
             !is.na(highest_education) &
             !is.na(psych_disorder_factor) &
             !is.na(paid_employment_key_worker) & 
             !is.na(vulnerable_group_member) &
             !is.na(panworry_total_score) & 
             !is.na(positive_covid_test_before_HI_final) &
             !is.na(increased_loneliness_during_pandemic) &
             !is.na(lost_someone_before_HI_final) &
             !is.na(main_eco_change_before_HI_final)  &
             !is.na(increased_loneliness_during_pandemic) &
             !is.na(living_situation_change_before_HI_final)
          ) %>%
   freq(lost_someone_before_HI_final)
```



# Self-harm - extended model
Age, gender, race, education, psych disorder, key worker/employment status, vulnerable group member, pandemic worry, positive COVID test, loss of loved one, lonelieness, change in main eco activity, change in living situation
```{r Self-harm extended model}
model10 <- glm(NEW_selfharm_pandemic ~ age_category_COVID_baseline + 
                 gender_cleaned + 
                 race_binary + 
                 highest_education + 
                 psych_disorder_factor + 
                 paid_employment_key_worker + 
                 vulnerable_group_member + 
                 panworry_total_score + 
                 positive_covid_test_before_SH_final + 
                 lost_someone_before_SH_final + 
                 increased_loneliness_during_pandemic +
                 main_eco_change_before_SH_final +
                 living_situation_change_before_SH_final,
               data = dat,
               family = "binomial")

selfharm_main <-  tidy(model10,
     conf.int=TRUE,
     exponentiate=TRUE)

fitted(model10) %>% 
  length()

# Psuedo R2
DescTools::PseudoR2(model10, which = "McFadden")
DescTools::PseudoR2(model10, which = "McFaddenAdj")
DescTools::PseudoR2(model10, which = "Nagelkerke")
```

Plot 
```{r Self-harm extended model plot}
dat_plot <- dat %>%
  select("Age" = "age_category_COVID_baseline",
         "Gender" = "gender_cleaned",
         "Race" = "race_binary",
         "Pandemic_selfharm" = "NEW_selfharm_pandemic",
         "Education" = "highest_education",
         "Psych_disorder" = "psych_disorder_factor",
         "Employment" = "paid_employment_key_worker",
         "Vulnerable_group_member" ="vulnerable_group_member",
         "Pandemic_worry" = "panworry_total_score",
         "Covid_test" = "positive_covid_test_before_SH_final",
         "Loss" = "lost_someone_before_SH_final",
         "Increased_loneliness" = "increased_loneliness_during_pandemic",
         "Main_eco_act_change" = "main_eco_change_before_SH_final",
         "Living_sit_change" = "living_situation_change_before_SH_final"
         
        )

#1. Plot
explanatory <- c("Age",
                 "Gender",
                 "Race",
                 "Education",
                 "Psych_disorder",
                 "Employment",
                 "Vulnerable_group_member",
                 "Pandemic_worry",
                 "Covid_test",
                 "Loss",
                 "Increased_loneliness",
                 "Main_eco_act_change",
                 "Living_sit_change")

dependent <- "Pandemic_selfharm"

SH_extended_dat_plot <- dat_plot %>%
  finalfit::or_plot(dependent, explanatory, 
          breaks = c(0.5, 1, 5, 10, 20, 30),
          table_text_size = 3.0,
          title_text_size = 13,
          dependent_label = "Self-harm during pandemic",
          remove_ref = FALSE)
```

```{r Save SH extended level plot}
ggsave(
  paste0("SH_extended_dat_plot",
                    date,
                    ".png"),
  plot = SH_extended_dat_plot,
  device = "png", 
  path = "/Users/helenadavies/werk/EDBEHSELFHARM2/gitEDBEHSELFHARM/plots/extended", 
  scale = 1,
  width = 25,
  height = 20,
  units = "cm"
  )
```

# Save environment
Need this to run correlations with OR of other sensitivity analysis (i.e., exposure ONLY before outcome and not in same phase)
```{r save environment}
save.image(file='COVID_main_analysis_regressions.RData')
```

# Sensitivity analysis 
## At least 3 nos: Binge eating - extended model
```{r sens analysis 3 nos Binge eating extended model}
model11 <- glm(sens_NEW_binge_eating_pandemic ~  
                 age_category_COVID_baseline +
                 gender_cleaned +
                 race_binary +
                 highest_education +
                 psych_disorder_factor +
                 paid_employment_key_worker +
                 vulnerable_group_member +
                 panworry_total_score + 
                 positive_covid_test_before_BE_final +
                 lost_someone_before_BE_final +
                 increased_loneliness_during_pandemic +
                 main_eco_change_before_BE_final +
                 living_situation_change_before_BE_final,
                 data = dat,
                 family = "binomial"
              )

binge_eating_sens <- tidy(model11,
     conf.int=TRUE,
     exponentiate=TRUE)

fitted(model11) %>% 
  length()
```

Plot
```{r Binge eating extended model plot}
sens_dat_plot <- dat %>%
  select("Age" = "age_category_COVID_baseline",
         "Gender" = "gender_cleaned",
         "Race" = "race_binary",
         "Pandemic_binge_eating" = "sens_NEW_binge_eating_pandemic",
         "Education" = "highest_education",
         "Psych_disorder" = "psych_disorder_factor",
         "Employment" = "paid_employment_key_worker",
         "Vulnerable_group_member" ="vulnerable_group_member",
         "Pandemic_worry" = "panworry_total_score",
         "Covid_test" = "positive_covid_test_before_BE_final", 
         "Loss" = "lost_someone_before_BE_final", 
         "Increased_loneliness" = "increased_loneliness_during_pandemic",
         "Main_eco_act_change" = "main_eco_change_before_BE_final", 
         "Living_sit_change" = "living_situation_change_before_BE_final" 
        )


# 1. Plot
explanatory <- c("Age",
                 "Gender",
                 "Race",
                 "Education",
                 "Psych_disorder",
                 "Employment",
                 "Vulnerable_group_member",
                 "Pandemic_worry",
                 "Covid_test",
                 "Loss",
                 "Increased_loneliness",
                 "Main_eco_act_change",
                 "Living_sit_change"
               )

dependent <- "Pandemic_binge_eating"

sens_BE_extended_dat_plot <- sens_dat_plot %>%
  finalfit::or_plot(dependent,
                    explanatory, 
          breaks = c(0.5, 1, 5, 10, 20, 30),
          table_text_size = 3.0,
          title_text_size = 15,
          dependent_label = "Sens analysis: New experience of binge eating during pandemic",
          remove_ref = FALSE) 
```

```{r Save SH extended level plot}
ggsave(
  paste0("sens_BE_3_nos_extended_dat_plot",
                    date,
                    ".png"),
  plot = sens_BE_extended_dat_plot,
  device = "png", 
  path = "/Users/helenadavies/werk/EDBEHSELFHARM2/gitEDBEHSELFHARM/plots/sensitivity/Three_nos", 
  scale = 1,
  width = 25,
  height = 20,
  units = "cm"
  )
```

## At least 3 nos: low weight - extended model
```{r sens analysis 3 nos low weight extended model}
model12 <- glm(sens_NEW_low_weight_pandemic ~  
                 age_category_COVID_baseline +
                 gender_cleaned +
                 race_binary +
                 highest_education +
                 psych_disorder_factor +
                 paid_employment_key_worker +
                 vulnerable_group_member +
                 panworry_total_score + 
                 positive_covid_test_before_LW_final +
                 lost_someone_before_LW_final +
                 increased_loneliness_during_pandemic +
                 main_eco_change_before_LW_final +
                 living_situation_change_before_LW_final +
                 ocd.compulsive_beh_mental_act_binary +
                 ocd.repetitive_unpleasant_thoughts_binary,
                 data = dat,
                 family = "binomial"
              )


low_weight_sens <- tidy(model12,
     conf.int=TRUE,
     exponentiate=TRUE)

fitted(model12) %>% 
  length()
```

Plot
```{r low weight extended model plot}
sens_dat_plot <- dat %>%
  select("Age" = "age_category_COVID_baseline",
         "Gender" = "gender_cleaned",
         "Race" = "race_binary",
         "Pandemic_low_weight" = "sens_NEW_low_weight_pandemic",
         "Education" = "highest_education",
         "Psych_disorder" = "psych_disorder_factor",
         "Employment" = "paid_employment_key_worker",
         "Vulnerable_group_member" ="vulnerable_group_member",
         "Pandemic_worry" = "panworry_total_score",
         "Covid_test" = "positive_covid_test_before_LW_final", 
         "Loss" = "lost_someone_before_LW_final", 
         "Increased_loneliness" = "increased_loneliness_during_pandemic",
         "Main_eco_act_change" = "main_eco_change_before_LW_final", 
         "Living_sit_change" = "living_situation_change_before_LW_final",
         "Compulsive_beh_mental_act" = "ocd.compulsive_beh_mental_act_binary",
         "Repetitive_unpleasant_thoughts" = "ocd.repetitive_unpleasant_thoughts_binary"
        )


# 1. Plot
explanatory <- c("Age",
                 "Gender",
                 "Race",
                 "Education",
                 "Psych_disorder",
                 "Employment",
                 "Vulnerable_group_member",
                 "Pandemic_worry",
                 "Covid_test",
                 "Loss",
                 "Increased_loneliness",
                 "Main_eco_act_change",
                 "Living_sit_change",
                 "Compulsive_beh_mental_act",
                 "Repetitive_unpleasant_thoughts"
               )

dependent <- "Pandemic_low_weight"

sens_LW_extended_dat_plot <- sens_dat_plot %>%
  finalfit::or_plot(dependent,
                    explanatory, 
          breaks = c(0.5, 1, 5, 10, 20, 30),
          table_text_size = 3.0,
          title_text_size = 15,
          dependent_label = "Sens analysis: New experience of low weight during pandemic",
          remove_ref = FALSE) 
```

```{r Save LW extended level plot}
ggsave(
  paste0("sens_LW_3_nos_extended_dat_plot",
                    date,
                    ".png"),
  plot = sens_LW_extended_dat_plot,
  device = "png", 
  path = "/Users/helenadavies/werk/EDBEHSELFHARM2/gitEDBEHSELFHARM/plots/sensitivity/Three_nos", 
  scale = 1,
  width = 25,
  height = 20,
  units = "cm"
  )
```

## At least 3 nos: harmful ideation - extended model
```{r sens analysis 3 nos harmful ideation extended model}
model13 <- glm(sens_NEW_harmful_ideation_pandemic ~  
                 age_category_COVID_baseline +
                 gender_cleaned +
                 race_binary +
                 highest_education +
                 psych_disorder_factor +
                 paid_employment_key_worker +
                 vulnerable_group_member +
                 panworry_total_score + 
                 positive_covid_test_before_HI_final +
                 lost_someone_before_HI_final +
                 increased_loneliness_during_pandemic +
                 main_eco_change_before_HI_final +
                 living_situation_change_before_HI_final,
                 data = dat,
                 family = "binomial"
              )


harmful_ideation_sens <- tidy(model13,
     conf.int=TRUE,
     exponentiate=TRUE)

fitted(model13) %>% 
  length()
```

Plot
```{r harmful ideation extended model plot}
sens_dat_plot <- dat %>%
  select("Age" = "age_category_COVID_baseline",
         "Gender" = "gender_cleaned",
         "Race" = "race_binary",
         "Pandemic_harmful_ideation" = "sens_NEW_harmful_ideation_pandemic",
         "Education" = "highest_education",
         "Psych_disorder" = "psych_disorder_factor",
         "Employment" = "paid_employment_key_worker",
         "Vulnerable_group_member" ="vulnerable_group_member",
         "Pandemic_worry" = "panworry_total_score",
         "Covid_test" = "positive_covid_test_before_HI_final", 
         "Loss" = "lost_someone_before_HI_final", 
         "Increased_loneliness" = "increased_loneliness_during_pandemic",
         "Main_eco_act_change" = "main_eco_change_before_HI_final", 
         "Living_sit_change" = "living_situation_change_before_HI_final"
        )


# 1. Plot
explanatory <- c("Age",
                 "Gender",
                 "Race",
                 "Education",
                 "Psych_disorder",
                 "Employment",
                 "Vulnerable_group_member",
                 "Pandemic_worry",
                 "Covid_test",
                 "Loss",
                 "Increased_loneliness",
                 "Main_eco_act_change",
                 "Living_sit_change"
               )

dependent <- "Pandemic_harmful_ideation"

sens_HI_extended_dat_plot <- sens_dat_plot %>%
  finalfit::or_plot(dependent,
                    explanatory, 
          breaks = c(0.5, 1, 5, 10, 20, 30),
          table_text_size = 3.0,
          title_text_size = 15,
          dependent_label = "Sens analysis: New experience of harmful ideation during pandemic",
          remove_ref = FALSE) 
```

```{r Save HI extended level plot}
ggsave(
  paste0("sens_HI_3_nos_extended_dat_plot",
                    date,
                    ".png"),
  plot = sens_HI_extended_dat_plot,
  device = "png", 
  path = "/Users/helenadavies/werk/EDBEHSELFHARM2/gitEDBEHSELFHARM/plots/sensitivity/Three_nos", 
  scale = 1,
  width = 25,
  height = 20,
  units = "cm"
  )
```

## At least 3 nos: self-harm  - extended model
```{r sens analysis 3 nos self-harm  extended model}
model15 <- glm(sens_NEW_selfharm_pandemic ~  
                 age_category_COVID_baseline +
                 gender_cleaned +
                 race_binary +
                 highest_education +
                 psych_disorder_factor +
                 paid_employment_key_worker +
                 vulnerable_group_member +
                 panworry_total_score + 
                 positive_covid_test_before_SH_final +
                 lost_someone_before_SH_final +
                 increased_loneliness_during_pandemic +
                 main_eco_change_before_SH_final +
                 living_situation_change_before_SH_final,
                 data = dat,
                 family = "binomial"
              )

selfharm_sens <- tidy(model15,
     conf.int=TRUE,
     exponentiate=TRUE)

fitted(model15) %>% 
  length()
```

Plot
```{r self-harm extended model plot}
sens_dat_plot <- dat %>%
  select("Age" = "age_category_COVID_baseline",
         "Gender" = "gender_cleaned",
         "Race" = "race_binary",
         "Pandemic_selfharm" = "sens_NEW_selfharm_pandemic",
         "Education" = "highest_education",
         "Psych_disorder" = "psych_disorder_factor",
         "Employment" = "paid_employment_key_worker",
         "Vulnerable_group_member" ="vulnerable_group_member",
         "Pandemic_worry" = "panworry_total_score",
         "Covid_test" = "positive_covid_test_before_SH_final", 
         "Loss" = "lost_someone_before_SH_final", 
         "Increased_loneliness" = "increased_loneliness_during_pandemic",
         "Main_eco_act_change" = "main_eco_change_before_SH_final", 
         "Living_sit_change" = "living_situation_change_before_SH_final"
        )


# 1. Plot
explanatory <- c("Age",
                 "Gender",
                 "Race",
                 "Education",
                 "Psych_disorder",
                 "Employment",
                 "Vulnerable_group_member",
                 "Pandemic_worry",
                 "Covid_test",
                 "Loss",
                 "Increased_loneliness",
                 "Main_eco_act_change",
                 "Living_sit_change"
               )

dependent <- "Pandemic_selfharm"

sens_SH_extended_dat_plot <- sens_dat_plot %>%
  finalfit::or_plot(dependent,
                    explanatory, 
          breaks = c(0.5, 1, 5, 10, 20, 30),
          table_text_size = 3.0,
          title_text_size = 15,
          dependent_label = "Sens analysis: New experience of self-harm during pandemic",
          remove_ref = FALSE) 
```

```{r Save SH extended level plot}
ggsave(
  paste0("sens_SH_3_nos_extended_dat_plot",
                    date,
                    ".png"),
  plot = sens_SH_extended_dat_plot,
  device = "png", 
  path = "/Users/helenadavies/werk/EDBEHSELFHARM2/gitEDBEHSELFHARM/plots/sensitivity/Three_nos", 
  scale = 1,
  width = 25,
  height = 20,
  units = "cm"
  )
```

# Calculate correlation between effect sizes of main and sensitivity analysis (3 no's)
## Low weight
```{r Calculate correlation between effect sizes low weight}
# Extract columns from model - sens analysis
low_weight_sens_extracted <- low_weight_sens %>%
  select(term,
         estimate,
         conf.high,
         conf.low) %>%
  rename(estimate_sens = estimate,
         conf.high_sens = conf.high,
         conf.low_sens = conf.low,
         Exposure = term)

# Check
low_weight_sens_extracted

# Extract columns from model - main analysis
low_weight_extracted <- low_weight_main %>%
  select(term,
         estimate,
         conf.high,
         conf.low) %>%
  rename(estimate_main = estimate,
         conf.high_main = conf.high,
         conf.low_main = conf.low,
         Exposure = term)

# Check
low_weight_extracted

# Join
low_weight_joined <- merge(x = low_weight_sens_extracted,
                         y = low_weight_extracted,
                         by = "Exposure")


# Check
low_weight_joined

# Summarise ORs
summary(low_weight_joined$estimate_main)
summary(low_weight_joined$estimate_sens)

# Correlation
low_weight_cor <- psych::corr.test(low_weight_joined$estimate_main,
          low_weight_joined$estimate_sens,
          ci = TRUE)

low_weight_cor$r

print(low_weight_cor,
      short=F)
```

```{r plot OR correlation low weight}
# Delete intercept row
low_weight_joined <- low_weight_joined[-1, ]

# Rename exposures for plotting
low_weight_joined[1,1] <- "16-25 years (vs. 56-65 years)"
low_weight_joined[2,1] <- "26-35 years (vs. 56-65 years)"
low_weight_joined[3,1] <- "36-45 years (vs. 56-65 years)"
low_weight_joined[4,1] <- "46-55 years (vs. 56-65 years)"
low_weight_joined[5,1] <- "66-70 years (vs. 56-65 years)"
low_weight_joined[6,1] <- "71+ years (vs. 56-65 years)"
low_weight_joined[7,1] <- "Minoritised gender (vs. man)"
low_weight_joined[8,1] <- "Woman (vs. man)"
low_weight_joined[9,1] <- "Highest education: A-levels (vs. no formal education)"
low_weight_joined[10,1] <- "Highest education: GCSE/CSE (vs. no formal education)"
low_weight_joined[11,1] <- "Highest education: NVQ (vs. no formal education)"
low_weight_joined[12,1] <- "Highest education: Uni/Other professional quals (vs. no formal education)"
low_weight_joined[13,1] <- "Higher loneliness score during pandemic (vs. not)"
low_weight_joined[14,1] <- "Change in living situation during pandemic (vs. not)"
low_weight_joined[15,1] <- "Lost someone due to COVID (vs. not)"
low_weight_joined[16,1] <- "Change in main eco activity during pandemic (vs. not)"
low_weight_joined[17,1] <- "Compulsive behaviour/mental act (vs. not)"
low_weight_joined[18,1] <- "Repetitive unpleasant thoughts (vs. not)"
low_weight_joined[19,1] <- "Not in paid employment (vs. key worker)"
low_weight_joined[20,1] <- "In paid employment (vs. key worker)"
low_weight_joined[21,1] <- "Retired (vs. key worker)"
low_weight_joined[22,1] <- "Student (vs. key worker)"
low_weight_joined[23,1] <- "Pandemic worry total score"
low_weight_joined[24,1] <- "Positive COVID test (vs. not)"
low_weight_joined[25,1] <- "Psychiatric disorder (vs. not)"
low_weight_joined[26,1] <- "Racially minoritised (vs. white)"
low_weight_joined[27,1] <- "Vulnerable group member (vs. not)"

cor_ORs_low_weight_3nos <- ggplot(data = low_weight_joined,
       mapping = aes(
         x = estimate_sens,
         y = estimate_main,
         colour = Exposure
         )) +
  ggplot2::labs(
    y = "OR main analysis",
    x = "OR sensitivity analysis: Three no's",
    title = "Correlation of Odds Ratio in low weight regression models") +
  geom_point() +
  geom_hline(yintercept = 1) +
  geom_vline(xintercept = 1) +
  theme_minimal() +
  # Add perfect correlation line
  geom_abline(intercept = 0,
              slope = 1,
              color="black", 
              size=0.5) 
  
cor_ORs_low_weight_3nos<- cor_ORs_low_weight_3nos + 
  coord_cartesian(
  xlim = c(0.3, 3.8),
  ylim = c(0.3, 3.8),
  expand = TRUE,
  default = FALSE,
  clip = "on"
) +
  # Add error bars (both main and sens)
  geom_errorbar(aes(ymin = conf.low_sens, ymax = conf.high_sens)) +
  geom_errorbarh(aes(xmin = conf.low_main, xmax = conf.high_main)) 


# Save
ggsave(
  paste0("cor_ORs_low_weight_3nos",
                    date,
                    ".jpeg"),
  plot = cor_ORs_low_weight_3nos,
  device = "jpeg", 
  path = "/Users/helenadavies/werk/EDBEHselfharm2/gitEDBEHselfharm/plots/sensitivity/Three_nos/", 
  scale = 1,
  width = 50,
  height = 20,
  units = "cm"
  )

```

## Binge eating
```{r Calculate correlation between effect sizes Binge eating}
# Extract columns from model - sens analysis
binge_eating_sens_extracted <- binge_eating_sens %>%
  select(term,
         estimate,
         conf.high,
         conf.low) %>%
  rename(estimate_sens = estimate,
         conf.high_sens = conf.high,
         conf.low_sens = conf.low,
         Exposure = term)

# Check
binge_eating_sens_extracted

# Extract columns from model - main analysis
binge_eating_extracted <- binge_eating_main %>%
  select(term,
         estimate,
         conf.high,
         conf.low) %>%
  rename(estimate_main = estimate,
         conf.high_main = conf.high,
         conf.low_main = conf.low,
         Exposure = term)

# Check
binge_eating_extracted

# Join
binge_eating_joined <- merge(x = binge_eating_sens_extracted,
                         y = binge_eating_extracted,
                         by = "Exposure")


# Check
binge_eating_joined

# Summarise ORs
summary(binge_eating_joined$estimate_main)
summary(binge_eating_joined$estimate_sens)

# Correlation
binge_eating_cor <- psych::corr.test(binge_eating_joined$estimate_main,
          binge_eating_joined$estimate_sens,
          ci = TRUE)

binge_eating_cor$r

print(binge_eating_cor,
      short=F)
```

```{r plot OR correlation Binge eating}
# Delete intercept row
binge_eating_joined <- binge_eating_joined[-1, ]

# Rename exposures for plotting
binge_eating_joined[1,1] <- "16-25 years (vs. 56-65 years)"
binge_eating_joined[2,1] <- "26-35 years (vs. 56-65 years)"
binge_eating_joined[3,1] <- "36-45 years (vs. 56-65 years)"
binge_eating_joined[4,1] <- "46-55 years (vs. 56-65 years)"
binge_eating_joined[5,1] <- "66-70 years (vs. 56-65 years)"
binge_eating_joined[6,1] <- "71+ years (vs. 56-65 years)"
binge_eating_joined[7,1] <- "Minoritised gender (vs. man)"
binge_eating_joined[8,1] <- "Woman (vs. man)"
binge_eating_joined[9,1] <- "Highest education: A-levels (vs. no formal education)"
binge_eating_joined[10,1] <- "Highest education: GCSE/CSE (vs. no formal education)"
binge_eating_joined[11,1] <- "Highest education: NVQ (vs. no formal education)"
binge_eating_joined[12,1] <- "Highest education: Uni/Other professional quals (vs. no formal education)"
binge_eating_joined[13,1] <- "Higher loneliness score during pandemic (vs. not)"
binge_eating_joined[14,1] <- "Change in living situation during pandemic (vs. not)"
binge_eating_joined[15,1] <- "Lost someone due to COVID (vs. not)"
binge_eating_joined[16,1] <- "Change in main eco activity during pandemic (vs. not)"
binge_eating_joined[17,1] <- "Not in paid employment (vs. key worker)"
binge_eating_joined[18,1] <- "In paid employment (vs. key worker)"
binge_eating_joined[19,1] <- "Retired (vs. key worker)"
binge_eating_joined[20,1] <- "Student (vs. key worker)"
binge_eating_joined[21,1] <- "Pandemic worry total score"
binge_eating_joined[22,1] <- "Positive COVID test (vs. not)"
binge_eating_joined[23,1] <- "Psychiatric disorder (vs. not)"
binge_eating_joined[24,1] <- "Racially minoritised (vs. white)"
binge_eating_joined[25,1] <- "Vulnerable group member (vs. not)"

cor_ORs_binge_eating_3nos <- ggplot(data = binge_eating_joined,
       mapping = aes(
         x = estimate_sens,
         y = estimate_main,
         colour = Exposure
         )) +
  ggplot2::labs(
    y = "OR main analysis",
    x = "OR sensitivity analysis: Three no's",
    title = "Correlation of Odds Ratio in binge eating regression models") +
  geom_point() +
  geom_hline(yintercept = 1) +
  geom_vline(xintercept = 1) +
  theme_minimal() +
  # Add perfect correlation line
  geom_abline(intercept = 0,
              slope = 1,
              color="black", 
              size=0.5) 
  
cor_ORs_binge_eating_3nos <- cor_ORs_binge_eating_3nos + 
  coord_cartesian(
  xlim = c(0.2, 2.1),
  ylim = c(0.2, 2.1),
  expand = TRUE,
  default = FALSE,
  clip = "on"
) +
  # Add error bars (both main and sens)
  geom_errorbar(aes(ymin = conf.low_sens, ymax = conf.high_sens)) +
  geom_errorbarh(aes(xmin = conf.low_main, xmax = conf.high_main)) 

# Save
ggsave(
  paste0("cor_ORs_binge_eating_3nos",
                    date,
                    ".jpeg"),
  plot = cor_ORs_binge_eating_3nos,
  device = "jpeg", 
  path = "/Users/helenadavies/werk/EDBEHselfharm2/gitEDBEHselfharm/plots/sensitivity/Three_nos/", 
  scale = 1,
  width = 50,
  height = 20,
  units = "cm"
  )
```

## Harmful ideation
```{r Calculate correlation between effect sizes harmful ideation}
# Extract columns from model - sens analysis
harmful_ideation_sens_extracted <- harmful_ideation_sens %>%
  select(term,
         estimate,
         conf.high,
         conf.low) %>%
  rename(estimate_sens = estimate,
         conf.high_sens = conf.high,
         conf.low_sens = conf.low,
         Exposure = term)

# Check
harmful_ideation_sens_extracted

# Extract columns from model - main analysis
harmful_ideation_extracted <- harmful_ideation_main %>%
  select(term,
         estimate,
         conf.high,
         conf.low) %>%
  rename(estimate_main = estimate,
         conf.high_main = conf.high,
         conf.low_main = conf.low,
         Exposure = term)

# Check
harmful_ideation_extracted

# Join
harmful_ideation_joined <- merge(x = harmful_ideation_sens_extracted,
                         y = harmful_ideation_extracted,
                         by = "Exposure")


# Check
harmful_ideation_joined

# Summarise ORs
summary(harmful_ideation_joined$estimate_main)
summary(harmful_ideation_joined$estimate_sens)

# Correlation
harmful_ideation_cor <- psych::corr.test(harmful_ideation_joined$estimate_main,
          harmful_ideation_joined$estimate_sens,
          ci = TRUE)

harmful_ideation_cor$r

print(harmful_ideation_cor,
      short=F)
```

```{r plot OR correlation harmful ideation}
# Delete intercept row
harmful_ideation_joined <- harmful_ideation_joined[-1, ]

# Rename exposures for plotting
harmful_ideation_joined[1,1] <- "16-25 years (vs. 56-65 years)"
harmful_ideation_joined[2,1] <- "26-35 years (vs. 56-65 years)"
harmful_ideation_joined[3,1] <- "36-45 years (vs. 56-65 years)"
harmful_ideation_joined[4,1] <- "46-55 years (vs. 56-65 years)"
harmful_ideation_joined[5,1] <- "66-70 years (vs. 56-65 years)"
harmful_ideation_joined[6,1] <- "71+ years (vs. 56-65 years)"
harmful_ideation_joined[7,1] <- "Minoritised gender (vs. man)"
harmful_ideation_joined[8,1] <- "Woman (vs. man)"
harmful_ideation_joined[9,1] <- "Highest education: A-levels (vs. no formal education)"
harmful_ideation_joined[10,1] <- "Highest education: GCSE/CSE (vs. no formal education)"
harmful_ideation_joined[11,1] <- "Highest education: NVQ (vs. no formal education)"
harmful_ideation_joined[12,1] <- "Highest education: Uni/Other professional quals (vs. no formal education)"
harmful_ideation_joined[13,1] <- "Higher loneliness score during pandemic (vs. not)"
harmful_ideation_joined[14,1] <- "Change in living situation during pandemic (vs. not)"
harmful_ideation_joined[15,1] <- "Lost someone due to COVID (vs. not)"
harmful_ideation_joined[16,1] <- "Change in main eco activity during pandemic (vs. not)"
harmful_ideation_joined[17,1] <- "Not in paid employment (vs. key worker)"
harmful_ideation_joined[18,1] <- "In paid employment (vs. key worker)"
harmful_ideation_joined[19,1] <- "Retired (vs. key worker)"
harmful_ideation_joined[20,1] <- "Student (vs. key worker)"
harmful_ideation_joined[21,1] <- "Pandemic worry total score"
harmful_ideation_joined[22,1] <- "Positive COVID test (vs. not)"
harmful_ideation_joined[23,1] <- "Psychiatric disorder (vs. not)"
harmful_ideation_joined[24,1] <- "Racially minoritised (vs. white)"
harmful_ideation_joined[25,1] <- "Vulnerable group member (vs. not)"

cor_ORs_harmful_ideation_3nos <- ggplot(data = harmful_ideation_joined,
       mapping = aes(
         x = estimate_sens,
         y = estimate_main,
         colour = Exposure
         )) +
  ggplot2::labs(
    y = "OR main analysis",
    x = "OR sensitivity analysis: Three no's",
    title = "Correlation of Odds Ratio in harmful ideation regression models") +
  geom_point() +
  geom_hline(yintercept = 1) +
  geom_vline(xintercept = 1) +
  theme_minimal() +
  # Add perfect correlation line
  geom_abline(intercept = 0,
              slope = 1,
              color="black", 
              size=0.5) 
  
cor_ORs_harmful_ideation_3nos <- cor_ORs_harmful_ideation_3nos + 
  coord_cartesian(
  xlim = c(0.4, 21.1), 
  ylim = c(0.4, 21.1),
  expand = TRUE,
  default = FALSE,
  clip = "on"
) +
  # Add error bars (both main and sens)
  geom_errorbar(aes(ymin = conf.low_sens, ymax = conf.high_sens)) +
  geom_errorbarh(aes(xmin = conf.low_main, xmax = conf.high_main)) 


# Save
ggsave(
  paste0("cor_ORs_harmful_ideation_3nos",
                    date,
                    ".jpeg"),
  plot = cor_ORs_harmful_ideation_3nos,
  device = "jpeg", 
  path = "/Users/helenadavies/werk/EDBEHselfharm2/gitEDBEHselfharm/plots/sensitivity/Three_nos/", 
  scale = 1,
  width = 50,
  height = 20,
  units = "cm"
  )
```

## Self-harm
```{r Calculate correlation between effect sizes self-harm}
# Extract columns from model - sens analysis
selfharm_sens_extracted <- selfharm_sens %>%
  select(term,
         estimate,
         conf.high,
         conf.low) %>%
  rename(estimate_sens = estimate,
         conf.high_sens = conf.high,
         conf.low_sens = conf.low,
         Exposure = term)

# Check
selfharm_sens_extracted

# Extract columns from model - main analysis
selfharm_extracted <- selfharm_main %>%
  select(term,
         estimate,
         conf.high,
         conf.low) %>%
  rename(estimate_main = estimate,
         conf.high_main = conf.high,
         conf.low_main = conf.low,
         Exposure = term)

# Check
selfharm_extracted

# Join
selfharm_joined <- merge(x = selfharm_sens_extracted,
                         y = selfharm_extracted,
                         by = "Exposure")


# Check
selfharm_joined

# Summarise ORs
summary(selfharm_joined$estimate_main)
summary(selfharm_joined$estimate_sens)

# Correlation
selfharm_cor <- psych::corr.test(selfharm_joined$estimate_main,
          selfharm_joined$estimate_sens,
          ci = TRUE)

selfharm_cor$r

print(selfharm_cor,
      short=F)
```

```{r plot OR correlation self-harm}
# Delete intercept row
selfharm_joined <- selfharm_joined[-1, ]

# Rename exposures for plotting
selfharm_joined[1,1] <- "16-25 years (vs. 56-65 years)"
selfharm_joined[2,1] <- "26-35 years (vs. 56-65 years)"
selfharm_joined[3,1] <- "36-45 years (vs. 56-65 years)"
selfharm_joined[4,1] <- "46-55 years (vs. 56-65 years)"
selfharm_joined[5,1] <- "66-70 years (vs. 56-65 years)"
selfharm_joined[6,1] <- "71+ years (vs. 56-65 years)"
selfharm_joined[7,1] <- "Minoritised gender (vs. man)"
selfharm_joined[8,1] <- "Woman (vs. man)"
selfharm_joined[9,1] <- "Highest education: A-levels (vs. no formal education)"
selfharm_joined[10,1] <- "Highest education: GCSE/CSE (vs. no formal education)"
selfharm_joined[11,1] <- "Highest education: NVQ (vs. no formal education)"
selfharm_joined[12,1] <- "Highest education: Uni/Other professional quals (vs. no formal education)"
selfharm_joined[13,1] <- "Higher loneliness score during pandemic (vs. not)"
selfharm_joined[14,1] <- "Change in living situation during pandemic (vs. not)"
selfharm_joined[15,1] <- "Lost someone due to COVID (vs. not)"
selfharm_joined[16,1] <- "Change in main eco activity during pandemic (vs. not)"
selfharm_joined[17,1] <- "Not in paid employment (vs. key worker)"
selfharm_joined[18,1] <- "In paid employment (vs. key worker)"
selfharm_joined[19,1] <- "Retired (vs. key worker)"
selfharm_joined[20,1] <- "Student (vs. key worker)"
selfharm_joined[21,1] <- "Pandemic worry total score"
selfharm_joined[22,1] <- "Positive COVID test (vs. not)"
selfharm_joined[23,1] <- "Psychiatric disorder (vs. not)"
selfharm_joined[24,1] <- "Racially minoritised (vs. white)"
selfharm_joined[25,1] <- "Vulnerable group member (vs. not)"

cor_ORs_selfharm_3nos <- ggplot(data = selfharm_joined,
       mapping = aes(
         x = estimate_sens,
         y = estimate_main,
         colour = Exposure
         )) +
  ggplot2::labs(
    y = "OR main analysis",
    x = "OR sensitivity analysis: Three no's",
    title = "Correlation of Odds Ratio in self-harm regression models") +
  geom_point() +
  geom_hline(yintercept = 1) +
  geom_vline(xintercept = 1) +
  theme_minimal() +
  # Add perfect correlation line
  geom_abline(intercept = 0,
              slope = 1,
              color="black", 
              size=0.5) 
  
cor_ORs_selfharm_3nos <- cor_ORs_selfharm_3nos + 
  coord_cartesian(
  xlim = c(0.4, 12.5),
  ylim = c(0.4, 12.5),
  expand = TRUE,
  default = FALSE,
  clip = "on"
  ) +
  # Add error bars (both main and sens)
  geom_errorbar(aes(ymin = conf.low_sens, ymax = conf.high_sens)) +
  geom_errorbarh(aes(xmin = conf.low_main, xmax = conf.high_main))  

# Save
ggsave(
  paste0("cor_ORs_selfharm_3nos",
                    date,
                    ".jpeg"),
  plot = cor_ORs_selfharm_3nos,
  device = "jpeg", 
  path = "/Users/helenadavies/werk/EDBEHSELFHARM2/gitEDBEHSELFHARM/plots/sensitivity/Three_nos/", 
  scale = 1,
  width = 50,
  height = 20,
  units = "cm"
  )
```
