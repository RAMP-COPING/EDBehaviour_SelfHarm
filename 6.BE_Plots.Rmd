---
title: "Plots"
author: "Helena Davies"
date: "17/05/2021"
output: html_document
---

```{r Setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      comment=NA,
                      prompt=FALSE,
                      cache=FALSE)
```

Delete everything in your global environment
```{r Delete everything in your global environment}
remove(list = ls())
```

#### Call in library script

```{r source files}
source("./libraries.R")
```

#### Call in functions script

```{r source files}
source("./functions.R")
```

#Retrieve the recent date
```{r Recent date}
date = Sys.Date()
date
```

# Read in data
```{r}
dat <- readRDS(file = "../data_cleaned/data.final.with.ED.groups2021-05-12.rds")
dim(dat)
colnames(dat)

#Drop one dup cohort name columns
dat$cohort_name.y <- NULL

dat <- dat %>% 
  rename(
    cohort_name = cohort_name.x
    )

```


##NEW experience of binge; phases
```{r}

dat <- dat %>%
  mutate(new_binge_eating_each_wave =
           case_when(lifetime_binge_eating_baseline_numeric == 0 &
                     ed_scid5.regular_episodes_eating_binges_.Wave_1b == "Yes" ~ 1,
                     
                     lifetime_binge_eating_baseline_numeric == 0 &
                     ed_scid5.regular_episodes_eating_binges_.Wave_2b == "Yes" ~ 2,
                     
                     lifetime_binge_eating_baseline_numeric == 0 &
                     ed_scid5.regular_episodes_eating_binges_.Wave_3b == "Yes" ~ 3,
                     
                     lifetime_binge_eating_baseline_numeric == 0 &
                     ed_scid5.regular_episodes_eating_binges_.Wave_4b == "Yes" ~ 4,
                     
                     lifetime_binge_eating_baseline_numeric == 0 &
                     ed_scid5.regular_episodes_eating_binges_.Wave_6b == "Yes" ~ 5,
                     
                     lifetime_binge_eating_baseline_numeric == 0 &
                     ed_scid5.regular_episodes_eating_binges_.Wave_8b == "Yes" ~ 6,
                     
                     lifetime_binge_eating_baseline_numeric == 0 &
                     ed_scid5.regular_episodes_eating_binges_.Wave_10b == "Yes" ~ 7,
                     
                     lifetime_binge_eating_baseline_numeric == 0 &
                     ed_scid5.regular_episodes_eating_binges_.Wave_12b == "Yes" ~ 8
                     )
                     )
                     
                     
                   
        
#Check
dat %>%
  freq(new_binge_eating_each_wave)

#Convert to individual variables
dat <- dat %>%
  mutate(ed.screener_new_binge_eating_phase_1b =
           case_when(new_binge_eating_each_wave == 1 ~ 1
                     )
         )
  

dat <- dat %>%
  mutate(ed.screener_new_binge_eating_phase_2b =
           case_when(new_binge_eating_each_wave == 2 ~ 1
                     )
         )
  
dat <- dat %>%
  mutate(ed.screener_new_binge_eating_phase_3b =
           case_when(new_binge_eating_each_wave == 3 ~ 1
                     )
         )
  
dat <- dat %>%
  mutate(ed.screener_new_binge_eating_phase_4b =
           case_when(new_binge_eating_each_wave == 4 ~ 1
                     )
         )
  
dat <- dat %>%
  mutate(ed.screener_new_binge_eating_phase_6b =
           case_when(new_binge_eating_each_wave == 5 ~ 1
                     )
         )
  
dat <- dat %>%
  mutate(ed.screener_new_binge_eating_phase_8b =
           case_when(new_binge_eating_each_wave == 6 ~ 1
                     )
         )
  
dat <- dat %>%
  mutate(ed.screener_new_binge_eating_phase_10b =
           case_when(new_binge_eating_each_wave == 7 ~ 1
                     )
         )
  

dat <- dat %>%
  mutate(ed.screener_new_binge_eating_phase_12b =
           case_when(new_binge_eating_each_wave == 8 ~ 1
                     )
         )


dat

```

## Restructure data into long 
```{r }

dat <- dat %>%
  pivot_longer(
    cols = (starts_with("ed.screener_")) &
      contains("phase"),
    names_to = "phase_new_binge_eating",
    values_to = "value") %>%
  separate(phase_new_binge_eating, into = c("new_binge_eating", "phase_"), sep = "_phase_", remove = TRUE) %>%
  pivot_wider(
     names_from = "new_binge_eating",
     values_from = "value")


```

#Check number of people who answered screener at each wave
```{r}

#Phase 1b
phase1b <- dat %>%
  filter(!is.na(ed_scid5.regular_episodes_eating_binges_.Wave_1b)
         )
  
phase1b$ID.dup <- duplicated(phase1b$ID)

phase1b <- phase1b %>%
 filter(ID.dup == FALSE)

nrow(phase1b)

#Phase 2b
phase2b <- dat %>%
  filter(!is.na(ed_scid5.regular_episodes_eating_binges_.Wave_2b)
         )

phase2b$ID.dup <- duplicated(phase2b$ID)

phase2b <- phase2b %>%
 filter(ID.dup == FALSE)

nrow(phase2b)

#Phase 3b
phase3b <- dat %>%
  filter(!is.na(ed_scid5.regular_episodes_eating_binges_.Wave_3b)
         )

phase3b$ID.dup <- duplicated(phase3b$ID)

phase3b <- phase3b %>%
 filter(ID.dup == FALSE)

nrow(phase3b)

#Phase 4b
phase4b <- dat %>%
  filter(!is.na(ed_scid5.regular_episodes_eating_binges_.Wave_4b)
         )

phase4b$ID.dup <- duplicated(phase4b$ID)

phase4b <- phase4b %>%
 filter(ID.dup == FALSE)

nrow(phase4b)

#Phase 6b
phase6b <- dat %>%
  filter(!is.na(ed_scid5.regular_episodes_eating_binges_.Wave_6b)
         )

phase6b$ID.dup <- duplicated(phase6b$ID)

phase6b <- phase6b %>%
 filter(ID.dup == FALSE)

nrow(phase6b)

#Phase 8b
phase8b <- dat %>%
  filter(!is.na(ed_scid5.regular_episodes_eating_binges_.Wave_8b)
         )

phase8b$ID.dup <- duplicated(phase8b$ID)

phase8b <- phase8b %>%
 filter(ID.dup == FALSE)

nrow(phase8b)

#Phase 10b
phase10b <- dat %>%
  filter(!is.na(ed_scid5.regular_episodes_eating_binges_.Wave_10b)
         )

phase10b$ID.dup <- duplicated(phase10b$ID)

phase10b <- phase10b %>%
 filter(ID.dup == FALSE)

nrow(phase10b)

#Phase 12b
phase12b <- dat %>%
  filter(!is.na(ed_scid5.regular_episodes_eating_binges_.Wave_12b)
         )

phase12b$ID.dup <- duplicated(phase12b$ID)

phase12b <- phase12b %>%
 filter(ID.dup == FALSE)

nrow(phase12b)
```





##PLOTS - New experiences of binge eating

#Over the past month, have you had regular episodes of overeating or eating binges when you ate what most people would regard as an unusually large amount of food in a short period of time ?

#1. Get rid of NAs and change edeq to factor
```{r}
#get rid of nas
dat.no.nas <- dat[!is.na(dat$ed.screener_new_binge_eating),]

```

#1. Change wave to factor and re-order
```{r}

# change order of wave factor 1
dat.no.nas <- dat.no.nas %>%
 mutate(phase = fct_relevel(phase_,
                                  "1b",
                                  "2b",
                                  "3b",
                           "4b",
                           "6b",
                           "8b",
                           "10b",
                           "12b"))


#Check that this worked

summary(dat.no.nas$phase)
```

#4. Rename waves to dates
```{r}

##Rename waves

levels(dat.no.nas$phase)[1] <- "5th May - 19th May 2020"

levels(dat.no.nas$phase)[2] <- "2nd June - 16th June 2020" 

levels(dat.no.nas$phase)[3] <- "30th June - 14th July 2020"

levels(dat.no.nas$phase)[4] <- "28th July - 25th August 2020"

levels(dat.no.nas$phase)[5] <- "22nd Sept - 20th Oct 2020"

levels(dat.no.nas$phase)[6] <- "17th Nov - 15th Dec 2020"

levels(dat.no.nas$phase)[7] <- "12th Jan - 9th Feb 2021"

levels(dat.no.nas$phase)[8] <- "9th March - 6th April 2021"


```

#Count number of new experiences per phase
```{r}

dat.no.nas %>%
  group_by(phase) %>%
  count(phase)


```



#5. Format data to plot
```{r}
#get data in format to plot
dat_plot <- dat.no.nas %>%
  group_by(phase) %>%
  dplyr::summarise(wcount = table(ed_scid5.regular_episodes_eating_binges) / sum(table(ed_scid5.regular_episodes_eating_binges))) %>%
  ungroup() %>%
  mutate(ed_scid5.regular_episodes_eating_binges = rep(levels(dat.no.nas[["ed_scid5.regular_episodes_eating_binges"]]),
                    length(levels(dat.no.nas[["phase"]]))))



```

#6. Change variable to ordered factor
```{r}
dat_plot <- dat_plot %>%
  mutate(ed.screener_new_binge_eating = fct_relevel(ed.screener_new_binge_eating,
                           "No",
                           "Yes"))



freq(dat_plot$ed.screener_new_binge_eating)
```


7. PLOT ! Over the past month, have you had regular episodes of overeating or eating binges when you ate what most people would regard as an unusually large amount of food in a short period of time
```{r}

ggplot(dat_plot,
       aes(x = ed.screener_new_binge_eating,
           y = wcount,
           fill = phase)) +
  geom_bar(aes(group = phase),
           stat = "identity",
           position = "dodge",
           colour = "black") + 
  scale_y_continuous(labels = scales::percent) +
  labs(title = str_wrap("Over the past month, have you had regular episodes of overeating or eating binges when you ate what most people would regard as an unusually large amount of food in a short period of time?", 60),
       x = "New experience of binge eating",
       y = "Percentage of participants",
       fill = "Time of survey") +
scale_x_discrete(guide = guide_axis(n.dodge=3))

```

