---
title: "Correlations"
author: "Helena Davies"
date: "26/11/2021"
output: html_document
---

Configure global options for all chunks
```{r Setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  comment = '',
  prompt = FALSE,
  cache = FALSE
  )
```

Clear global environment prior to initiation
```{r Clear global environment}
remove(list = ls())
```

Add the add_numeric function - used to convert character variables into numeric variables
Add the remove_duplicates function - used to deduplicate and remove NAs from IDs
Add the sumscores function - used to generate sumscores
Add the package_check function - used to install and load dependencies
Add the imp_check function - used to check variables for implausible values
```{r Read in functions}
source(file = "/Users/helenadavies/werk/ilovedata/scripts/functions/add_numeric.R")
source(file = "/Users/helenadavies/werk/ilovedata/scripts/functions/remove_duplicates.R")
source(file = "/Users/helenadavies/werk/ilovedata/scripts/functions/package_check.R")
source("./functions.R")
```

Use package_check to install and load dependencies
Load tidyverse last
```{r Install load dependencies}
packages <- c("summarytools", "sjlabelled", "Amelia", "gtsummary", "tidyverse")
package_check(packages)
```

Retrieve recent date
We are using the recent date to save files with paste0() as an extension to not overwrite old versions
```{r Recent date}
date <- Sys.Date()
date
```

# Read in data
```{r Read in data}
dat <- readRDS(file = "../data_cleaned/final_dat_merged_2022-02-21.rds")
dim(dat)
   colnames(dat)
```

# CORRELATION MATRICES of outcome variables
## Binge eating
```{r binge eating correlation matrix}
# Select items for correlation matrix
outcome_corr <- dat %>%
  select(
   "NEW_binge_eating_pandemic",
   "NEW_low_weight_pandemic",
   "NEW_harmful_ideation_pandemic",
   "NEW_selfharm_pandemic"
 ) 

# Run correlation analyses with continious and dichotomous variables 
outcome_corr_object <- psych::mixedCor(data=outcome_corr,
         c= NULL,  # Continuous variables
         p= NULL,
         d= 1:4, # Dichotomous variable
             use="pairwise.complete.obs")


# Save correlation matrix in an object
outcome_corr_object_object_matrix <- outcome_corr_object$rho

# Write file path to save plot
pdf(file = "/Users/helenadavies/werk/EDBEHSELFHARM2/gitEDBEHSELFHARM/plots/correlations/all_outcomes_corr_matrix.pdf")

# Create correlation matrix with hierarchical clustering
outcome_corr_object_object_matrix <- corrplot::corrplot(outcome_corr_object_object_matrix, 
         method = "color", # objects to represent the correlations on plot
         type = "lower", # only use the lower triangle of the matrix
         diag = FALSE, # do not show the correlations on the diagonal
         addgrid.col = NA,
         addCoef.col = "black", # colour for the correlation coefficients in the plot
         tl.cex = 0.5,
         order = "hclust",
         tl.col = "black",
         cl.align.text = "c",
         col=colorRampPalette(c("dodgerblue4","white","firebrick4"))(200), # colours for correlations
         number.font = 0.1,
         number.cex = 0.4,
         sig.level = 0.01, # Choose significant level
         insig = "blank", # Nonsignificant correlations have no colour,
         bg = "white"
         )

# Save plot
dev.off()
```


# CORRELATION MATRICES of exposure variables (assessing multicollinearity)
## Dummy coding variables
```{r Dummy coding categorical variables}
descriptives.columns.dummy <- c(
  "gender_cleaned",
  "age_category_COVID_baseline",
  "race_binary",
  "highest_education",
  "mental_health_diagnosis",
  "paid_employment_key_worker",
  "vulnerable_group_member",
  "increased_loneliness_during_pandemic",
  "positive_covid_test_before_BE_final",
  "positive_covid_test_before_LW_final",
  "positive_covid_test_before_HI_final",
  "positive_covid_test_before_SH_final",
  "lost_someone_before_BE_final",
  "lost_someone_before_LW_final",
  "lost_someone_before_HI_final",
  "lost_someone_before_SH_final",
   "main_eco_change_before_BE_final",
  "main_eco_change_before_LW_final",
  "main_eco_change_before_HI_final",
  "main_eco_change_before_SH_final",
  "living_situation_change_before_BE_final",
  "living_situation_change_before_LW_final",
  "living_situation_change_before_HI_final",
  "living_situation_change_before_SH_final",
  "ocd.compulsive_beh_mental_act_binary",
  "ocd.repetitive_unpleasant_thoughts_binary"
)
```

Data frame of dummy variables
```{r Data frame dummy variables}
dat_dummy <- fastDummies::dummy_cols(dat,
                                     select_columns = descriptives.columns.dummy)
# Check
dat_dummy %>%
  colnames()
```

## Binge eating
```{r binge eating correlation matrix}
# Select items for correlation matrix
BE_dat_corr_mat <- dat_dummy %>%
  select(
   "Man" = "gender_cleaned_Man",
   "Woman" = "gender_cleaned_Woman",
   "Minoritised_gender" = "gender_cleaned_Minoritised gender",
   "16-25" = "age_category_COVID_baseline_16-25",
   "26-35" = "age_category_COVID_baseline_26-35",
   "36-45" = "age_category_COVID_baseline_36-45",
   "46-55" = "age_category_COVID_baseline_46-55",
   "56-65" = "age_category_COVID_baseline_56-65",
   "66-70" =  "age_category_COVID_baseline_66-70",
   "71+" = "age_category_COVID_baseline_71+",
   "White" = "race_binary_White",
   "No_qual" = "highest_education_No formal qualifications",                    
   "GCSE/CSE" =  "highest_education_GCSE/CSE",                                    
   "NVQ" =  "highest_education_NVQ",                                        
   "A-Levels" =   "highest_education_A-levels",                                    
   "Uni/Other_prof_qual" = "highest_education_University/Other professional qualifications",
   "Psych_disorder" ="mental_health_diagnosis_Psychiatric disorder",
   "Key_worker" ="paid_employment_key_worker_Key worker",
   "Employed_not_key"  = "paid_employment_key_worker_Paid employment",
   "Unemployed" = "paid_employment_key_worker_Not paid employment",
   "Student" = "paid_employment_key_worker_Student",
   "Retired"= "paid_employment_key_worker_Retired",
   "Vulnerable_group" = "vulnerable_group_member_Yes",
   "Positive_COVID_test" = "positive_covid_test_before_BE_final_Yes",
   "Loss" = "lost_someone_before_BE_final_Yes",
   "Lonelier_during_pandemic" = "increased_loneliness_during_pandemic_Yes",
   "Change_main_eco" = "main_eco_change_before_BE_final_Yes",
   "Change_living_sit" ="living_situation_change_before_BE_final_Yes",
   "pan_worry" = "panworry_total_score"
 ) 

# Run correlation analyses with continious and dichotomous variables 
BE_corr_mat_object <- psych::mixedCor(data=BE_dat_corr_mat,
         c= 29,  # Continuous variables
         p= NULL,
         d= 1:28, # Dichotomous variable
             use="pairwise.complete.obs")


# Save correlation matrix in an object
BE_corr_mat_object_matrix <- BE_corr_mat_object$rho

# Write file path to save plot
pdf(file = "/Users/helenadavies/werk/EDBEHSELFHARM2/gitEDBEHSELFHARM/plots/correlations/BE_exposures_corr_matrix.pdf")

# Create correlation matrix with hierarchical clustering
BE_exposures_corr_matrix <- corrplot::corrplot(BE_corr_mat_object_matrix, 
         method = "color", # objects to represent the correlations on plot
         type = "lower", # only use the lower triangle of the matrix
         diag = FALSE, # do not show the correlations on the diagonal
         addgrid.col = NA,
         addCoef.col = "black", # colour for the correlation coefficients in the plot
         tl.cex = 0.5,
         order = "hclust",
         tl.col = "black",
         cl.align.text = "c",
         col=colorRampPalette(c("dodgerblue4","white","firebrick4"))(200), # colours for correlations
         number.font = 0.1,
         number.cex = 0.4,
         sig.level = 0.01, # Choose significant level
         insig = "blank", # Nonsignificant correlations have no colour,
         bg = "white"
         )

# Save plot
dev.off()
```

## Low weight
```{r low weight correlation matrix}
# Select items for correlation matrix
LW_dat_corr_mat <- dat_dummy %>%
  select(
   "Man" = "gender_cleaned_Man",
   "Woman" = "gender_cleaned_Woman",
   "Minoritised_gender" = "gender_cleaned_Minoritised gender",
   "16-25" = "age_category_COVID_baseline_16-25",
   "26-35" = "age_category_COVID_baseline_26-35",
   "36-45" = "age_category_COVID_baseline_36-45",
   "46-55" = "age_category_COVID_baseline_46-55",
   "56-65" = "age_category_COVID_baseline_56-65",
   "66-70" =  "age_category_COVID_baseline_66-70",
   "71+" = "age_category_COVID_baseline_71+",
   "White" = "race_binary_White",
   "No_qual" = "highest_education_No formal qualifications",                    
   "GCSE/CSE" =  "highest_education_GCSE/CSE",                                    
   "NVQ" =  "highest_education_NVQ",                                        
   "A-Levels" =   "highest_education_A-levels",                                    
   "Uni/Other_prof_qual" = "highest_education_University/Other professional qualifications",
   "Psych_disorder" ="mental_health_diagnosis_Psychiatric disorder",
   "Key_worker" ="paid_employment_key_worker_Key worker",
   "Employed_not_key"  = "paid_employment_key_worker_Paid employment",
   "Unemployed" = "paid_employment_key_worker_Not paid employment",
   "Student" = "paid_employment_key_worker_Student",
   "Retired"= "paid_employment_key_worker_Retired",
   "Vulnerable_group" = "vulnerable_group_member_Yes",
   "Positive_COVID_test" = "positive_covid_test_before_LW_final_Yes",
   "Loss" = "lost_someone_before_LW_final_Yes",
   "Lonelier_during_pandemic" = "increased_loneliness_during_pandemic_Yes",
   "Change_main_eco" = "main_eco_change_before_LW_final_Yes",
   "Change_living_sit" ="living_situation_change_before_LW_final_Yes",
   "compulsive_beh_or_acts" = "ocd.compulsive_beh_mental_act_binary_Yes",
   "repetitive_thoughts" =  "ocd.repetitive_unpleasant_thoughts_binary_Yes",
   "pan_worry" = "panworry_total_score"
) 

# Run correlation analyses with continious and dichotomous variables 
LW_corr_mat_object <- psych::mixedCor(data=LW_dat_corr_mat,
         c= 31,  # Continuous variables
         p= NULL,
         d= 1:29, # Dichotomous variable
             use="pairwise.complete.obs")


#Save correlation matrix in an object
LW_corr_mat_object_matrix <- LW_corr_mat_object$rho

# Write file path to save plot
pdf(file = "/Users/helenadavies/werk/EDBEHSELFHARM2/gitEDBEHSELFHARM/plots/correlations/LW_exposures_corr_matrix.pdf")

# Create correlation matrix with hierarchical clustering
corrplot::corrplot(LW_corr_mat_object_matrix, 
         method = "color", # objects to represent the correlations on plot
         type = "lower", # only use the lower triangle of the matrix
         diag = FALSE, # do not show the correlations on the diagonal
         addgrid.col = NA,
         addCoef.col = "black", # colour for the correlation coefficients in the plot
         tl.cex = 0.5,
         order = "hclust",
         tl.col = "black",
         cl.align.text = "c",
         col=colorRampPalette(c("dodgerblue4","white","firebrick4"))(200), # colours for correlations
         number.font = 0.1,
         number.cex = 0.4,
         sig.level = 0.01, # Choose significant level
         insig = "blank", # Nonsignificant correlations have no colour,
         bg = "white"
         )

# Save plot
dev.off()
```

## Harmful ideation
```{r harmful ideation correlation matrix}
# Select items for correlation matrix
HI_dat_corr_mat <- dat_dummy %>%
  select( 
   "Man" = "gender_cleaned_Man",
   "Woman" = "gender_cleaned_Woman",
   "Minoritised_gender" = "gender_cleaned_Minoritised gender",
   "16-25" = "age_category_COVID_baseline_16-25",
   "26-35" = "age_category_COVID_baseline_26-35",
   "36-45" = "age_category_COVID_baseline_36-45",
   "46-55" = "age_category_COVID_baseline_46-55",
   "56-65" = "age_category_COVID_baseline_56-65",
   "66-70" =  "age_category_COVID_baseline_66-70",
   "71+" = "age_category_COVID_baseline_71+",
   "White" = "race_binary_White",
  "No_qual" = "highest_education_No formal qualifications",                    
   "GCSE/CSE" =  "highest_education_GCSE/CSE",                                    
   "NVQ" =  "highest_education_NVQ",                                        
   "A-Levels" =   "highest_education_A-levels",                                    
   "Uni/Other_prof_qual" = "highest_education_University/Other professional qualifications",
   "Psych_disorder" ="mental_health_diagnosis_Psychiatric disorder",
   "Key_worker" ="paid_employment_key_worker_Key worker",
   "Employed_not_key"  = "paid_employment_key_worker_Paid employment",
   "Unemployed" = "paid_employment_key_worker_Not paid employment",
   "Student" = "paid_employment_key_worker_Student",
   "Retired"= "paid_employment_key_worker_Retired",
   "Vulnerable_group" = "vulnerable_group_member_Yes",
   "Positive_COVID_test" = "positive_covid_test_before_HI_final_Yes",
   "Loss" = "lost_someone_before_HI_final_Yes",
   "Lonelier_during_pandemic" = "increased_loneliness_during_pandemic_Yes",
   "Change_main_eco" = "main_eco_change_before_HI_final_Yes",
   "Change_living_sit" ="living_situation_change_before_HI_final_Yes",
   "pan_worry" = "panworry_total_score"
 ) 

# Run correlation analyses with continious and dichotomous variables 
HI_corr_mat_object <- psych::mixedCor(data=HI_dat_corr_mat,
         c= 29,  # Continuous variables
         p= NULL,
         d= 1:28, # Dichotomous variable
             use="pairwise.complete.obs")


# Save correlation matrix in an object
HI_corr_mat_object_matrix <- HI_corr_mat_object$rho

# Write file path to save plot
pdf(file = "/Users/helenadavies/werk/EDBEHSELFHARM2/gitEDBEHSELFHARM/plots/correlations/HI_exposures_corr_matrix.pdf")

# Create correlation matrix with hierarchical clustering
corrplot::corrplot(HI_corr_mat_object_matrix, 
         method = "color", # objects to represent the correlations on plot
         type = "lower", # only use the lower triangle of the matrix
         diag = FALSE, # do not show the correlations on the diagonal
         addgrid.col = NA,
         addCoef.col = "black", # colour for the correlation coefficients in the plot
         tl.cex = 0.5,
         order = "hclust",
         tl.col = "black",
         cl.align.text = "c",
         col=colorRampPalette(c("dodgerblue4","white","firebrick4"))(200), # colours for correlations
         number.font = 0.1,
         number.cex = 0.4,
         sig.level = 0.01, # Choose significant level
         insig = "blank", # Nonsignificant correlations have no colour,
         bg = "white"
         )

# Save plot
dev.off()
```

## Self-harm 
```{r self-harm correlation matrix}
# Select items for correlation matrix
SH_dat_corr_mat <- dat_dummy %>%
  select(
   "Man" = "gender_cleaned_Man",
   "Woman" = "gender_cleaned_Woman",
   "Minoritised_gender" = "gender_cleaned_Minoritised gender",
   "16-25" = "age_category_COVID_baseline_16-25",
   "26-35" = "age_category_COVID_baseline_26-35",
   "36-45" = "age_category_COVID_baseline_36-45",
   "46-55" = "age_category_COVID_baseline_46-55",
   "56-65" = "age_category_COVID_baseline_56-65",
   "66-70" =  "age_category_COVID_baseline_66-70",
   "71+" = "age_category_COVID_baseline_71+",
   "White" = "race_binary_White",
   "No_qual" = "highest_education_No formal qualifications",                    
   "GCSE/CSE" =  "highest_education_GCSE/CSE",                                    
   "NVQ" =  "highest_education_NVQ",                                        
   "A-Levels" =   "highest_education_A-levels",                                    
   "Uni/Other_prof_qual" = "highest_education_University/Other professional qualifications",
   "Psych_disorder" ="mental_health_diagnosis_Psychiatric disorder",
   "Key_worker" ="paid_employment_key_worker_Key worker",
   "Employed_not_key"  = "paid_employment_key_worker_Paid employment",
   "Unemployed" = "paid_employment_key_worker_Not paid employment",
   "Student" = "paid_employment_key_worker_Student",
   "Retired"= "paid_employment_key_worker_Retired",
   "Vulnerable_group" = "vulnerable_group_member_Yes",
   "Positive_COVID_test" = "positive_covid_test_before_SH_final_Yes",
   "Loss" = "lost_someone_before_SH_final_Yes",
   "Lonelier_during_pandemic" = "increased_loneliness_during_pandemic_Yes",
   "Change_main_eco" = "main_eco_change_before_SH_final_Yes",
   "Change_living_sit" ="living_situation_change_before_SH_final_Yes",
   "pan_worry" = "panworry_total_score"
 ) 

# Run correlation analyses with continious and dichotomous variables 
SH_corr_mat_object <- psych::mixedCor(data=SH_dat_corr_mat,
         c= 29,  # Continuous variables
         p= NULL,
         d= 1:28, # Dichotomous variable
             use="pairwise.complete.obs")

# Save correlation matrix in an object
SH_corr_mat_object_matrix <- SH_corr_mat_object$rho

# Write file path to save plot
pdf(file = "/Users/helenadavies/werk/EDBEHSELFHARM2/gitEDBEHSELFHARM/plots/correlations/SH_exposures_corr_matrix.pdf")

# Create correlation matrix with hierarchical clustering
corrplot::corrplot(SH_corr_mat_object_matrix, 
         method = "color", # objects to represent the correlations on plot
         type = "lower", # only use the lower triangle of the matrix
         diag = FALSE, # do not show the correlations on the diagonal
         addgrid.col = NA,
         addCoef.col = "black", # colour for the correlation coefficients in the plot
         tl.cex = 0.5,
         order = "hclust",
         tl.col = "black",
         cl.align.text = "c",
         col=colorRampPalette(c("dodgerblue4","white","firebrick4"))(200), # colours for correlations
         number.font = 0.1,
         number.cex = 0.4,
         sig.level = 0.01, # Choose significant level
         insig = "blank", # Nonsignificant correlations have no colour,
         bg = "white"
         )

# Save plot
dev.off()
```