---
title: "Regressions"
author: "Helena Davies"
date: "24/05/2021"
output: html_document
---

Configure global options for all chunks
```{r Setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  comment = '',
  prompt = FALSE,
  cache = FALSE
  )
```

Clear global environment prior to initiation
```{r Clear global environment}
remove(list = ls())
```

Read in file with path to data channel
```{r Read in file with path to data channel}
source(file = "../credentials/paths.R")
```

Add the add_numeric function - used to convert character variables into numeric variables
Add the remove_duplicates function - used to deduplicate and remove NAs from IDs
Add the sumscores function - used to generate sumscores
Add the package_check function - used to install and load dependencies
Add the imp_check function - used to check variables for implausible values
```{r Read in functions}
source(file = paste0(filepath_functions, "add_numeric.R"))
source(file = paste0(filepath_functions, "remove_duplicates.R"))
source(file = paste0(filepath_functions, "package_check.R"))
source("./functions.R")
```

Use package_check to install and load dependencies
Load tidyverse last
```{r Install load dependencies}
packages <- c("summarytools",
              "sjlabelled",
              "Amelia",
              "gtsummary",
              "broom",
              "tidyverse")
package_check(packages)
```

Retrieve recent date
We are using the recent date to save files with paste0() as an extension to not overwrite old versions
```{r Recent date}
date <- Sys.Date()
date
```

# Read in data
```{r Read in data}
dat <- readRDS(file = "../data_cleaned/final_dat_merged_exclusions_2022-09-27.rds")
dim(dat)
   colnames(dat)
   
   
dat %>% 
     group_by(ID) %>%
     filter(n()>1)
```

```{r change panworry to factor}
dat <- dat %>%
  mutate(panworry_factor =
           case_when(panworry_total_score > -1 &
                       panworry_total_score <= 20 ~ "0-20",
             
                     panworry_total_score > 20 &
                       panworry_total_score <= 40 ~ "21-40",
                     
                     panworry_total_score > 40 &
                      panworry_total_score <= 60 ~ "41-60",
                     
                      panworry_total_score > 60 &
                      panworry_total_score <= 80 ~ "61-80"
                     )
         )
```

### Re-ordering variables / converting to factors
First, re-order all variables to get desired reference category for plotting - put largest category as reference
Age
```{r Re-order age levels}
dat <- dat %>%
  mutate(age_category_COVID_baseline = factor(age_category_COVID_baseline,
                       levels = c("46-55", # Mid-life
                                   "16-25",
                                  "26-35",
                                  "36-45",
                                  "56-65", 
                                   "66-70",
                                   "71+")
                       )
         )

# Check
dat %>%
  freq(age_category_COVID_baseline)
```

Race
```{r Re-order race levels}
dat <- dat %>%
  mutate(race_binary = factor(race_binary,
                       levels = c("White", # Largest category
                                  "Racially minoritised"
                                  )))
dat %>%
  freq(race_binary)
```

Psychiatric disorder
```{r  Re-order psych disorder levels}
# First recode to "Yes" and "No"
dat <- dat %>%
  mutate(psych_disorder_factor =
           case_when(
            mental_health_diagnosis == "Psychiatric disorder" ~ "Yes", 
            mental_health_diagnosis == "No psychiatric disorder" ~ "No")
  )

# Check 
dat %>%
  freq(psych_disorder_factor)

# Then change order
dat <- dat %>%
  mutate(psych_disorder_factor = factor(psych_disorder_factor,
                       levels = c( "No", # Ref category
                                  "Yes"
                                  )))

# Check again
dat %>%
  freq(psych_disorder_factor)
```

Employment
```{r Re-order employment levels}
dat <- dat%>%
  mutate(paid_employment_key_worker = factor(paid_employment_key_worker,
                       levels = c("Paid employment",  
                                  "Key worker",
                                  "Not paid employment",
                                  "Retired",
                                  "Student"
                                  )
                       )
         )

# Check
dat %>%
  freq(paid_employment_key_worker)
```

# REGRESSION MODELS
## Binge eating
Age, gender, race, education, psych disorder, key worker/employment status, vulnerable group member, pandemic worry, positive COVID test, loss of loved one, change in main eco activity, change in living situation

Pandemic worry: If you include a continuous predictor in your logistic regression, the exponentiated coefficient represents the odds ratio for one unit change in the predictor. Often, one unit isn't meaningful and you want the odds ratio for, say, 10 units. To calculate this, just exponentiate the coefficient multiplied by 10: ùëÇùëÖ10=exp(ùõΩ‚ãÖ10). 
```{r Binge eating age model}
# Reference category
dat <- within(dat,
              age_category_COVID_baseline <- relevel(age_category_COVID_baseline,
                                                     ref = "46-55"))

model_age <- glm(NEW_binge_eating_pandemic ~  
                 age_category_COVID_baseline,
                 data = dat,
                 family = "binomial"
              )

binge_eating_age <- tidy(model_age,
     conf.int=TRUE,
     exponentiate=TRUE)

fitted(model_age) %>% 
  length()

binge_eating_age
```

```{r Binge eating sex extended model}
# Reference category
dat <- within(dat,
              sex_binary <- relevel(factor(sex_binary),
                                    ref = "Male"))

model_sex <- glm(NEW_binge_eating_pandemic ~  
                 sex_binary,
                 data = dat,
                 family = "binomial"
              )

binge_eating_sex <- tidy(model_sex,
     conf.int=TRUE,
     exponentiate=TRUE)

fitted(model_sex) %>% 
  length()

binge_eating_sex
```

```{r Binge eating race extended model}
# Reference category
dat <- within(dat,
              race_binary <- relevel(factor(race_binary),
                                    ref = "White"))

model_race <- glm(NEW_binge_eating_pandemic ~  
                 race_binary,
                 data = dat,
                 family = "binomial"
              )

binge_eating_race <- tidy(model_race,
     conf.int=TRUE,
     exponentiate=TRUE)

fitted(model_race) %>% 
  length()

binge_eating_race
```

```{r Binge eating gender model}
# Reference category
dat <- within(dat,
              minoritised_gender <- relevel(factor(minoritised_gender),
                                    ref = "No"))


model_gender <- glm(NEW_binge_eating_pandemic ~   minoritised_gender +
                   age_category_COVID_baseline,
                 data = dat,
                 family = "binomial"
              )

binge_eating_gender <- tidy(model_gender,
     conf.int=TRUE,
     exponentiate=TRUE)

fitted(model_gender) %>% 
  length()

binge_eating_gender
```

Check for Variance inflation factor estimate (VIF) - direct estimate of collinearity in data
```{r check VIF binge eating}
car::vif(model_gender)
```

```{r Binge eating psych disorder model}
# Reference category
dat <- within(dat,
              psych_disorder_factor <- relevel(factor(psych_disorder_factor),
                                    ref = "No"))

model_psych_disorder <- glm(NEW_binge_eating_pandemic ~  psych_disorder_factor +
              age_category_COVID_baseline +
                 sex_binary +
                 minoritised_gender +
                 race_binary +
                 vulnerable_group_member +
                  positive_covid_test_before_BE_final +
                 lost_someone_before_BE_final,
                 data = dat,
                 family = "binomial"
              )

binge_eating_psych_disorder <- tidy(model_psych_disorder,
     conf.int=TRUE,
     exponentiate=TRUE)

fitted(model_psych_disorder) %>% 
  length()

binge_eating_psych_disorder
```

Check for Variance inflation factor estimate (VIF) - direct estimate of collinearity in data
```{r check VIF binge eating}
car::vif(model_psych_disorder)
```

```{r Binge eating employment model}
# Reference category
dat <- within(dat,
              paid_employment_key_worker <- relevel(factor(paid_employment_key_worker),
                                    ref = "Paid employment"))


model_employment <- glm(NEW_binge_eating_pandemic ~ paid_employment_key_worker + 
                          age_category_COVID_baseline +
                 sex_binary +
                 race_binary +
                 minoritised_gender +
                 psych_disorder_factor + 
                 vulnerable_group_member,
                 data = dat,
                 family = "binomial"
              )

binge_eating_employment <- tidy(model_employment,
     conf.int=TRUE,
     exponentiate=TRUE)

fitted(model_employment) %>% 
  length()

binge_eating_employment
```

Check for Variance inflation factor estimate (VIF) - direct estimate of collinearity in data
```{r check VIF binge eating}
car::vif(model_employment)
```

```{r Binge eating vulnerable group member model}
# Reference category
dat <- within(dat,
              vulnerable_group_member <- relevel(factor(vulnerable_group_member),
                                    ref = "No"))

model_vulnerable_group_member <- glm(NEW_binge_eating_pandemic ~ vulnerable_group_member + 
                          age_category_COVID_baseline +
                 sex_binary,
                 data = dat,
                 family = "binomial"
              )

binge_eating_vulnerable_group_member <- tidy(model_vulnerable_group_member,
     conf.int=TRUE,
     exponentiate=TRUE)

fitted(model_vulnerable_group_member) %>% 
  length()

binge_eating_vulnerable_group_member
```

Check for Variance inflation factor estimate (VIF) - direct estimate of collinearity in data
```{r check VIF binge eating}
car::vif(model_vulnerable_group_member)
```

```{r Binge eating pandemic worry model}
# Reference category
dat <- within(dat,
              panworry_factor <- relevel(factor(panworry_factor),
                                    ref = "0-20"))

model_panworry <- glm(NEW_binge_eating_pandemic ~ panworry_factor + 
                          age_category_COVID_baseline +
                   sex_binary +
                   race_binary +
                   psych_disorder_factor +
                   paid_employment_key_worker +
                   vulnerable_group_member +
                   positive_covid_test_before_BE_final,
                 data = dat,
                 family = "binomial"
              )

binge_eating_panworry <- tidy(model_panworry,
     conf.int=TRUE,
     exponentiate=TRUE)

fitted(model_panworry) %>% 
  length()

binge_eating_panworry
```

Check for Variance inflation factor estimate (VIF) - direct estimate of collinearity in data
```{r check VIF binge eating}
car::vif(model_panworry)
```

```{r Binge eating loneliness model}
# Reference category
dat <- within(dat,
              increased_loneliness_during_pandemic <- relevel(factor(increased_loneliness_during_pandemic),
                                    ref = "No"))

model_loneliness <- glm(NEW_binge_eating_pandemic ~ increased_loneliness_during_pandemic +
                          age_category_COVID_baseline +
                     sex_binary +
                   psych_disorder_factor +
                   paid_employment_key_worker +
                   vulnerable_group_member +
                   panworry_factor +  
                   positive_covid_test_before_BE_final + 
                   lost_someone_before_BE_final + 
                   main_eco_change_before_BE_final + 
                 living_situation_change_before_BE_final, 
                 data = dat,
                 family = "binomial"
              )

binge_eating_loneliness <- tidy(model_loneliness,
     conf.int=TRUE,
     exponentiate=TRUE)

fitted(model_loneliness) %>% 
  length()

binge_eating_loneliness
```

Check for Variance inflation factor estimate (VIF) - direct estimate of collinearity in data
```{r check VIF binge eating}
car::vif(model_loneliness)
```

```{r Binge eating lost someone model}
# Reference category
dat <- within(dat,
              lost_someone_before_BE_final <- relevel(factor(lost_someone_before_BE_final),
                                    ref = "No"))

model_loss <- glm(NEW_binge_eating_pandemic ~ lost_someone_before_BE_final + 
                   age_category_COVID_baseline +
                   sex_binary +
                   race_binary +
                   vulnerable_group_member,
                 data = dat,
                 family = "binomial"
              )

binge_eating_loss <- tidy(model_loss,
     conf.int=TRUE,
     exponentiate=TRUE)

fitted(model_loss) %>% 
  length()

binge_eating_loss
```

Check for Variance inflation factor estimate (VIF) - direct estimate of collinearity in data
```{r check VIF binge eating}
car::vif(model_loss)
```

```{r Binge eating main eco change model}
# Reference category
dat <- within(dat,
              main_eco_change_before_BE_final <- relevel(factor(main_eco_change_before_BE_final),
                                    ref = "No"))


model_main_eco_change <- glm(NEW_binge_eating_pandemic ~ main_eco_change_before_BE_final + 
                   age_category_COVID_baseline +
                 sex_binary +
                 race_binary +
                 psych_disorder_factor + 
                 paid_employment_key_worker + 
                 vulnerable_group_member, 
                 data = dat,
                 family = "binomial"
              )

binge_eating_main_eco_change <- tidy(model_main_eco_change,
     conf.int=TRUE,
     exponentiate=TRUE)

fitted(model_main_eco_change) %>% 
  length()

binge_eating_main_eco_change
```

Check for Variance inflation factor estimate (VIF) - direct estimate of collinearity in data
```{r check VIF binge eating}
car::vif(model_main_eco_change)
```

```{r Binge eating living situation change model}
# Reference category
dat <- within(dat,
              living_situation_change_before_BE_final <- relevel(factor(living_situation_change_before_BE_final),
                                    ref = "No"))

model_living_sit_change <- glm(NEW_binge_eating_pandemic ~ living_situation_change_before_BE_final +
                age_category_COVID_baseline +
                 sex_binary +
                 race_binary +
                 psych_disorder_factor + 
                 paid_employment_key_worker + 
                 vulnerable_group_member + 
                 panworry_factor +
                 main_eco_change_before_BE_final, 
                 data = dat,
                 family = "binomial"
              )

binge_eating_living_sit_change <- tidy(model_living_sit_change,
     conf.int=TRUE,
     exponentiate=TRUE)

fitted(model_living_sit_change) %>% 
  length()

binge_eating_living_sit_change
```

Check for Variance inflation factor estimate (VIF) - direct estimate of collinearity in data
```{r check VIF binge eating}
car::vif(model_living_sit_change)
```

```{r Binge eating COVID19 illness model}
model_COVID19_illness <- glm(NEW_binge_eating_pandemic ~  positive_covid_test_before_BE_final +
                 age_category_COVID_baseline +
                 sex_binary +
                 race_binary +
                 paid_employment_key_worker + 
                 vulnerable_group_member +
                 panworry_factor + 
                 main_eco_change_before_BE_final + 
                 living_situation_change_before_BE_final, 
                 data = dat,
                 family = "binomial"
              )

binge_eating_COVID19_illness <- tidy(model_COVID19_illness,
     conf.int=TRUE,
     exponentiate=TRUE)

fitted(model_COVID19_illness) %>% 
  length()
```

Check for Variance inflation factor estimate (VIF) - direct estimate of collinearity in data
```{r check VIF binge eating}
car::vif(model_COVID19_illness)
```

### Plot: Binge eating
```{r plot binge eating regression results}
# Enter OR and CI data. boxOdds are the odds ratios, 
# boxCILow is the lower bound of the CI, boxCIHigh is the upper bound.

## All results
df <- data.frame(labels = c("Age: 16-25 years",
              "Age: 26-35 years",
              "Age: 36-45 years",
              "Age: 56-65 years",
              "Age: 66-70 years",
              "Age: 71+ years",
              "Female",
              "Racially minoritised",
              "Minoritised gender",
              "Psychiatric disorder",
              "Employment: Key worker",
              "Employment: Not in paid employment",
              "Employment: Retired",
              "Employment: Student",
              "Vulnerable group member",
              "Pandemic worry score: 21-40",
              "Pandemic worry score: 41-60",
              "Pandemic worry score: 61-80",
              "Increased loneliness during pandemic",
              "Lost someone due to COVID-19",
              "Change in main economic activity",
              "Change in living situation",
              "COVID-19 illness and/or positive test"),
                 boxOdds = c(0.9965588,
                             0.9488022,
                             1.0084248,
                             0.8173021,
                             0.6191922,
                             0.5265286,
                             1.546624,
                             1.4848656,
                             1.2710775,
                             1.8699917,
                             1.2892438,
                             1.4578472,
                             0.9693344,
                             1.2011027,
                             1.3528379,
                             1.4588812,
                             2.2921423,
                             2.9719076,
                             1.1359036,
                             0.9297841,
                             1.0119891,
                             0.7931211,
                             0.3808807),
                 boxCILow = c(0.8762611,
                              0.8467316,
                              0.9046767,
                              0.7478543,
                              0.5494629,
                              0.4639614,
                              1.4423048,
                              1.261959,
                              0.9720519,
                              1.7375315,
                              1.1837228,
                              1.2974512,
                              0.8609434,
                              0.9755838,
                              1.2504911,
                              1.33543696,
                              2.052895,
                              2.1611357,
                              1.05274397,
                              0.8201154,
                              0.9379548,
                              0.7271914,
                              0.3048686),
                 boxCIHigh = c(1.1318566,
                               1.062368,
                               1.1234824,
                               0.8932878,
                               0.6968718,
                               0.5964766,
                               1.6593601,
                               1.7410669,
                               1.6457648,
                               2.0132927,
                               1.4046875,
                               1.6372447,
                               1.091481,
                               1.4748948,
                               1.4629432,
                               1.5950503,
                               2.5600712,
                               4.0660066,
                               1.2254443,
                               1.0513484,
                               1.0918919,
                               0.864255,
                               0.47012
                               ))

## Significant results
df_sig <- data.frame(labels_sig = c("Age: 56-65 years",
                  "Age: 66-70 years",
                  "Age: 71+ years",
                  "Female",
                  "Racially minoritised",
                  "Psychiatric disorder",
                  "Employment: Key worker",
                  "Employment: Not in paid employment",
                  "Vulnerable group member",
                  "Pandemic worry score: 21-40",
                  "Pandemic worry score: 41-60",
                  "Pandemic worry score: 61-80",
                  "Increased loneliness during pandemic",
                  "Change in living situation",
                  "COVID-19 illness and/or positive test"),
                 boxOdds_sig = c(0.8173021,
                                 0.6191922,
                                 0.5265286,
                                 1.546624,
                                 1.4848656,
                                 1.8699917,
                                 1.2892438,
                                 1.4578472,
                                 1.3528379,
                                 1.4588812,
                                 2.2921423,
                                 2.9719076,
                                 1.1359036,
                                 0.7931211,
                                 0.3808807),
                 boxCILow_sig = c(0.7478543,
                                  0.5494629,
                                  0.4639614,
                                  1.4423048,
                                  1.261959,
                                  1.7375315,
                                  1.1837228,
                                  1.2974512,
                                  1.2504911,
                                  1.33543696,
                                  2.052895,
                                  2.1611357,
                                  1.05274397,
                                  0.7271914,
                                  0.3048686),
                 boxCIHigh_sig = c(0.8932878,
                                   0.6968718,
                                   0.5964766,
                                   1.6593601,
                                   1.7410669,
                                   2.0132927,
                                   1.4046875,
                                   1.6372447,
                                   1.4629432,
                                   1.5950503,
                                   2.5600712,
                                   4.0660066,
                                   1.2254443,
                                   0.864255,
                                   0.47012
                               ))

# Lock in factor level order
df$labels <- factor(df$labels,
                   levels = df$labels)

df_sig$labels_sig <- factor(df_sig$labels_sig,
                   levels = df_sig$labels_sig)

# Plot
BE_plot <- ggplot(df,
             aes(x = boxOdds,
                 y = labels)) + 
    geom_vline(aes(xintercept = 1),
               size = .25,
               linetype = "dashed") + 
    geom_errorbarh(aes(xmax = boxCIHigh,
                       xmin = boxCILow),
                   size = .5,
                   height = .2,
                   color = "gray50") +
    geom_point(size = 2,
               color = "gray50") + # non-significant
    scale_y_discrete(limits=rev) +
    geom_point(data=df_sig, 
             aes(x=boxOdds_sig,
                 y=labels_sig), 
             color='#86cfe2', # significant
             size=2) +
    scale_x_continuous(breaks = seq(from = 0.2,
                                         to = 4.2,
                                         by = 0.2), 
                       labels = seq(0.2,
                                    4.2,
                                    0.2),
                       limits = c(0.2,
                                  4.2)) +
    theme_bw()+
    theme(panel.grid.minor = element_blank()) +
    ylab("") +
    xlab("Odds ratio") + 
    ggtitle("New onset binge eating during the pandemic") 

BE_plot # colour sig ones differently!

ggsave(
  paste0("BE_plot",
                    date,
                    ".png"),
  plot = BE_plot,
  device = "png", 
  path = paste0(filepath_plots_main_regressions), 
  scale = 1,
  width = 30,
  height = 15,
  units = "cm"
  )
```

## Low weight
```{r Low weight age model}
# Reference category
dat <- within(dat,
              age_category_COVID_baseline <- relevel(age_category_COVID_baseline,
                                                     ref = "46-55"))

model_age <- glm(NEW_low_weight_pandemic ~  
                 age_category_COVID_baseline,
                 data = dat,
                 family = "binomial"
              )

low_weight_age <- tidy(model_age,
     conf.int=TRUE,
     exponentiate=TRUE)

fitted(model_age) %>% 
  length()

low_weight_age
```

```{r Low weight sex extended model}
# Reference category
dat <- within(dat,
              sex_binary <- relevel(factor(sex_binary),
                                    ref = "Male"))

model_sex <- glm(NEW_low_weight_pandemic ~  
                 sex_binary,
                 data = dat,
                 family = "binomial"
              )

low_weight_sex <- tidy(model_sex,
     conf.int=TRUE,
     exponentiate=TRUE)

fitted(model_sex) %>% 
  length()

low_weight_sex
```

```{r Low weight race extended model}
# Reference category
dat <- within(dat,
              race_binary <- relevel(factor(race_binary),
                                    ref = "White"))

model_race <- glm(NEW_low_weight_pandemic ~  
                 race_binary,
                 data = dat,
                 family = "binomial"
              )

low_weight_race <- tidy(model_race,
     conf.int=TRUE,
     exponentiate=TRUE)

fitted(model_race) %>% 
  length()

low_weight_race
```

```{r Low weight gender model}
# Reference category
dat <- within(dat,
              minoritised_gender <- relevel(factor(minoritised_gender),
                                    ref = "No"))


model_gender <- glm(NEW_low_weight_pandemic ~   minoritised_gender +
                   age_category_COVID_baseline,
                 data = dat,
                 family = "binomial"
              )

low_weight_gender <- tidy(model_gender,
     conf.int=TRUE,
     exponentiate=TRUE)

fitted(model_gender) %>% 
  length()

low_weight_gender
```

Check for Variance inflation factor estimate (VIF) - direct estimate of collinearity in data
```{r check VIF Low weight}
car::vif(model_gender)
```

```{r Low weight psych disorder model}
# Reference category
dat <- within(dat,
              psych_disorder_factor <- relevel(factor(psych_disorder_factor),
                                    ref = "No"))

model_psych_disorder <- glm(NEW_low_weight_pandemic ~  psych_disorder_factor +
              age_category_COVID_baseline +
                 sex_binary +
                 minoritised_gender +
                 race_binary +
                 vulnerable_group_member +
                  positive_covid_test_before_LW_final +
                 lost_someone_before_LW_final,
                 data = dat,
                 family = "binomial"
              )

low_weight_psych_disorder <- tidy(model_psych_disorder,
     conf.int=TRUE,
     exponentiate=TRUE)

fitted(model_psych_disorder) %>% 
  length()

low_weight_psych_disorder
```

Check for Variance inflation factor estimate (VIF) - direct estimate of collinearity in data
```{r check VIF Low weight}
car::vif(model_psych_disorder)
```

```{r Low weight employment model}
# Reference category
dat <- within(dat,
              paid_employment_key_worker <- relevel(factor(paid_employment_key_worker),
                                    ref = "Paid employment"))


model_employment <- glm(NEW_low_weight_pandemic ~ paid_employment_key_worker + 
                          age_category_COVID_baseline +
                 sex_binary +
                 race_binary +
                 minoritised_gender +
                 psych_disorder_factor + 
                 vulnerable_group_member,
                 data = dat,
                 family = "binomial"
              )

low_weight_employment <- tidy(model_employment,
     conf.int=TRUE,
     exponentiate=TRUE)

fitted(model_employment) %>% 
  length()

low_weight_employment
```

Check for Variance inflation factor estimate (VIF) - direct estimate of collinearity in data
```{r check VIF Low weight}
car::vif(model_employment)
```

```{r Low weight vulnerable group member model}
# Reference category
dat <- within(dat,
              vulnerable_group_member <- relevel(factor(vulnerable_group_member),
                                    ref = "No"))

model_vulnerable_group_member <- glm(NEW_low_weight_pandemic ~ vulnerable_group_member + 
                          age_category_COVID_baseline +
                 sex_binary,
                 data = dat,
                 family = "binomial"
              )

low_weight_vulnerable_group_member <- tidy(model_vulnerable_group_member,
     conf.int=TRUE,
     exponentiate=TRUE)

fitted(model_vulnerable_group_member) %>% 
  length()

low_weight_vulnerable_group_member
```

Check for Variance inflation factor estimate (VIF) - direct estimate of collinearity in data
```{r check VIF Low weight}
car::vif(model_vulnerable_group_member)
```

```{r Low weight pandemic worry model}
# Reference category
dat <- within(dat,
              panworry_factor <- relevel(factor(panworry_factor),
                                    ref = "0-20"))

model_panworry <- glm(NEW_low_weight_pandemic ~ panworry_factor + 
                          age_category_COVID_baseline +
                   sex_binary +
                   race_binary +
                   psych_disorder_factor +
                   paid_employment_key_worker +
                   vulnerable_group_member +
                   positive_covid_test_before_LW_final,
                 data = dat,
                 family = "binomial"
              )

low_weight_panworry <- tidy(model_panworry,
     conf.int=TRUE,
     exponentiate=TRUE)

fitted(model_panworry) %>% 
  length()

low_weight_panworry
```

Check for Variance inflation factor estimate (VIF) - direct estimate of collinearity in data
```{r check VIF Low weight}
car::vif(model_panworry)
```

```{r Low weight loneliness model}
# Reference category
dat <- within(dat,
              increased_loneliness_during_pandemic <- relevel(factor(increased_loneliness_during_pandemic),
                                    ref = "No"))

model_loneliness <- glm(NEW_low_weight_pandemic ~ increased_loneliness_during_pandemic +
                          age_category_COVID_baseline +
                     sex_binary +
                   psych_disorder_factor +
                   paid_employment_key_worker +
                   vulnerable_group_member +
                   panworry_factor +  
                   positive_covid_test_before_LW_final + 
                   lost_someone_before_LW_final + 
                   main_eco_change_before_LW_final + 
                 living_situation_change_before_LW_final, 
                 data = dat,
                 family = "binomial"
              )

low_weight_loneliness <- tidy(model_loneliness,
     conf.int=TRUE,
     exponentiate=TRUE)

fitted(model_loneliness) %>% 
  length()

low_weight_loneliness
```

Check for Variance inflation factor estimate (VIF) - direct estimate of collinearity in data
```{r check VIF Low weight}
car::vif(model_loneliness)
```

```{r Low weight lost someone model}
# Reference category
dat <- within(dat,
              lost_someone_before_LW_final <- relevel(factor(lost_someone_before_LW_final),
                                    ref = "No"))

model_loss <- glm(NEW_low_weight_pandemic ~ lost_someone_before_LW_final + 
                   age_category_COVID_baseline +
                   sex_binary +
                   race_binary +
                   vulnerable_group_member,
                 data = dat,
                 family = "binomial"
              )

low_weight_loss <- tidy(model_loss,
     conf.int=TRUE,
     exponentiate=TRUE)

fitted(model_loss) %>% 
  length()

low_weight_loss
```

Check for Variance inflation factor estimate (VIF) - direct estimate of collinearity in data
```{r check VIF Low weight}
car::vif(model_loss)
```

```{r Low weight main eco change model}
# Reference category
dat <- within(dat,
              main_eco_change_before_LW_final <- relevel(factor(main_eco_change_before_LW_final),
                                    ref = "No"))


model_main_eco_change <- glm(NEW_low_weight_pandemic ~ main_eco_change_before_LW_final + 
                   age_category_COVID_baseline +
                 sex_binary +
                 race_binary +
                 psych_disorder_factor + 
                 paid_employment_key_worker + 
                 vulnerable_group_member, 
                 data = dat,
                 family = "binomial"
              )

low_weight_main_eco_change <- tidy(model_main_eco_change,
     conf.int=TRUE,
     exponentiate=TRUE)

fitted(model_main_eco_change) %>% 
  length()

low_weight_main_eco_change
```

Check for Variance inflation factor estimate (VIF) - direct estimate of collinearity in data
```{r check VIF Low weight}
car::vif(model_main_eco_change)
```

```{r Low weight living situation change model}
# Reference category
dat <- within(dat,
              living_situation_change_before_LW_final <- relevel(factor(living_situation_change_before_LW_final),
                                    ref = "No"))

model_living_sit_change <- glm(NEW_low_weight_pandemic ~ living_situation_change_before_LW_final +
                age_category_COVID_baseline +
                 sex_binary +
                 race_binary +
                 psych_disorder_factor + 
                 paid_employment_key_worker + 
                 vulnerable_group_member + 
                 panworry_factor +
                 main_eco_change_before_LW_final, 
                 data = dat,
                 family = "binomial"
              )

low_weight_living_sit_change <- tidy(model_living_sit_change,
     conf.int=TRUE,
     exponentiate=TRUE)

fitted(model_living_sit_change) %>% 
  length()

low_weight_living_sit_change
```

Check for Variance inflation factor estimate (VIF) - direct estimate of collinearity in data
```{r check VIF Low weight}
car::vif(model_living_sit_change)
```

```{r Low weight COVID19 illness model}
model_COVID19_illness <- glm(NEW_low_weight_pandemic ~  positive_covid_test_before_LW_final +
                 age_category_COVID_baseline +
                 sex_binary +
                 race_binary +
                 paid_employment_key_worker + 
                 vulnerable_group_member +
                 panworry_factor + 
                 main_eco_change_before_LW_final + 
                 living_situation_change_before_LW_final, 
                 data = dat,
                 family = "binomial"
              )

low_weight_COVID19_illness <- tidy(model_COVID19_illness,
     conf.int=TRUE,
     exponentiate=TRUE)

fitted(model_COVID19_illness) %>% 
  length()

low_weight_COVID19_illness
```

Check for Variance inflation factor estimate (VIF) - direct estimate of collinearity in data
```{r check VIF Low weight}
car::vif(model_COVID19_illness)
```

### Plot: Low weight
```{r plot low weight regression results}
# Enter OR and CI data. boxOdds are the odds ratios, 
# boxCILow is the lower bound of the CI, boxCIHigh is the upper bound.

## All results
df <- data.frame(labels = c("Age: 16-25 years",
              "Age: 26-35 years",
              "Age: 36-45 years",
              "Age: 56-65 years",
              "Age: 66-70 years",
              "Age: 71+ years",
              "Female",
              "Racially minoritised",
              "Minoritised gender",
              "Psychiatric disorder",
              "Employment: Key worker",
              "Employment: Not in paid employment",
              "Employment: Retired",
              "Employment: Student",
              "Vulnerable group member",
              "Pandemic worry score: 21-40",
              "Pandemic worry score: 41-60",
              "Pandemic worry score: 61-80",
              "Increased loneliness during pandemic",
              "Lost someone due to COVID-19",
              "Change in main economic activity",
              "Change in living situation",
              "COVID-19 illness and/or positive test"),
                 boxOdds = c(1.3394079 ,
                             0.6887391,
                             0.8732472,
                             0.9875482,
                             0.8196809,
                             0.9519125,
                             0.9200172,
                             1.4292487,
                             1.2153364,
                             1.61746504,
                             1.22657646,
                             1.56143674,
                             1.01984592,
                             1.7535185,
                             1.8091301,
                             1.34292619,
                             2.05688225,
                             3.29340385,
                             1.0313678,
                             1.013092,
                             1.04676969,
                             0.88605109,
                             0.54224548),
                 boxCILow = c(1.1468279 ,
                              0.5871836,
                              0.7530902,
                              0.8786303,
                              0.7003305,
                              0.8162086,
                              0.8441379,
                              1.1653078,
                              0.8765628,
                              1.46688453,
                              1.09170166,
                              1.34691917,
                              0.87330448,
                              1.37237729,
                              1.6400031,
                              1.19401005,
                              1.78489636,
                              2.35822254,
                              0.93403934,
                              0.8677661,
                              0.9465749,
                              0.7933089,
                              0.4185315),
                 boxCIHigh = c(1.561275,
                               0.805625,
                               1.0108321,
                               1.1104146,
                               0.956989,
                               1.1078389,
                               1.0033835,
                               1.73796,
                               1.6482688,
                               1.7848713,
                               1.3794825,
                               1.8087584,
                               1.1915287,
                               2.2331741,
                               1.9940835,
                               1.51298411,
                               2.37209323,
                               4.5392589,
                               1.13847829,
                               1.1769106,
                               1.15769933,
                               0.9879675,
                               0.69069576
                               ))

## Significant results
df_sig <- data.frame(labels_sig = c("Age: 16-25 years",
                                    "Age: 26-35 years",
                                    "Racially minoritised",
                                    "Psychiatric disorder",
                                    "Employment: Key worker",
                                    "Employment: Not in paid employment",
                                    "Employment: Student",
                                    "Vulnerable group member",
                                    "Pandemic worry score: 21-40",
                                    "Pandemic worry score: 41-60",
                                    "Pandemic worry score: 61-80",
                                    "COVID-19 illness and/or positive test"),
                 boxOdds_sig = c(1.3394079 ,
                                 0.6887391,
                                 1.4292487,
                                 1.61746504,
                                 1.22657646,
                                 1.56143674,
                                 1.7535185,
                                 1.8091301,
                                 1.34292619,
                                 2.05688225,
                                 3.29340385,
                                 0.54224548),
                 boxCILow_sig = c(1.1468279,
                                  0.5871836,
                                  1.1653078,
                                  1.46688453,
                                  1.09170166,
                                  1.34691917,
                                  1.37237729,
                                  1.6400031,
                                  1.19401005,
                                  1.78489636,
                                  2.35822254,
                                  0.4185315),
                 boxCIHigh_sig = c(1.561275,
                                   0.805625,
                                   1.73796,
                                   1.7848713,
                                   1.3794825,
                                   1.8087584,
                                   2.2331741,
                                   1.9940835,
                                   1.51298411,
                                   2.37209323,
                                   4.5392589,
                                   0.69069576
                               ))

# Lock in factor level order
df$labels <- factor(df$labels,
                   levels = df$labels)

df_sig$labels_sig <- factor(df_sig$labels_sig,
                   levels = df_sig$labels_sig)

# Plot
LW_plot <- ggplot(df,
             aes(x = boxOdds,
                 y = labels)) + 
    geom_vline(aes(xintercept = 1),
               size = .25,
               linetype = "dashed") + 
    geom_errorbarh(aes(xmax = boxCIHigh,
                       xmin = boxCILow),
                   size = .5,
                   height = .2,
                   color = "gray50") +
    geom_point(size = 2,
               color = "gray50") + # non-significant
    scale_y_discrete(limits=rev) +
    geom_point(data=df_sig, 
             aes(x=boxOdds_sig,
                 y=labels_sig), 
             color='#86cfe2', # significant
             size=2) +
    scale_x_continuous(breaks = seq(from = 0.2,
                                         to = 4.6,
                                         by = 0.2), 
                       labels = seq(0.2,
                                    4.6,
                                    0.2),
                       limits = c(0.2,
                                  4.6)) +
    theme_bw()+
    theme(panel.grid.minor = element_blank()) +
    ylab("") +
    xlab("Odds ratio") + 
    ggtitle("New onset low weight during the pandemic") 

LW_plot # colour sig ones differently!

ggsave(
  paste0("LW_plot",
                    date,
                    ".png"),
  plot = LW_plot,
  device = "png", 
  path = paste0(filepath_plots_main_regressions), 
  scale = 1,
  width = 30,
  height = 15,
  units = "cm"
  )
```

## Suicidal and/or self-harm ideation
```{r Suicidal and/or self-harm ideation age model}
# Create harmful ideation data
dat_HI <- dat %>%
  filter(HI_data_for_model == 1)

# Reference category
dat_HI <- within(dat_HI,
              age_category_COVID_baseline <- relevel(age_category_COVID_baseline,
                                                     ref = "46-55"))

model_age <- glm(NEW_harmful_ideation_pandemic ~  
                 age_category_COVID_baseline,
                 data = dat_HI,
                 family = "binomial"
              )

harmful_ideation_age <- tidy(model_age,
     conf.int=TRUE,
     exponentiate=TRUE)

fitted(model_age) %>% 
  length()

harmful_ideation_age
```

```{r Suicidal and/or self-harm ideation sex extended model}
# Reference category
dat_HI <- within(dat_HI,
              sex_binary <- relevel(factor(sex_binary),
                                    ref = "Male"))

model_sex <- glm(NEW_harmful_ideation_pandemic ~  
                 sex_binary,
                 data = dat_HI,
                 family = "binomial"
              )

harmful_ideation_sex <- tidy(model_sex,
     conf.int=TRUE,
     exponentiate=TRUE)

fitted(model_sex) %>% 
  length()

harmful_ideation_sex
```

```{r Harmful ideation race extended model}
# Reference category
dat_HI <- within(dat_HI,
              race_binary <- relevel(factor(race_binary),
                                    ref = "White"))

model_race <- glm(NEW_harmful_ideation_pandemic ~  
                 race_binary,
                 data = dat_HI,
                 family = "binomial"
              )

harmful_ideation_race <- tidy(model_race,
     conf.int=TRUE,
     exponentiate=TRUE)

fitted(model_race) %>% 
  length()

harmful_ideation_race
```

```{r Suicidal and/or self-harm ideation gender model}
# Reference category
dat_HI <- within(dat_HI,
              minoritised_gender <- relevel(factor(minoritised_gender),
                                    ref = "No"))


model_gender <- glm(NEW_harmful_ideation_pandemic ~   minoritised_gender +
                   age_category_COVID_baseline,
                 data = dat_HI,
                 family = "binomial"
              )

harmful_ideation_gender <- tidy(model_gender,
     conf.int=TRUE,
     exponentiate=TRUE)

fitted(model_gender) %>% 
  length()

harmful_ideation_gender
```

Check for Variance inflation factor estimate (VIF) - direct estimate of collinearity in dat_HIa
```{r check VIF Suicidal and/or self-harm ideation}
car::vif(model_gender)
```

```{r Suicidal and/or self-harm ideation psych disorder model}
# Reference category
dat_HI <- within(dat_HI,
              psych_disorder_factor <- relevel(factor(psych_disorder_factor),
                                    ref = "No"))

model_psych_disorder <- glm(NEW_harmful_ideation_pandemic ~  psych_disorder_factor +
              age_category_COVID_baseline +
                 sex_binary +
                 minoritised_gender +
                 race_binary +
                 vulnerable_group_member +
                  positive_covid_test_before_HI_final +
                 lost_someone_before_HI_final,
                 data = dat_HI,
                 family = "binomial"
              )

harmful_ideation_psych_disorder <- tidy(model_psych_disorder,
     conf.int=TRUE,
     exponentiate=TRUE)

fitted(model_psych_disorder) %>% 
  length()

harmful_ideation_psych_disorder
```

Check for Variance inflation factor estimate (VIF) - direct estimate of collinearity in dat_HIa
```{r check VIF Suicidal and/or self-harm ideation}
car::vif(model_psych_disorder)
```

```{r Suicidal and/or self-harm ideation employment model}
# Reference category
dat_HI <- within(dat_HI,
              paid_employment_key_worker <- relevel(factor(paid_employment_key_worker),
                                    ref = "Paid employment"))


model_employment <- glm(NEW_harmful_ideation_pandemic ~ paid_employment_key_worker + 
                          age_category_COVID_baseline +
                 sex_binary +
                 race_binary +
                 minoritised_gender +
                 psych_disorder_factor + 
                 vulnerable_group_member,
                 data = dat_HI,
                 family = "binomial"
              )

harmful_ideation_employment <- tidy(model_employment,
     conf.int=TRUE,
     exponentiate=TRUE)

fitted(model_employment) %>% 
  length()

harmful_ideation_employment
```

Check for Variance inflation factor estimate (VIF) - direct estimate of collinearity in dat_HIa
```{r check VIF Suicidal and/or self-harm ideation}
car::vif(model_employment)
```

```{r Suicidal and/or self-harm ideation vulnerable group member model}
# Reference category
dat_HI <- within(dat_HI,
              vulnerable_group_member <- relevel(factor(vulnerable_group_member),
                                    ref = "No"))

model_vulnerable_group_member <- glm(NEW_harmful_ideation_pandemic ~ vulnerable_group_member + 
                          age_category_COVID_baseline +
                 sex_binary,
                 data = dat_HI,
                 family = "binomial"
              )

harmful_ideation_vulnerable_group_member <- tidy(model_vulnerable_group_member,
     conf.int=TRUE,
     exponentiate=TRUE)

fitted(model_vulnerable_group_member) %>% 
  length()

harmful_ideation_vulnerable_group_member
```

Check for Variance inflation factor estimate (VIF) - direct estimate of collinearity in dat_HIa
```{r check VIF Suicidal and/or self-harm ideation}
car::vif(model_vulnerable_group_member)
```

```{r Suicidal and/or self-harm ideation pandemic worry model}
# Reference category
dat_HI <- within(dat_HI,
              panworry_factor <- relevel(factor(panworry_factor),
                                    ref = "0-20"))

model_panworry <- glm(NEW_harmful_ideation_pandemic ~ panworry_factor + 
                          age_category_COVID_baseline +
                   sex_binary +
                   race_binary +
                   psych_disorder_factor +
                   paid_employment_key_worker +
                   vulnerable_group_member +
                   positive_covid_test_before_HI_final,
                 data = dat_HI,
                 family = "binomial"
              )

harmful_ideation_panworry <- tidy(model_panworry,
     conf.int=TRUE,
     exponentiate=TRUE)

fitted(model_panworry) %>% 
  length()

harmful_ideation_panworry
```

Check for Variance inflation factor estimate (VIF) - direct estimate of collinearity in dat_HIa
```{r check VIF Suicidal and/or self-harm ideation}
car::vif(model_panworry)
```

```{r Suicidal and/or self-harm ideation loneliness model}
# Reference category
dat_HI <- within(dat_HI,
              increased_loneliness_during_pandemic <- relevel(factor(increased_loneliness_during_pandemic),
                                    ref = "No"))

model_loneliness <- glm(NEW_harmful_ideation_pandemic ~ increased_loneliness_during_pandemic +
                          age_category_COVID_baseline +
                     sex_binary +
                   psych_disorder_factor +
                   paid_employment_key_worker +
                   vulnerable_group_member +
                   panworry_factor +  
                   positive_covid_test_before_HI_final + 
                   lost_someone_before_HI_final + 
                   main_eco_change_before_HI_final + 
                 living_situation_change_before_HI_final, 
                 data = dat_HI,
                 family = "binomial"
              )

harmful_ideation_loneliness <- tidy(model_loneliness,
     conf.int=TRUE,
     exponentiate=TRUE)

fitted(model_loneliness) %>% 
  length()

harmful_ideation_loneliness
```

Check for Variance inflation factor estimate (VIF) - direct estimate of collinearity in dat_HIa
```{r check VIF Suicidal and/or self-harm ideation}
car::vif(model_loneliness)
```

```{r Suicidal and/or self-harm ideation lost someone model}
# Reference category
dat_HI <- within(dat_HI,
              lost_someone_before_HI_final <- relevel(factor(lost_someone_before_HI_final),
                                    ref = "No"))

model_loss <- glm(NEW_harmful_ideation_pandemic ~ lost_someone_before_HI_final + 
                   age_category_COVID_baseline +
                   sex_binary +
                   race_binary +
                   vulnerable_group_member,
                 data = dat_HI,
                 family = "binomial"
              )

harmful_ideation_loss <- tidy(model_loss,
     conf.int=TRUE,
     exponentiate=TRUE)

fitted(model_loss) %>% 
  length()

harmful_ideation_loss
```

Check for Variance inflation factor estimate (VIF) - direct estimate of collinearity in dat_HIa
```{r check VIF Suicidal and/or self-harm ideation}
car::vif(model_loss)
```

```{r Suicidal and/or self-harm ideation main eco change model}
# Reference category
dat_HI <- within(dat_HI,
              main_eco_change_before_HI_final <- relevel(factor(main_eco_change_before_HI_final),
                                    ref = "No"))


model_main_eco_change <- glm(NEW_harmful_ideation_pandemic ~ main_eco_change_before_HI_final + 
                   age_category_COVID_baseline +
                 sex_binary +
                 race_binary +
                 psych_disorder_factor + 
                 paid_employment_key_worker + 
                 vulnerable_group_member, 
                 data = dat_HI,
                 family = "binomial"
              )

harmful_ideation_main_eco_change <- tidy(model_main_eco_change,
     conf.int=TRUE,
     exponentiate=TRUE)

fitted(model_main_eco_change) %>% 
  length()

harmful_ideation_main_eco_change
```

Check for Variance inflation factor estimate (VIF) - direct estimate of collinearity in dat_HIa
```{r check VIF Suicidal and/or self-harm ideation}
car::vif(model_main_eco_change)
```

```{r Suicidal and/or self-harm ideation living situation change model}
# Reference category
dat_HI <- within(dat_HI,
              living_situation_change_before_HI_final <- relevel(factor(living_situation_change_before_HI_final),
                                    ref = "No"))

model_living_sit_change <- glm(NEW_harmful_ideation_pandemic ~ living_situation_change_before_HI_final +
                age_category_COVID_baseline +
                 sex_binary +
                 race_binary +
                 psych_disorder_factor + 
                 paid_employment_key_worker + 
                 vulnerable_group_member + 
                 panworry_factor +
                 main_eco_change_before_HI_final, 
                 data = dat_HI,
                 family = "binomial"
              )

harmful_ideation_living_sit_change <- tidy(model_living_sit_change,
     conf.int=TRUE,
     exponentiate=TRUE)

fitted(model_living_sit_change) %>% 
  length()

harmful_ideation_living_sit_change
```

Check for Variance inflation factor estimate (VIF) - direct estimate of collinearity in dat_HIa
```{r check VIF Suicidal and/or self-harm ideation}
car::vif(model_living_sit_change)
```

```{r Suicidal and/or self-harm ideation COVID19 illness model}
model_COVID19_illness <- glm(NEW_harmful_ideation_pandemic ~  positive_covid_test_before_HI_final +
                 age_category_COVID_baseline +
                 sex_binary +
                 race_binary +
                 paid_employment_key_worker + 
                 vulnerable_group_member +
                 panworry_factor + 
                 main_eco_change_before_HI_final + 
                 living_situation_change_before_HI_final, 
                 data = dat_HI,
                 family = "binomial"
              )

harmful_ideation_COVID19_illness <- tidy(model_COVID19_illness,
     conf.int=TRUE,
     exponentiate=TRUE)

fitted(model_COVID19_illness) %>% 
  length()

harmful_ideation_COVID19_illness
```

Check for Variance inflation factor estimate (VIF) - direct estimate of collinearity in dat_HIa
```{r check VIF Suicidal and/or self-harm ideation}
car::vif(model_COVID19_illness)
```

### Plot: Suicidal and/or self-harm ideation
```{r plot Suicidal and/or self-harm ideation regression results}
# Enter OR and CI data. boxOdds are the odds ratios, 
# boxCILow is the lower bound of the CI, boxCIHigh is the upper bound.

## All results
df <- data.frame(labels = c("Age: 16-25 years",
              "Age: 26-35 years",
              "Age: 36-45 years",
              "Age: 56-65 years",
              "Age: 66-70 years",
              "Age: 71+ years",
              "Female",
              "Racially minoritised",
              "Minoritised gender",
              "Psychiatric disorder",
              "Employment: Key worker",
              "Employment: Not in paid employment",
              "Employment: Retired",
              "Employment: Student",
              "Vulnerable group member",
              "Pandemic worry score: 21-40",
              "Pandemic worry score: 41-60",
              "Pandemic worry score: 61-80",
              "Increased loneliness during pandemic",
              "Lost someone due to COVID-19",
              "Change in main economic activity",
              "Change in living situation",
              "COVID-19 illness and/or positive test"),
                 boxOdds = c(1.9024189 ,
                             1.3262505 ,
                             1.0652464 ,
                             0.9082296 ,
                             0.6455501 ,
                             0.6679875 ,
                             1.9513268 ,
                             1.663737 ,
                             3.6607133 ,
                             4.611234 ,
                             0.9715412 ,
                             1.398475,
                             0.9955501,
                             1.0313477,
                             1.1742402,
                             1.58315859,
                             2.55200157,
                             3.84364618,
                             1.29425594,
                             0.7030271,
                             1.16745834,
                             0.7079266,
                             0.2447691),
                 boxCILow = c(1.6356095 ,
                              1.1692475 ,
                              0.9397251 ,
                              0.8212002 ,
                              0.5653978 ,
                              0.5847655 ,
                              1.8056117 ,
                              1.3903722 ,
                              2.4300825 ,
                              4.2311885 ,
                              0.8803647,
                              1.2017025,
                              0.8696674,
                              0.7915089,
                              1.0751058,
                              1.43221367,
                              2.22804482,
                              2.51963995,
                              1.1784766,
                              0.5978125,
                              1.06539463,
                              0.63074242,
                              0.17424411),
                 boxCIHigh = c(2.2110687  ,
                               1.5035999,
                               1.206754,
                               1.0047036,
                               0.7360596,
                               0.7620113,
                               2.1101834,
                               1.984573,
                               5.5481494,
                               5.0283814,
                               1.072409,
                               1.6262449,
                               1.1399522,
                               1.3403691,
                               1.2818872,
                               1.75142699,
                               2.92356376,
                               5.89873099,
                               1.42111361,
                               0.8228782,
                               1.2792855,
                               0.79329648,
                               0.3339375
                               ))

## Significant results
df_sig <- data.frame(labels_sig = c("Age: 16-25 years",
              "Age: 26-35 years",
              "Age: 66-70 years",
              "Age: 71+ years",
              "Female",
              "Racially minoritised",
              "Minoritised gender",
              "Psychiatric disorder",
              "Employment: Not in paid employment",
              "Vulnerable group member",
              "Pandemic worry score: 21-40",
              "Pandemic worry score: 41-60",
              "Pandemic worry score: 61-80",
              "Increased loneliness during pandemic",
              "Lost someone due to COVID-19",
              "Change in main economic activity",
              "Change in living situation",
              "COVID-19 illness and/or positive test"
              ),
                 boxOdds_sig = c(1.9024189 ,
                                 1.3262505,
                                 0.6455501,
                                 0.6679875,
                                 1.9513268,
                                 1.663737,
                                 3.6607133,
                                 4.611234,
                                 1.398475,
                                 1.1742402,
                                 1.58315859,
                                 2.55200157,
                                 3.84364618,
                                 1.29425594,
                                 0.7030271,
                                 1.16745834,
                                 0.7079266,
                                 0.2447691),
                 boxCILow_sig = c(1.6356095  ,
                                  1.1692475,
                                  0.5653978,
                                  0.5847655,
                                  1.8056117,
                                  1.3903722,
                                  2.4300825,
                                  4.2311885,
                                  1.2017025,
                                  1.0751058,
                                  1.43221367,
                                  2.22804482,
                                  2.51963995,
                                  1.1784766,
                                  0.5978125,
                                  1.06539463,
                                  0.63074242,
                                  0.17424411),
                 boxCIHigh_sig = c(2.2110687  ,
                                   1.5035999,
                                   0.7360596,
                                   0.7620113,
                                   2.1101834,
                                   1.984573,
                                   5.5481494,
                                   5.0283814,
                                   1.6262449,
                                   1.2818872,
                                   1.75142699,
                                   2.92356376,
                                   5.89873099,
                                   1.42111361,
                                   0.8228782,
                                   1.2792855,
                                   0.79329648,
                                   0.3339375
                               ))

# Lock in factor level order
df$labels <- factor(df$labels,
                   levels = df$labels)

df_sig$labels_sig <- factor(df_sig$labels_sig,
                   levels = df_sig$labels_sig)

# Plot
HI_plot <- ggplot(df,
             aes(x = boxOdds,
                 y = labels)) + 
    geom_vline(aes(xintercept = 1),
               size = .25,
               linetype = "dashed") + 
    geom_errorbarh(aes(xmax = boxCIHigh,
                       xmin = boxCILow),
                   size = .5,
                   height = .2,
                   color = "gray50") +
    geom_point(size = 2,
               color = "gray50") + # non-significant
    scale_y_discrete(limits=rev) +
    geom_point(data=df_sig, 
             aes(x=boxOdds_sig,
                 y=labels_sig), 
             color='#86cfe2', # significant
             size=2) +
    scale_x_continuous(breaks = seq(from = 0.1,
                                         to = 6.5,
                                         by = 0.2), 
                       labels = seq(0.1,
                                    6.5,
                                    0.2),
                       limits = c(0.1,
                                  6.5)) +
    theme_bw()+
    theme(panel.grid.minor = element_blank()) +
    ylab("") +
    xlab("Odds ratio") + 
    ggtitle("New onset suicidal and/or self-harm ideation during the pandemic") 

HI_plot # colour sig ones differently!

ggsave(
  paste0("HI_plot",
                    date,
                    ".png"),
  plot = HI_plot,
  device = "png", 
  path = paste0(filepath_plots_main_regressions), 
  scale = 1,
  width = 30,
  height = 15,
  units = "cm"
  )
```

## Self-harm
```{r self-harm age model}
# Reference category
dat <- within(dat,
              age_category_COVID_baseline <- relevel(age_category_COVID_baseline,
                                                     ref = "46-55"))

model_age <- glm(NEW_selfharm_pandemic ~  
                 age_category_COVID_baseline,
                 data = dat,
                 family = "binomial"
              )

selfharm_age <- tidy(model_age,
     conf.int=TRUE,
     exponentiate=TRUE)

fitted(model_age) %>% 
  length()

selfharm_age
```

```{r self-harm sex extended model}
# Reference category
dat <- within(dat,
              sex_binary <- relevel(factor(sex_binary),
                                    ref = "Male"))

model_sex <- glm(NEW_selfharm_pandemic ~  
                 sex_binary,
                 data = dat,
                 family = "binomial"
              )

selfharm_sex <- tidy(model_sex,
     conf.int=TRUE,
     exponentiate=TRUE)

fitted(model_sex) %>% 
  length()

selfharm_sex
```
```{r self-harm race extended model}
# Reference category
dat <- within(dat,
              race_binary <- relevel(factor(race_binary),
                                    ref = "White"))

model_race <- glm(NEW_selfharm_pandemic ~  
                 race_binary,
                 data = dat,
                 family = "binomial"
              )

selfharm_race <- tidy(model_race,
     conf.int=TRUE,
     exponentiate=TRUE)

fitted(model_race) %>% 
  length()

selfharm_race
```

```{r self-harm gender model}
# Reference category
dat <- within(dat,
              minoritised_gender <- relevel(factor(minoritised_gender),
                                    ref = "No"))


model_gender <- glm(NEW_selfharm_pandemic ~   minoritised_gender +
                   age_category_COVID_baseline,
                 data = dat,
                 family = "binomial"
              )

selfharm_gender <- tidy(model_gender,
     conf.int=TRUE,
     exponentiate=TRUE)

fitted(model_gender) %>% 
  length()

selfharm_gender
```

Check for Variance inflation factor estimate (VIF) - direct estimate of collinearity in data
```{r check VIF self-harm}
car::vif(model_gender)
```

```{r self-harm psych disorder model}
# Reference category
dat <- within(dat,
              psych_disorder_factor <- relevel(factor(psych_disorder_factor),
                                    ref = "No"))

model_psych_disorder <- glm(NEW_selfharm_pandemic ~  psych_disorder_factor +
              age_category_COVID_baseline +
                 sex_binary +
                 minoritised_gender +
                 race_binary +
                 vulnerable_group_member +
                  positive_covid_test_before_SH_final +
                 lost_someone_before_SH_final,
                 data = dat,
                 family = "binomial"
              )

selfharm_psych_disorder <- tidy(model_psych_disorder,
     conf.int=TRUE,
     exponentiate=TRUE)

fitted(model_psych_disorder) %>% 
  length()

selfharm_psych_disorder
```

Check for Variance inflation factor estimate (VIF) - direct estimate of collinearity in data
```{r check VIF self-harm}
car::vif(model_psych_disorder)
```

```{r self-harm employment model}
# Reference category
dat <- within(dat,
              paid_employment_key_worker <- relevel(factor(paid_employment_key_worker),
                                    ref = "Paid employment"))


model_employment <- glm(NEW_selfharm_pandemic ~ paid_employment_key_worker + 
                          age_category_COVID_baseline +
                 sex_binary +
                 race_binary +
                 minoritised_gender +
                 psych_disorder_factor + 
                 vulnerable_group_member,
                 data = dat,
                 family = "binomial"
              )

selfharm_employment <- tidy(model_employment,
     conf.int=TRUE,
     exponentiate=TRUE)

fitted(model_employment) %>% 
  length()

selfharm_employment
```

Check for Variance inflation factor estimate (VIF) - direct estimate of collinearity in data
```{r check VIF self-harm}
car::vif(model_employment)
```

```{r self-harm vulnerable group member model}
# Reference category
dat <- within(dat,
              vulnerable_group_member <- relevel(factor(vulnerable_group_member),
                                    ref = "No"))

model_vulnerable_group_member <- glm(NEW_selfharm_pandemic ~ vulnerable_group_member + 
                          age_category_COVID_baseline +
                 sex_binary,
                 data = dat,
                 family = "binomial"
              )

selfharm_vulnerable_group_member <- tidy(model_vulnerable_group_member,
     conf.int=TRUE,
     exponentiate=TRUE)

fitted(model_vulnerable_group_member) %>% 
  length()

selfharm_vulnerable_group_member
```

Check for Variance inflation factor estimate (VIF) - direct estimate of collinearity in data
```{r check VIF self-harm}
car::vif(model_vulnerable_group_member)
```

```{r self-harm pandemic worry model}
# Reference category
dat <- within(dat,
              panworry_factor <- relevel(factor(panworry_factor),
                                    ref = "0-20"))

model_panworry <- glm(NEW_selfharm_pandemic ~ panworry_factor + 
                          age_category_COVID_baseline +
                   sex_binary +
                   race_binary +
                   psych_disorder_factor +
                   paid_employment_key_worker +
                   vulnerable_group_member +
                   positive_covid_test_before_SH_final,
                 data = dat,
                 family = "binomial"
              )

selfharm_panworry <- tidy(model_panworry,
     conf.int=TRUE,
     exponentiate=TRUE)

fitted(model_panworry) %>% 
  length()

selfharm_panworry
```

Check for Variance inflation factor estimate (VIF) - direct estimate of collinearity in data
```{r check VIF self-harm}
car::vif(model_panworry)
```

```{r self-harm loneliness model}
# Reference category
dat <- within(dat,
              increased_loneliness_during_pandemic <- relevel(factor(increased_loneliness_during_pandemic),
                                    ref = "No"))

model_loneliness <- glm(NEW_selfharm_pandemic ~ increased_loneliness_during_pandemic +
                          age_category_COVID_baseline +
                     sex_binary +
                   psych_disorder_factor +
                   paid_employment_key_worker +
                   vulnerable_group_member +
                   panworry_factor +  
                   positive_covid_test_before_SH_final + 
                   lost_someone_before_SH_final + 
                   main_eco_change_before_SH_final + 
                 living_situation_change_before_SH_final, 
                 data = dat,
                 family = "binomial"
              )

selfharm_loneliness <- tidy(model_loneliness,
     conf.int=TRUE,
     exponentiate=TRUE)

fitted(model_loneliness) %>% 
  length()

selfharm_loneliness
```

Check for Variance inflation factor estimate (VIF) - direct estimate of collinearity in data
```{r check VIF self-harm}
car::vif(model_loneliness)
```

```{r self-harm lost someone model}
# Reference category
dat <- within(dat,
              lost_someone_before_SH_final <- relevel(factor(lost_someone_before_SH_final),
                                    ref = "No"))

model_loss <- glm(NEW_selfharm_pandemic ~ lost_someone_before_SH_final + 
                   age_category_COVID_baseline +
                   sex_binary +
                   race_binary +
                   vulnerable_group_member,
                 data = dat,
                 family = "binomial"
              )

selfharm_loss <- tidy(model_loss,
     conf.int=TRUE,
     exponentiate=TRUE)

fitted(model_loss) %>% 
  length()

selfharm_loss
```

Check for Variance inflation factor estimate (VIF) - direct estimate of collinearity in data
```{r check VIF self-harm}
car::vif(model_loss)
```

```{r self-harm main eco change model}
# Reference category
dat <- within(dat,
              main_eco_change_before_SH_final <- relevel(factor(main_eco_change_before_SH_final),
                                    ref = "No"))


model_main_eco_change <- glm(NEW_selfharm_pandemic ~ main_eco_change_before_SH_final + 
                   age_category_COVID_baseline +
                 sex_binary +
                 race_binary +
                 psych_disorder_factor + 
                 paid_employment_key_worker + 
                 vulnerable_group_member, 
                 data = dat,
                 family = "binomial"
              )

selfharm_main_eco_change <- tidy(model_main_eco_change,
     conf.int=TRUE,
     exponentiate=TRUE)

fitted(model_main_eco_change) %>% 
  length()

selfharm_main_eco_change
```

Check for Variance inflation factor estimate (VIF) - direct estimate of collinearity in data
```{r check VIF self-harm}
car::vif(model_main_eco_change)
```

```{r self-harm living situation change model}
# Reference category
dat <- within(dat,
              living_situation_change_before_SH_final <- relevel(factor(living_situation_change_before_SH_final),
                                    ref = "No"))

model_living_sit_change <- glm(NEW_selfharm_pandemic ~ living_situation_change_before_SH_final +
                age_category_COVID_baseline +
                 sex_binary +
                 race_binary +
                 psych_disorder_factor + 
                 paid_employment_key_worker + 
                 vulnerable_group_member + 
                 panworry_factor +
                 main_eco_change_before_SH_final, 
                 data = dat,
                 family = "binomial"
              )

selfharm_living_sit_change <- tidy(model_living_sit_change,
     conf.int=TRUE,
     exponentiate=TRUE)

fitted(model_living_sit_change) %>% 
  length()

selfharm_living_sit_change
```

Check for Variance inflation factor estimate (VIF) - direct estimate of collinearity in data
```{r check VIF self-harm}
car::vif(model_living_sit_change)
```

```{r self-harm COVID19 illness model}
model_COVID19_illness <- glm(NEW_selfharm_pandemic ~  positive_covid_test_before_SH_final +
                 age_category_COVID_baseline +
                 sex_binary +
                 race_binary +
                 paid_employment_key_worker + 
                 vulnerable_group_member +
                 panworry_factor + 
                 main_eco_change_before_SH_final + 
                 living_situation_change_before_SH_final, 
                 data = dat,
                 family = "binomial"
              )

selfharm_COVID19_illness <- tidy(model_COVID19_illness,
     conf.int=TRUE,
     exponentiate=TRUE)

fitted(model_COVID19_illness) %>% 
  length()

selfharm_COVID19_illness
```

Check for Variance inflation factor estimate (VIF) - direct estimate of collinearity in data
```{r check VIF self-harm}
car::vif(model_COVID19_illness)
```

### Plot: Self-harm
```{r plot self-harm  regression results}
# Enter OR and CI data. boxOdds are the odds ratios, 
# boxCILow is the lower bound of the CI, boxCIHigh is the upper bound.

## All results
df <- data.frame(labels = c("Age: 16-25 years",
              "Age: 26-35 years",
              "Age: 36-45 years",
              "Age: 56-65 years",
              "Age: 66-70 years",
              "Age: 71+ years",
              "Female",
              "Racially minoritised",
              "Minoritised gender",
              "Psychiatric disorder",
              "Employment: Key worker",
              "Employment: Not in paid employment",
              "Employment: Retired",
              "Employment: Student",
              "Vulnerable group member",
              "Pandemic worry score: 21-40",
              "Pandemic worry score: 41-60",
              "Pandemic worry score: 61-80",
              "Increased loneliness during pandemic",
              "Lost someone due to COVID-19",
              "Change in main economic activity",
              "Change in living situation",
              "COVID-19 illness and/or positive test"),
                 boxOdds = c(2.641201  ,
                             1.92692041,
                             1.21426285,
                             0.66020448,
                             0.50049175,
                             0.42883885,
                             1.50347086,
                             1.40229773,
                             2.07629202,
                             2.66629642,
                             1.03461507,
                             1.54226727,
                             0.99062059,
                             1.34303705,
                             1.2588142,
                             1.23914124,
                             1.77201665,
                             2.75688316,
                             1.18220342,
                             1.20694897,
                             1.2155411,
                             1.06669158,
                             0.61387184),
                 boxCILow = c(2.13267361  ,
                              1.58645704,
                              0.9837557,
                              0.54133227,
                              0.37190418,
                              0.31031853,
                              1.30449128,
                              1.0322114,
                              1.30268689,
                              2.25019244,
                              0.87776934,
                              1.2437948,
                              0.7490269,
                              0.96357734,
                              1.07844767,
                              1.0242675,
                              1.4200628,
                              1.7074609,
                              1.014894773,
                              0.94655754,
                              1.05091377,
                              0.90296488,
                              0.40270193),
                 boxCIHigh = c(3.26395629,
                               2.34003926,
                               1.49549559,
                               0.80444411,
                               0.66338877,
                               0.58092385,
                               1.7384979,
                               1.86054471,
                               3.15460782,
                               3.17463867,
                               1.221608,
                               1.9067175,
                               1.3076114,
                               1.8529976,
                               1.46427271,
                               1.50765124,
                               2.21794459,
                               4.29364683,
                               1.37665056,
                               1.51809616,
                               1.40688164,
                               1.2552246,
                               0.89340949
                               ))

## Significant results
df_sig <- data.frame(labels_sig = c("Age: 16-25 years",
              "Age: 26-35 years",
              "Age: 56-65 years",
              "Age: 66-70 years",
              "Age: 71+ years",
              "Female",
              "Minoritised gender",
              "Psychiatric disorder",
              "Employment: Not in paid employment",
              "Vulnerable group member",
              "Pandemic worry score: 41-60",
              "Pandemic worry score: 61-80"
              ),
                 boxOdds_sig = c(2.641201  ,
                                 1.92692041,
                                 0.66020448,
                                 0.50049175,
                                 0.42883885,
                                 1.50347086,
                                 2.07629202,
                                 2.66629642,
                                 1.54226727,
                                 1.2588142,
                                 1.77201665,
                                 2.75688316
                                 ),
                 boxCILow_sig = c(2.13267361 ,
                                  1.58645704,
                                  0.54133227,
                                  0.37190418,
                                  0.31031853,
                                  1.30449128,
                                  1.30268689,
                                  2.25019244,
                                  1.2437948,
                                  1.07844767,
                                  1.4200628,
                                  1.7074609),
              boxCIHigh_sig = c(3.26395629,
                                2.34003926,
                                0.80444411,
                                0.66338877,
                                0.58092385,
                                1.7384979,
                                3.15460782,
                                3.17463867,
                                1.9067175,
                                1.46427271,
                                2.21794459,
                                4.29364683
                               ))

# Lock in factor level order
df$labels <- factor(df$labels,
                   levels = df$labels)

df_sig$labels_sig <- factor(df_sig$labels_sig,
                   levels = df_sig$labels_sig)

# Plot
SH_plot <- ggplot(df,
             aes(x = boxOdds,
                 y = labels)) + 
    geom_vline(aes(xintercept = 1),
               size = .25,
               linetype = "dashed") + 
    geom_errorbarh(aes(xmax = boxCIHigh,
                       xmin = boxCILow),
                   size = .5,
                   height = .2,
                   color = "gray50") +
    geom_point(size = 2,
               color = "gray50") + # non-significant
    scale_y_discrete(limits=rev) +
    geom_point(data=df_sig, 
             aes(x=boxOdds_sig,
                 y=labels_sig), 
             color='#86cfe2', # significant
             size=2) +
    scale_x_continuous(breaks = seq(from = 0.2,
                                         to = 6.5,
                                         by = 0.2), 
                       labels = seq(0.2,
                                    6.5,
                                    0.2),
                       limits = c(0.2,
                                  6.5)) +
    theme_bw()+
    theme(panel.grid.minor = element_blank()) +
    ylab("") +
    xlab("Odds ratio") + 
    ggtitle("New onset self-harm during the pandemic") 

SH_plot # colour sig ones differently!

ggsave(
  paste0("SH_plot",
                    date,
                    ".png"),
  plot = SH_plot,
  device = "png", 
  path = paste0(filepath_plots_main_regressions), 
  scale = 1,
  width = 30,
  height = 15,
  units = "cm"
  )
```


# Save environment
Need this to run correlations with OR of other sensitivity analysis (i.e., exposure ONLY before outcome and not in same phase)
```{r save environment}
save.image(file='COVID_main_analysis_regressions.RData')
```

