---
title: "OCD screener"
author: "Helena Davies"
date: "05/08/2021"
output: html_document
---

Configure global options for all chunks
```{r Setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  comment = '',
  prompt = FALSE,
  cache = FALSE
  )
```

Clear global environment prior to initiation
```{r Clear global environment}
remove(list = ls())
```

Add the add_numeric function - used to convert character variables into numeric variables
Add the remove_duplicates function - used to deduplicate and remove NAs from IDs
Add the sumscores function - used to generate sumscores
Add the package_check function - used to install and load dependencies
Add the imp_check function - used to check variables for implausible values
```{r Read in functions}
source(file = "/Users/helenadavies/werk/ilovedata/scripts/functions/add_numeric.R")
source(file = "/Users/helenadavies/werk/ilovedata/scripts/functions/remove_duplicates.R")
source(file = "/Users/helenadavies/werk/ilovedata/scripts/functions/package_check.R")
source("./functions.R")
```

Use package_check to install and load dependencies
Load tidyverse last
```{r Install load dependencies}
packages <- c("summarytools", "sjlabelled", "Amelia", "gtsummary", "tidyverse")
package_check(packages)
```

Retrieve recent date
We are using the recent date to save files with paste0() as an extension to not overwrite old versions
```{r Recent date}
date <- Sys.Date()
date
```

# Read in the data: OCD screener 
## GLAD data
```{r GLAD read in data}
glad_dat <- readRDS(file =   "/Users/helenadavies/King's College London/MT-TNG BioResource EDIT - ilovedata - ilovedata/data_raw/latest_freeze/coping_glad_opt/ocd_coping_glad_opt.rds")
# Check
glad_dat %>%
  colnames()
glad_dat %>%
  dim()
```

```{r exclude cols}
exclude_cols <- c("ID",
                  "sample")
```

Select & rename relevant columns (will be a function at some point)
```{r GLAD select}
glad_dat.id <- glad_dat %>% #new dataset with ID
  drop_na(externalDataReference) %>% # Drop NAs
  remove_duplicates("externalDataReference") %>% 
  add_column(sample = "GLAD", .after = "externalDataReference") %>% # Create new sample column
  select(
         ID = externalDataReference,# ID
         sample,
         ocd.strong_urges_urges_dirt = ocd.strong_urges_germs_thoughts,
         ocd.feeling_driven_mental_acts
  ) %>%
  add_numeric(exclude = exclude_cols) 
# Inspect colnames
colnames(glad_dat.id)

glad_dat.id %>%
  dim()
```

## EDGI data
```{r edgi read in data}
edgi_dat <- readRDS(file = "/Users/helenadavies/King's College London/MT-TNG BioResource EDIT - ilovedata - ilovedata/data_raw/latest_freeze/coping_edgi_opt/ocd_coping_edgi_opt.rds")
# Check
edgi_dat %>%
  colnames()
edgi_dat %>%
  dim()
```

Select & rename relevant columns (will be a function at some point)
```{r edgi select}
edgi_dat.id <- edgi_dat %>% #new dataset with ID
  drop_na(externalDataReference) %>% # Drop NAs
  remove_duplicates("externalDataReference") %>% 
  add_column(sample = "EDGI", .after = "externalDataReference") %>% # Create new sample column
  select(
         ID = externalDataReference,# ID
         sample,
         ocd.strong_urges_urges_dirt = ocd.strong_urges_germs_thoughts,
         ocd.feeling_driven_mental_acts
  ) %>%
  add_numeric(exclude = exclude_cols) 
# Inspect colnames
colnames(edgi_dat.id)

edgi_dat.id %>%
  dim()
```

## NBR data
```{r NBR read in data}
nbr_dat <- readRDS(file = "/Users/helenadavies/King's College London/MT-TNG BioResource EDIT - ilovedata - ilovedata/data_raw/latest_freeze/coping_nbr_opt/ocd_coping_nbr_opt.rds")

# Check
nbr_dat %>%
  colnames()
nbr_dat %>%
  dim()
```

Select & rename relevant columns (will be a function at some point)
```{r NBR select}
nbr_dat.id <- nbr_dat %>% #new dataset with ID
  drop_na(externalDataReference) %>% # Drop NAs
  remove_duplicates("externalDataReference") %>% 
  add_column(sample = "NBR", .after = "externalDataReference") %>% # Create new sample column
  select(
         ID = externalDataReference,# ID
         sample,
         ocd.strong_urges_urges_dirt = ocd.strong_urges_germs_thoughts,
         ocd.feeling_driven_mental_acts
  ) %>%
  add_numeric(exclude = exclude_cols) 
# Inspect colnames
colnames(nbr_dat.id)

nbr_dat.id %>%
  dim()
```

## RAMP data
```{r RAMP read in data}
ramp_dat <- readRDS(file = "/Users/helenadavies/King's College London/MT-TNG BioResource EDIT - ilovedata - ilovedata/data_raw/latest_freeze/ramp/ocd_ramp.rds")
  
# Check
ramp_dat %>%
  colnames()
ramp_dat %>%
  dim()
```

Select & rename relevant columns (will be a function at some point)
```{r RAMP select}
exclude_cols <- c("ID",
                  "sample")
ramp_dat.id <- ramp_dat %>% #new dataset with ID
  drop_na('Login ID') %>% # Drop NAs
  remove_duplicates("Login ID") %>% 
  add_column(sample = "RAMP", .after = 'Login ID') %>% # Create new sample column
  select(
         ID = externalDataReference,# ID
         sample,
         ocd.strong_urges_urges_dirt = ocd.strong_urges_germs_thoughts,
         ocd.feeling_driven_mental_acts
  ) %>%
  add_numeric(exclude = exclude_cols) 
# Inspect colnames
colnames(ramp_dat.id)

ramp_dat.id %>%
  dim()
```

# Merge data
```{r}
dat <- nbr_dat.id %>%
  rbind(glad_dat.id,
        edgi_dat.id, 
        ramp_dat.id)

# Check
dat %>%
  colnames()

dat %>%
  nrow()
```

# Recoding variables

## Unpleasant thoughts, urges, images in mind
Q: Over the past two weeks, how often have you been bothered by unpleasant thoughts, urges, or images that repeatedly enter your mind?e.g. thoughts about dirt or germs, thoughts about harm coming to yourself or others, strong urges for things to be ordered or symmetrical)
```{r Freq}
dat %>%
  freq(ocd.strong_urges_urges_dirt)

dat <- dat %>%
  mutate(ocd.repetitive_unpleasant_thoughts_binary =
           case_when(
             ocd.strong_urges_urges_dirt == "Seen but not answered" |
               is.na(ocd.strong_urges_urges_dirt) ~ NA_character_,
             
             ocd.strong_urges_urges_dirt == "Not at all" ~ "No",
             
             TRUE ~ "Yes"
             
           ))

# Check new binary variable
dat %>%
  freq(ocd.repetitive_unpleasant_thoughts_binary)
```

## Compulsive behaviour or mental act
Q: Over the past two weeks, how often have you been bothered by feeling driven to perform certain behaviours or mental acts over and over again?
```{r Freq}
dat %>%
  freq(ocd.feeling_driven_mental_acts)

dat <- dat %>%
  mutate(ocd.compulsive_beh_mental_act_binary =
           case_when(
             ocd.feeling_driven_mental_acts == "Seen but not answered" |
               is.na(ocd.feeling_driven_mental_acts) ~ NA_character_,
             
             ocd.feeling_driven_mental_acts == "Not at all" ~ "No",
             
             TRUE ~ "Yes"
             
           ))

# Check new binary variable
dat %>%
  freq(ocd.compulsive_beh_mental_act_binary)

```
# Select variables for final dataset
```{r Select columns to save}
dat_final <- dat %>%
  select(ID,
         sample,
         ocd.strong_urges_urges_dirt,
         ocd.feeling_driven_mental_acts,
         ocd.repetitive_unpleasant_thoughts_binary,
         ocd.compulsive_beh_mental_act_binary,
  )
```

# Save dataset
```{r Save dataset}
saveRDS(object = dat_final, file = paste0("/Users/helenadavies/werk/EDBEHSELFHARM2/gitEDBEHSELFHARM/data_cleaned/OCD_screener", date, ".rds"))

```

