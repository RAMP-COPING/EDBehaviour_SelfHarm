---
title: "COPING ED algorithms"
author: "Helena Davies"
date: "22/03/2021"
output: html_document
---

```{r Setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      comment=NA,
                      prompt=FALSE,
                      cache=FALSE)
```

Delete everything in your global environment
```{r Delete everything in your global environment}
remove(list = ls())
```

#### Call in library script

```{r source files}
source("./libraries.R")
```

#### Call in functions script

```{r source files}
source("./functions.R")
```

## Read in data - BE ED100K GLAD
```{r Read in data}

BE_symptom_data_GLAD <- readRDS(file = "../data_raw/glad/be_glad_ed.rds") #Add your data file here

```

#Select columns
```{r Read in data}

exclude_cols_dem <- c("externalDataReference",
                      "cohort_name")

BE_symptom_data_GLAD.id <- BE_symptom_data_GLAD  %>% 
  drop_na(externalDataReference) %>% # Drop NAs
  distinct(externalDataReference, .keep_all = TRUE)  %>%
  add_column(cohort_name = "glad", .before = "be.short_period_ate_regard") %>% #create new column 
  select(
         ID = externalDataReference,# ID
         cohort_name, # Sample
         be.short_period_ate_regard,
         be.binge_eating_stop_eating,
         be.binge_eating_episodes_experience.txt,
         be.long_experience_regularly_occurring,
         be.long_experience_regularly_occurring.1,
         be.began_roughly_regular_episodes.txt,
         be.feel_distressed_episodes_eating,
         be.not_at_all_dependentcompletely_dependent,
         be.experience_regular_episodes_lowest,
         be.binge_eating_distressed_make,
         be.a_eat_much_more_rapidly_than_usual,
         be.a_eat_much_more_rapidly_than_usual.1,
         be.a_eat_much_more_rapidly_than_usual.2,
         be.b_eat_until_you_felt_uncomfortably_full,
         be.b_eat_until_you_felt_uncomfortably_full.1,
         be.rapidly_usual_eat,
         be.eat_felt_uncomfortably_full,
         be.didn39_food_eat_large,
         be.embarrassed_eat_eating.3,
         be.feel_ashamed_disgusted_guilty.3,
         be.control_feel_eating,
         be.shape_means_make_control,
         be.binge_eating_experience_episodes.txt,
         be.binge_eating_experience_episodes.txt.1,
         be.binge_eating_stopped_regular) %>%
    add_numeric(., exclude = exclude_cols_dem) %>%
mutate_if(is.numeric, ~na_if(., -88)) %>% # Recode missing values to NAs in numeric variables
  mutate_if(is.numeric, ~na_if(., -99)) %>%
  mutate_if(is.numeric, ~na_if(., -77)) %>%
  mutate_if(is.factor, ~na_if(., "Seen but not answered")) %>% # Recode missing values to NAs in factor variables
  mutate_if(is.factor, ~na_if(., "Don't know")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to say")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Seen but not answered")) %>% # Drop empty factor levels
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Don't know")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to say"))

# Inspect dimensions
dim(BE_symptom_data_GLAD.id)
# Inspect colnames
colnames(BE_symptom_data_GLAD.id)
#Differences
dim(BE_symptom_data_GLAD.id)[1]-dim(BE_symptom_data_GLAD.id)[1]

```

## Read in data - BE ED100K EDGI
```{r Read in data}

BE_symptom_data_EDGI <- readRDS(file = "../data_raw/edgi/be_edgi.rds") #Add your data file here

colnames(BE_symptom_data_EDGI)
```

## Select columns
```{r Read in data}

exclude_cols_dem <- c("externalDataReference",
                      "cohort_name")

BE_symptom_data_EDGI.id <- BE_symptom_data_EDGI %>% 
  drop_na(externalDataReference) %>% # Drop NAs
  distinct(externalDataReference, .keep_all = TRUE)  %>%
  add_column(cohort_name = "edgi", .before = "be.short_period_ate_regard") %>% #create new column 
  select(
         ID = externalDataReference,# ID
         cohort_name, # Sample
         be.short_period_ate_regard,
         be.binge_eating_stop_eating,
         be.binge_eating_episodes_experience.txt = be.follow_binge_eating_question.txt,
         be.long_experience_regularly_occurring,
         be.long_experience_regularly_occurring.1,
         be.began_roughly_regular_episodes.txt,
         be.feel_distressed_episodes_eating = be.feel_distressed_overeating_episodes,
         be.not_at_all_dependentcompletely_dependent,
         be.experience_regular_episodes_lowest,
         be.binge_eating_distressed_make,
         be.a_eat_much_more_rapidly_than_usual,
         be.a_eat_much_more_rapidly_than_usual.1,
         be.a_eat_much_more_rapidly_than_usual.2,
         be.b_eat_until_you_felt_uncomfortably_full,
         be.b_eat_until_you_felt_uncomfortably_full.1,
         be.rapidly_usual_eat,
         be.eat_felt_uncomfortably_full,
         be.didn39_food_eat_large,
         be.embarrassed_eat_eating.3,
         be.feel_ashamed_disgusted_guilty.3,
         be.control_feel_eating,
         be.shape_means_make_control,
         be.binge_eating_experience_episodes.txt.1 = be.binge_eating_experience_episodes.txt, 
         be.binge_eating_experience_episodes.txt = be.follow_binge_eating_question.txt.1,
         be.binge_eating_stopped_regular) %>%
    add_numeric(., exclude = exclude_cols_dem) %>%
mutate_if(is.numeric, ~na_if(., -88)) %>% # Recode missing values to NAs in numeric variables
  mutate_if(is.numeric, ~na_if(., -99)) %>%
  mutate_if(is.numeric, ~na_if(., -77)) %>%
  mutate_if(is.factor, ~na_if(., "Seen but not answered")) %>% # Recode missing values to NAs in factor variables
  mutate_if(is.factor, ~na_if(., "Don't know")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to say")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Seen but not answered")) %>% # Drop empty factor levels
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Don't know")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to say"))

# Inspect dimensions
dim(BE_symptom_data_EDGI.id)
# Inspect colnames
colnames(BE_symptom_data_EDGI.id)
#Differences
dim(BE_symptom_data_EDGI.id)[1]-dim(BE_symptom_data_EDGI.id)[1]

```

##Merge GLAD and EDGI BE data
```{r}
dat.be <- rbind(BE_symptom_data_EDGI.id,
                   BE_symptom_data_GLAD.id
                )

##colnames 
colnames(dat.be)

##number of people
nrow(dat.be)
```
## Read in data - ICB ED100K GLAD
```{r Read in data}

ICB_symptom_data_GLAD <- readRDS(file = "../data_raw/glad/icb_glad_ed.rds") #Add your data file here
```

##Select columns
```{r Read in data}

exclude_cols_dem <- c("externalDataReference")

ICB_symptom_data_GLAD.id <- ICB_symptom_data_GLAD %>% 
  drop_na(externalDataReference) %>% # Drop NAs
  distinct(externalDataReference, .keep_all = TRUE)  %>%
  add_column(cohort_name = "glad", .before = "icb.b_used_laxatives") %>% #create new column 
  select(
         ID = externalDataReference,# ID
         cohort_name, # Sample
         icb.b_used_laxatives,
         icb.b_used_laxatives.1,
         icb.b_used_laxatives.2, 
         icb.a_made_yourself_vomit,
         icb.a_made_yourself_vomit.1,
         icb.a_made_yourself_vomit.2,
         icb.engage_fasting_time_period,
         icb.engage_fasting_time_period.1,
         icb.fasted_time.txt,
         icb.time_diet_pills.txt,
         icb.long_time_period_diet,
         icb.long_time_period_diet.1,
         icb.body_shape_felt_compelled,
         icb.felt_uneasy_unable_distressed,
        # icb.friends_order_exercise_times,
         icb.injury_prevented_illness_exercised,
       #  icb.shape_compelled_unable_distressed.txt,
         icb.feel_compelled_felt_distressed,
         icb.feel_compelled_felt_distressed.1,
         icb.began_time_inducing_vomiting.txt,
         icb.engaging_long_time_period,
         icb.engaging_long_time_period.1,
         icb.laxatives_time.txt,
         icb.long_laxatives_time_period,
         icb.long_laxatives_time_period.1,
         icb.diuretics_time.txt,
         icb.long_diuretics_time_period,
         icb.long_diuretics_time_period.1,
         icb.making_yourself_vomit,
         icb.laxatives,
         icb.diuretics,
         icb.weight_loss_pills,
         icb.excessive_exercise,
         icb.fasting,
         icb.other_methods,
         icb.none_of_the_above,
         icb.making_yourself_vomit.1,
         icb.laxatives.1,
         icb.diuretics_water_pills,
         icb.weight_loss_pills.1,
         icb.excessive_exercise.1,
         icb.fasting.1,
         icb.other_methods.1,
         icb.none_of_the_above.1,
         icb.week_periods_induce_vomiting,
         icb.lasted_binge_eating_episodes,
         icb.eating_habits_modified_reason,
        # icb.compensate_state_binge_eating.txt,
         icb.state_methods_shape_control.txt,
         icb.month_periods_induce_vomiting,
         icb.year_periods_induce_vomiting,
         icb.3months_average_time_week,
         icb.wasthere_average_binge_engaged,
         icb.laxatives_week_periods,
         icb.month_laxatives_periods,
         icb.laxatives_year_periods,
         icb.diuretics_week_periods,
         icb.month_diuretics_periods,
         icb.diuretics_year_periods,
         icb.week_periods_diet_pills,
         icb.month_periods_diet_pills,
         icb.year_periods_diet_pills,
         icb.exercise_week_periods,
         icb.month_exercise_periods,
         icb.exercise_year_periods,
         icb.fast_week_periods,
       #  icb.month_fast_periods,
         icb.fast_year_periods
         ) %>%
    add_numeric(., exclude = exclude_cols_dem) %>%
  mutate_if(is.numeric, ~na_if(., -88)) %>% # Recode missing values to NAs in numeric variables
  mutate_if(is.numeric, ~na_if(., -99)) %>%
  mutate_if(is.numeric, ~na_if(., -77)) %>%
  mutate_if(is.factor, ~na_if(., "Seen but not answered")) %>% # Recode missing values to NAs in factor variables
  mutate_if(is.factor, ~na_if(., "Don't know")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to say")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Seen but not answered")) %>% # Drop empty factor levels
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Don't know")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to say"))

# Inspect dimensions
dim(ICB_symptom_data_GLAD.id)
# Inspect colnames
colnames(ICB_symptom_data_GLAD.id)
#Differences
dim(ICB_symptom_data_GLAD)[1]-dim(ICB_symptom_data_GLAD.id)[1]

```

## Read in data - ICB ED100K EDGI
```{r Read in data}

ICB_symptom_data_EDGI <- readRDS(file = "../data_raw/edgi/icb_edgi.rds") #Add your data file here
```

##Select columns
```{r Read in data}

exclude_cols_dem <- c("externalDataReference")

ICB_symptom_data_EDGI.id <- ICB_symptom_data_EDGI %>% 
  drop_na(externalDataReference) %>% # Drop NAs
  distinct(externalDataReference, .keep_all = TRUE)  %>%
  add_column(cohort_name = "edgi", .before = "icb.exercised_excessively.1") %>% #create new column 
  select(
         ID = externalDataReference,# ID
         cohort_name, # Sample
         icb.b_used_laxatives = icb.exercised_excessively.1,
         icb.b_used_laxatives.1 = icb.exercised_excessively.2,
         icb.b_used_laxatives.2 = icb.fasted_or_did_not_eat.2, 
         icb.a_made_yourself_vomit = icb.made_yourself_vomit.1,
         icb.a_made_yourself_vomit.1 = icb.any_other_methods_not_previously_listed,
         icb.a_made_yourself_vomit.2 = icb.any_other_methods_not_previously_listed.1,
         icb.engage_fasting_time_period = icb.engage_fasting_period_periods,
         icb.engage_fasting_time_period.1 = icb.engage_fasting_period_periods.1,
         icb.fasted_time.txt,
         icb.time_diet_pills.txt,
         icb.long_time_period_diet,
         icb.long_time_period_diet.1,
         icb.body_shape_felt_compelled,
         icb.felt_uneasy_unable_distressed,
       #  icb.friends_order_exercise_times = icb.order_friends_exercise_times,
         icb.injury_prevented_illness_exercised,
       #  icb.shape_compelled_unable_distressed.txt = icb.compelled_shape_unable_distressed.txt,
         icb.feel_compelled_felt_distressed,
         icb.feel_compelled_felt_distressed.1,
         icb.began_time_inducing_vomiting.txt = icb.time_induced_vomiting.txt,
         icb.engaging_long_time_period,
         icb.engaging_long_time_period.1,
         icb.laxatives_time.txt,
         icb.long_laxatives_time_period,
         icb.long_laxatives_time_period.1,
         icb.diuretics_time.txt,
         icb.long_diuretics_time_period,
         icb.long_diuretics_time_period.1,
         icb.making_yourself_vomit,
         icb.laxatives,
         icb.diuretics,
         icb.weight_loss_pills,
         icb.excessive_exercise,
         icb.fasting,
         icb.other_methods,
         icb.none_of_the_above = icb.none,
         icb.making_yourself_vomit.1,
         icb.laxatives.1,
         icb.diuretics_water_pills = icb.diuretics.1,
         icb.weight_loss_pills.1,
         icb.excessive_exercise.1,
         icb.fasting.1,
         icb.other_methods.1,
         icb.none_of_the_above.1 = icb.none.1,
         icb.week_periods_induce_vomiting,
         icb.lasted_binge_eating_episodes1 = icb.icb_bingeing_engage_months,
         icb.lasted_binge_eating_episodes2 = icb.icb_bingeing_engage_months.1,
         icb.lasted_binge_eating_episodes3 = icb.dont_know,
         icb.eating_habits_modified_reason,
        # icb.compensate_state_binge_eating.txt = icb.compensate_binge_eating_state.txt,
         icb.state_methods_shape_control.txt,
         icb.month_periods_induce_vomiting,
         icb.year_periods_induce_vomiting,
         icb.3months_average_time_week = icb.binge_eating_average_months,
         icb.wasthere_average_binge_engaged = icb.binge_eating_wasthere_made,
         icb.laxatives_week_periods,
         icb.month_laxatives_periods,
         icb.laxatives_year_periods,
         icb.diuretics_week_periods,
         icb.month_diuretics_periods,
         icb.diuretics_year_periods,
         icb.week_periods_diet_pills,
         icb.month_periods_diet_pills,
         icb.year_periods_diet_pills,
         icb.exercise_week_periods,
         icb.month_exercise_periods,
         icb.exercise_year_periods,
         icb.fast_week_periods,
        # icb.month_fast_periods = icb.fast_month_periods,
         icb.fast_year_periods
         ) %>%
    add_numeric(., exclude = exclude_cols_dem) %>%
  mutate_if(is.numeric, ~na_if(., -88)) %>% # Recode missing values to NAs in numeric variables
  mutate_if(is.numeric, ~na_if(., -99)) %>%
  mutate_if(is.numeric, ~na_if(., -77)) %>%
  mutate_if(is.factor, ~na_if(., "Seen but not answered")) %>% # Recode missing values to NAs in factor variables
  mutate_if(is.factor, ~na_if(., "Don't know")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to say")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Seen but not answered")) %>% # Drop empty factor levels
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Don't know")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to say"))

# Inspect dimensions
dim(ICB_symptom_data_EDGI.id)
# Inspect colnames
colnames(ICB_symptom_data_EDGI.id)
#Differences
dim(ICB_symptom_data_EDGI)[1]-dim(ICB_symptom_data_EDGI.id)[1]

```

##Merge ICB and BED - GLAD
```{r}
dfs.list <- list(
 BE_symptom_data_GLAD.id,
  ICB_symptom_data_GLAD.id)

#Merge
GLAD_BE_ICB_symptom_data.id <- plyr::join_all(dfs.list,
                                      by = c("ID"))


#Check
nrow(GLAD_BE_ICB_symptom_data.id)
```
##Merge ICB and BED - EDGI
```{r}
dfs.list <- list(
 BE_symptom_data_EDGI.id,
  ICB_symptom_data_EDGI.id)

#Merge
EDGI_BE_ICB_symptom_data.id <- plyr::join_all(dfs.list,
                                      by = c("ID"))


#Check
nrow(EDGI_BE_ICB_symptom_data.id)
```

## Derived variables (GLAD + EDGI)

##NB: Naming in data dictionary is wrong - use the following:
be.a_eat_much_more_rapidly_than_usual = a) Eat much more rapidly than usual?

be.a_eat_much_more_rapidly_than_usual.1 = b) Eat until you felt uncomfortably full?

be.a_eat_much_more_rapidly_than_usual.2 = c) Eat large amounts of food when you didnt feel physically hungry?

be.b_eat_until_you_felt_uncomfortably_full = d) Eat alone because you were embarrassed by what/how much you were eating?

be.b_eat_until_you_felt_uncomfortably_full.1 e) Feel ashamed/disgusted with yourself, depressed, or very guilty after overeating?


#BE Behaviour score - Number of BE behaviours [EDGI & GLAD]
```{r ed.BE_behaviour_sum_numeric}

#Sum of binge eating behaviours
GLAD_BE_ICB_symptom_data.id$ed.BE_behaviour_sum_numeric <- rowSums(GLAD_BE_ICB_symptom_data.id[ ,
                                 c("be.a_eat_much_more_rapidly_than_usual_numeric",
                                   "be.a_eat_much_more_rapidly_than_usual.1_numeric",
                                   "be.a_eat_much_more_rapidly_than_usual.2_numeric",
                                   "be.b_eat_until_you_felt_uncomfortably_full_numeric",
                                   "be.b_eat_until_you_felt_uncomfortably_full.1_numeric")],
                                  na.rm = TRUE)

#Summary
freq(GLAD_BE_ICB_symptom_data.id$ed.BE_behaviour_sum_numeric)         

colnames(GLAD_BE_ICB_symptom_data.id)

#Sum of binge eating behaviours
EDGI_BE_ICB_symptom_data.id$ed.BE_behaviour_sum_numeric <- rowSums(EDGI_BE_ICB_symptom_data.id[ ,
                                 c("be.a_eat_much_more_rapidly_than_usual_numeric",
                                   "be.a_eat_much_more_rapidly_than_usual.1_numeric",
                                   "be.a_eat_much_more_rapidly_than_usual.2_numeric",
                                   "be.b_eat_until_you_felt_uncomfortably_full_numeric",
                                   "be.b_eat_until_you_felt_uncomfortably_full.1_numeric")],
                                  na.rm = TRUE)

#Summary
freq(EDGI_BE_ICB_symptom_data.id$ed.BE_behaviour_sum_numeric)         

colnames(EDGI_BE_ICB_symptom_data.id)
```

##Binge eating FREQUENCY
One year = 52.1429 weeks
One month = 4.34524 weeks 
```{r ed.BE_freq conversion}
#GLAD
GLAD_BE_ICB_symptom_data.id$ed.BE_freq_per_week <- NA

# Calculate frequency per week
GLAD_BE_ICB_symptom_data.id$ed.BE_freq_per_week <- 
  with(GLAD_BE_ICB_symptom_data.id,
    case_when(
      be.binge_eating_experience_episodes.txt.1_numeric > 0 ~ round(be.binge_eating_experience_episodes.txt.1_numeric/52.1429, digits = 2),
      be.binge_eating_experience_episodes.txt_numeric > 0 ~ round(be.binge_eating_experience_episodes.txt_numeric/4.34524, digits = 2), 
      be.binge_eating_episodes_experience.txt_numeric > 0 ~ be.binge_eating_episodes_experience.txt_numeric
      )
  )
  
#Summary
freq(GLAD_BE_ICB_symptom_data.id$ed.BE_freq_per_week) 

#EDGI
EDGI_BE_ICB_symptom_data.id$ed.BE_freq_per_week <- NA

# Calculate frequency per week
EDGI_BE_ICB_symptom_data.id$ed.BE_freq_per_week <- 
  with(EDGI_BE_ICB_symptom_data.id,
    case_when(
      be.binge_eating_experience_episodes.txt.1_numeric > 0 ~ round(be.binge_eating_experience_episodes.txt.1_numeric/52.1429, digits = 2),
      be.binge_eating_experience_episodes.txt_numeric > 0 ~ round(be.binge_eating_experience_episodes.txt_numeric/4.34524, digits = 2), 
      be.binge_eating_episodes_experience.txt_numeric > 0 ~ be.binge_eating_episodes_experience.txt_numeric
      )
  )
  
#Summary
freq(EDGI_BE_ICB_symptom_data.id$ed.BE_freq_per_week) 
```

#Binge eating DURATION
Converting to smallest unit first gives you more accurate estimates
One year = 365.25 days; One month = 30.4167 days
```{r ed.BE_duration conversion}

##GLAD
GLAD_BE_ICB_symptom_data.id$ed.BE_duration_months <- NA

# Sum years and months into months
GLAD_BE_ICB_symptom_data.id$ed.BE_duration_months <- 
  if_else(condition = is.na(GLAD_BE_ICB_symptom_data.id$ed.BE_duration_months),
         true = ((GLAD_BE_ICB_symptom_data.id$be.long_experience_regularly_occurring_numeric*365.25) + (GLAD_BE_ICB_symptom_data.id$be.long_experience_regularly_occurring.1_numeric*30.4167)) / 30.4167, 
        false = NA_real_,
        missing = NA_real_)

# Summary
freq(GLAD_BE_ICB_symptom_data.id$ed.BE_duration_months)

##Change below 0 to NA
GLAD_BE_ICB_symptom_data.id$ed.BE_duration_months[GLAD_BE_ICB_symptom_data.id$ed.BE_duration_months < 0] <- NA_real_

# Check
freq(GLAD_BE_ICB_symptom_data.id$ed.BE_duration_months)


##EDGI
EDGI_BE_ICB_symptom_data.id$ed.BE_duration_months <- NA

#Change to numeric
freq(EDGI_BE_ICB_symptom_data.id$be.duration_years_numeric) <- as.numeric(EDGI_BE_ICB_symptom_data.id$be.long_experience_regularly_occurring_numeric)

EDGI_BE_ICB_symptom_data.id$be.duration_months_numeric <- as.numeric(EDGI_BE_ICB_symptom_data.id$be.long_experience_regularly_occurring.1_numeric)

# Sum years and months into months
EDGI_BE_ICB_symptom_data.id$ed.BE_duration_months <- 
  if_else(condition = is.na(EDGI_BE_ICB_symptom_data.id$ed.BE_duration_months),
         true = ((EDGI_BE_ICB_symptom_data.id$be.duration_years_numeric*365.25) + (EDGI_BE_ICB_symptom_data.id$be.duration_months_numeric*30.4167)) / 30.4167, 
        false = NA_real_,
        missing = NA_real_)

# Summary
freq(EDGI_BE_ICB_symptom_data.id$ed.BE_duration_months)


##Change below 0 to NA
EDGI_BE_ICB_symptom_data.id$ed.BE_duration_months[EDGI_BE_ICB_symptom_data.id$ed.BE_duration_months < 0] <- NA_real_

# Check
freq(EDGI_BE_ICB_symptom_data.id$ed.BE_duration_months)
```


#DSM5 BED ALGORITHM - GLAD
```{r}

#BED numeric variable
GLAD_BE_ICB_symptom_data.id$ed.DSM5_BED_binary_numeric <- 
  with(GLAD_BE_ICB_symptom_data.id,
  dplyr::if_else(

    #A. Recurrent episodes of binge eating. An episode of binge eating is characterized by both of the following:
#1)Eating, in a discrete period of time (e.g., within any 2-hour period), an amount of food that is definitely larger than what most people would eat in a similar period of time under similar circumstances
    be.short_period_ate_regard == "Yes" & 

      #2)A sense of lack of control over eating during the episode (e.g., a feeling that one cannot stop eating or control what or how much one is eating)
      (be.binge_eating_stop_eating == "Slightly" | #*** Should this be "slightly" for a more lenient algorithm? ***Difference between inclusion criteria and actual diagnositics?
       be.binge_eating_stop_eating == "Somewhat" |
       be.binge_eating_stop_eating == "Very" |
       be.binge_eating_stop_eating == "Extremely") & 

  #B. The binge-eating episodes are associated with three (or more) of the following:
#1. Eating much more rapidly than normal.
#2. Eating until feeling uncomfortably full.
#3. Eating large amounts of food when not feeling physically hungry.
#4. Eating alone because of feeling embarrassed by how much one is eating.
#5. Feeling disgusted with oneself, depressed, or very guilty afterward.
  ed.BE_behaviour_sum_numeric >= 3 & 

  #C. Marked distress regarding binge eating is present.       
  (be.binge_eating_distressed_make == "Slightly" |  #*** Should this be "slightly" for a more lenient algorithm? Difference between inclusion criteria and actual diagnositics?
         be.binge_eating_distressed_make == "Somewhat" |
         be.binge_eating_distressed_make == "Very" |
         be.binge_eating_distressed_make == "Extremely") & 

  #D. The binge eating occurs, on average, at least once a week for 3 months.
  (ed.BE_freq_per_week >= 0.95 & # Binge eating per week 
      ed.BE_duration_months >= 2.95) & # Binge eating total duration 

  #E. The binge eating is not associated with the recurrent use of inappropriate compensatory behavior as in bulimia nervosa... "Did you ever have periods of time that lasted three months or more when you had binge-eating episodes without regularly engaging in any of the following: making yourself vomit, laxative use, diuretic use, taking weight loss pills, excessively exercising ?"
  (icb.lasted_binge_eating_episodes == "Yes" | 
        icb.none_of_the_above.1 == "Yes"  |
     is.na(icb.lasted_binge_eating_episodes)) &  #***ask Molly about the logic of this question - does everyone get asked this?

  #...and does not occur exclusively during the course of bulimia nervosa or anorexia nervosa.  
  (be.experience_regular_episodes_lowest == "At times of low weight and at times outside of low weight" |
     be.experience_regular_episodes_lowest == "No" |
     is.na(be.experience_regular_episodes_lowest)),
    true = 1,
    false = 0,
    missing = NA_real_)
    )
    
#Recode numeric to factor
GLAD_BE_ICB_symptom_data.id$ed.DSM5_BED_binary <-
  recode_factor(GLAD_BE_ICB_symptom_data.id$ed.DSM5_BED_binary_numeric,
                "0" = "No DSM-5 BED",
                "1" = "DSM-5 BED")

#Summary
freq(GLAD_BE_ICB_symptom_data.id$ed.DSM5_BED_binary)

```
#DSM5 BED ALGORITHM - EDGI
```{r}

#BED numeric variable
EDGI_BE_ICB_symptom_data.id$ed.DSM5_BED_binary_numeric <- 
  with(EDGI_BE_ICB_symptom_data.id,
  dplyr::if_else(

    #A. Recurrent episodes of binge eating. An episode of binge eating is characterized by both of the following:
#1)Eating, in a discrete period of time (e.g., within any 2-hour period), an amount of food that is definitely larger than what most people would eat in a similar period of time under similar circumstances
    be.short_period_ate_regard == "Yes" & 

      #2)A sense of lack of control over eating during the episode (e.g., a feeling that one cannot stop eating or control what or how much one is eating)
      (be.binge_eating_stop_eating == "Slightly" | 
       be.binge_eating_stop_eating == "Somewhat" |
       be.binge_eating_stop_eating == "Very" |
       be.binge_eating_stop_eating == "Extremely") & 

  #B. The binge-eating episodes are associated with three (or more) of the following:
#1. Eating much more rapidly than normal.
#2. Eating until feeling uncomfortably full.
#3. Eating large amounts of food when not feeling physically hungry.
#4. Eating alone because of feeling embarrassed by how much one is eating.
#5. Feeling disgusted with oneself, depressed, or very guilty afterward.
  ed.BE_behaviour_sum_numeric >= 3 & 

  #C. Marked distress regarding binge eating is present.       
  (be.binge_eating_distressed_make == "Slightly" |  #*** Should this be "slightly" for a more lenient algorithm? Difference between inclusion criteria and actual diagnositics?
         be.binge_eating_distressed_make == "Somewhat" |
         be.binge_eating_distressed_make == "Very" |
         be.binge_eating_distressed_make == "Extremely") & 

  #D. The binge eating occurs, on average, at least once a week for 3 months.
  (ed.BE_freq_per_week >= 0.95 & # Binge eating per week 
      ed.BE_duration_months >= 2.95) & # Binge eating total duration 

  #E. The binge eating is not associated with the recurrent use of inappropriate compensatory behavior as in bulimia nervosa... "Did you ever have periods of time that lasted three months or more when you had binge-eating episodes without regularly engaging in any of the following: making yourself vomit, laxative use, diuretic use, taking weight loss pills, excessively exercising ?"
  (
  (
    icb.lasted_binge_eating_episodes1 == "Yes, 3 months DID NOT engage in ICB while bingeing" | 
        icb.none_of_the_above.1 == "Yes"
    ) |
  
  (
    is.na(icb.lasted_binge_eating_episodes1) & #***Is this right?
     is.na(icb.lasted_binge_eating_episodes2) &
     is.na(icb.lasted_binge_eating_episodes3)
     )
  ) & 

  #...and does not occur exclusively during the course of bulimia nervosa or anorexia nervosa.  
  (be.experience_regular_episodes_lowest == "At times of low weight and at times outside of low weight" |
     be.experience_regular_episodes_lowest == "No" |
     is.na(be.experience_regular_episodes_lowest)),
    true = 1,
    false = 0,
    missing = NA_real_)
    )
    
#Recode numeric to factor
EDGI_BE_ICB_symptom_data.id$ed.DSM5_BED_binary <-
  recode_factor(EDGI_BE_ICB_symptom_data.id$ed.DSM5_BED_binary_numeric,
                "0" = "No DSM-5 BED",
                "1" = "DSM-5 BED")

#Summary
freq(EDGI_BE_ICB_symptom_data.id$ed.DSM5_BED_binary)

```
##DSM-5 BN - GLAD

NB: ICBs mislabelled in data dictionary
icb.b_used_laxatives = Fasted or did not eat
icb.b_used_laxatives.1 = Used diet pills
icb.b_used_laxatives.2 = Exercised excessively
icb.a_made_yourself_vomit = Made yourself vomit
icb.a_made_yourself_vomit.1 = Used laxatives
icb.a_made_yourself_vomit.2 =  Used diuretics
```{r ed.BN_DSM5_binary}

#Bulimia nervosa numeric variable
GLAD_BE_ICB_symptom_data.id$ed.DSM5_BN_binary_numeric <- 
  with(GLAD_BE_ICB_symptom_data.id,
  dplyr::if_else(

#A. Recurrent episodes of binge eating. An episode of binge eating is characterized by both of the following:

    #1. Eating, in a discrete period of time (e.g., within any 2-hour period), an amount of food that is definitely larger than what most individuals would eat in a similar period of time under similar circumstances.
    
    ##Have you ever had regular episodes of overeating or eating binges when you ate what most people would regard as an unusually large amount of food in a short period of time?
    be.short_period_ate_regard == "Yes" & 

      #2. A sense of lack of control over eating during the episode (e.g., a feeling that one cannot stop eating or control what or how much one is eating).
      
      #When you were having regularly occurring episodes of binge eating or overeating, did you feel that your eating was out of control such that you felt you could not stop eating, or that you could not control what or how much you were eating?
      
        (
          be.binge_eating_stop_eating == "Slightly" | #**Check cut off!
         be.binge_eating_stop_eating == "Somewhat" |
         be.binge_eating_stop_eating == "Very" |
         be.binge_eating_stop_eating == "Extremely"
         ) & 

      #B. Recurrent inappropriate compensatory behaviors in order to prevent weight gain, such as self-induced vomiting; misuse of laxatives, diuretics, or other medications; fasting; or excessive exercise. [these variables are referring to ICBs to control weight or shape, i.e. not necessarily in response to binge eating]
          (
            icb.a_made_yourself_vomit == "A few times" |  #Vomiting
          icb.a_made_yourself_vomit == "Often" | 
            
          icb.a_made_yourself_vomit.1 == "A few times" | #Laxtives
          icb.a_made_yourself_vomit.1 == "Often" |
            
          icb.a_made_yourself_vomit.2  == "A few times" | #Diuretics
          icb.a_made_yourself_vomit.2  =="Often" |
            
          icb.b_used_laxatives.1 == "A few times" | #Diet pills
          icb.b_used_laxatives.1 == "Often" |
            
          icb.b_used_laxatives.2 == "A few times" | #Excessive exercise
          icb.b_used_laxatives.2 == "Often" |
            
          icb.b_used_laxatives == "A few times" | #Fasting
          icb.b_used_laxatives == "Often"
          ) & 

      #C. The binge eating and inappropriate compensatory behaviors both occur, on average, at least once a week for 3 months.
      (
        ed.BE_freq_per_week >= 0.95 & # Binge eating per week 
      ed.BE_duration_months >= 2.95 # Binge eating total duration 
      ) & 

      #B. Recurrent inappropriate compensatory behaviors in order to prevent weight gain, such as self-induced vomiting; misuse of laxatives, diuretics, or other medications; fasting; or excessive exercise. [these variables are referring to ICBs in response to binge eating]
        (
          icb.making_yourself_vomit.1 == "Making yourself vomit" |
        icb.laxatives.1 == "Laxatives (including pills or liquids meant to stimulate bowel movements)" |
        icb.diuretics_water_pills == "Diuretics (water pills)" |
        icb.weight_loss_pills.1 == "Weight loss pills (over the counter or prescription)" |
        icb.excessive_exercise.1 == "Excessive exercise (e.g. feel compelled to exercise, feel uneasy or distressed if unable to exercise)" |
        icb.fasting.1 == "Fasting (not eating for 8 waking hours or more)"
        ) & 

      #C. The binge eating and inappropriate compensatory behaviors both occur, on average, at least once a week for 3 months.
      
  #Did the binge eating and compensatory behaviours occur at the same time, on average, once a week for 3 months?
      
      (
        icb.3months_average_time_week == "Yes" | 
  is.na(icb.3months_average_time_week)
  ) & 

    #D. Self-evaluation is unduly influenced by body shape and weight.
         
    #During the time when you were binge eating, how dependent was your self-worth on your body shape or weight?
    (
    be.not_at_all_dependentcompletely_dependent == "1" | #***Check cut off!
    be.not_at_all_dependentcompletely_dependent == "2" | 
    be.not_at_all_dependentcompletely_dependent == "3" |
      be.not_at_all_dependentcompletely_dependent == "4" |
      be.not_at_all_dependentcompletely_dependent == "5" |
      be.not_at_all_dependentcompletely_dependent == "Completely Dependent"
  ) &

    #E. The disturbance does not occur exclusively during episodes of anorexia nervosa.
        (
          be.experience_regular_episodes_lowest == "At times of low weight and at times outside of low weight" | 
         be.experience_regular_episodes_lowest == "No" |
         is.na(be.experience_regular_episodes_lowest)
         ),
    true = 1,
    false = 0,
    missing = NA_real_)
  )
  
#Recode numeric variable to factor
GLAD_BE_ICB_symptom_data.id$ed.DSM5_BN_binary <-
  recode_factor(GLAD_BE_ICB_symptom_data.id$ed.DSM5_BN_binary_numeric,
                "0" = "No DSM-5 BN",
                "1" = "DSM-5 BN")

#Summary
freq(GLAD_BE_ICB_symptom_data.id$ed.DSM5_BN_binary)
```


##DSM-5 BN - EDGI

NB: ICBs mislabelled in data dictionary

icb.exercised_excessively.1 = Fasted or did not eat
icb.exercised_excessively.2 = Used diet pills
icb.fasted_or_did_not_eat.2 = Exercised excessively
icb.made_yourself_vomit.1 = Made yourself vomit
icb.any_other_methods_not_previously_listed = Used laxatives
icb.any_other_methods_not_previously_listed.1 =  Used diuretics

```{r ed.BN_DSM5_binary}

#Bulimia nervosa numeric variable
EDGI_BE_ICB_symptom_data.id$ed.DSM5_BN_binary_numeric <- 
  with(EDGI_BE_ICB_symptom_data.id,
  dplyr::if_else(

#A. Recurrent episodes of binge eating. An episode of binge eating is characterized by both of the following:

    #1. Eating, in a discrete period of time (e.g., within any 2-hour period), an amount of food that is definitely larger than what most individuals would eat in a similar period of time under similar circumstances.
    
    ##Have you ever had regular episodes of overeating or eating binges when you ate what most people would regard as an unusually large amount of food in a short period of time?
    be.short_period_ate_regard == "Yes" & 

      #2. A sense of lack of control over eating during the episode (e.g., a feeling that one cannot stop eating or control what or how much one is eating).
      
      #When you were having regularly occurring episodes of binge eating or overeating, did you feel that your eating was out of control such that you felt you could not stop eating, or that you could not control what or how much you were eating?
      
        (
          be.binge_eating_stop_eating == "Slightly" | #**Check cut off!
         be.binge_eating_stop_eating == "Somewhat" |
         be.binge_eating_stop_eating == "Very" |
         be.binge_eating_stop_eating == "Extremely"
         ) & 

      #B. Recurrent inappropriate compensatory behaviors in order to prevent weight gain, such as self-induced vomiting; misuse of laxatives, diuretics, or other medications; fasting; or excessive exercise. [these variables are referring to ICBs to control weight or shape, i.e. not necessarily in response to binge eating]
          (
            icb.a_made_yourself_vomit == "A few times" |  #Vomiting
          icb.a_made_yourself_vomit == "Often" | 
            
          icb.a_made_yourself_vomit.1 == "A few times" | #Laxtives
          icb.a_made_yourself_vomit.1 == "Often" |
            
          icb.a_made_yourself_vomit.2  == "A few times" | #Diuretics
          icb.a_made_yourself_vomit.2  =="Often" |
            
          icb.b_used_laxatives.1 == "A few times" | #Diet pills
          icb.b_used_laxatives.1 == "Often" |
            
          icb.b_used_laxatives.2 == "A few times" | #Excessive exercise
          icb.b_used_laxatives.2 == "Often" |
            
          icb.b_used_laxatives == "A few times" | #Fasting
          icb.b_used_laxatives == "Often"
          ) & 

      #C. The binge eating and inappropriate compensatory behaviors both occur, on average, at least once a week for 3 months.
      (
        ed.BE_freq_per_week >= 0.95 & # Binge eating per week 
      ed.BE_duration_months >= 2.95 # Binge eating total duration 
      ) & 

      #B. Recurrent inappropriate compensatory behaviors in order to prevent weight gain, such as self-induced vomiting; misuse of laxatives, diuretics, or other medications; fasting; or excessive exercise. [these variables are referring to ICBs in response to binge eating]
        (
          icb.making_yourself_vomit.1 == "Making yourself vomit" |
        icb.laxatives.1 == "Laxatives" |
        icb.diuretics_water_pills == "Diuretics" |
        icb.weight_loss_pills.1 == "Weight loss pills" |
        icb.excessive_exercise.1 == "Excessive exercise" |
        icb.fasting.1 == "Fasting"
        ) & 

      #C. The binge eating and inappropriate compensatory behaviors both occur, on average, at least once a week for 3 months.
      
  #Did the binge eating and compensatory behaviours occur at the same time, on average, once a week for 3 months?
      
      (
        icb.3months_average_time_week == "Yes" | 
  is.na(icb.3months_average_time_week)
  ) & 

    #D. Self-evaluation is unduly influenced by body shape and weight.
         
    #During the time when you were binge eating, how dependent was your self-worth on your body shape or weight?
    (
    be.not_at_all_dependentcompletely_dependent == "1" | #***Check cut off!
    be.not_at_all_dependentcompletely_dependent == "2" | 
    be.not_at_all_dependentcompletely_dependent == "3" |
      be.not_at_all_dependentcompletely_dependent == "4" |
      be.not_at_all_dependentcompletely_dependent == "5" |
      be.not_at_all_dependentcompletely_dependent == "Completely Dependent"
  ) &

    #E. The disturbance does not occur exclusively during episodes of anorexia nervosa.
        (
          be.experience_regular_episodes_lowest == "At times of low weight and at times outside of low weight" | 
         be.experience_regular_episodes_lowest == "No" |
         is.na(be.experience_regular_episodes_lowest)
         ),
    true = 1,
    false = 0,
    missing = NA_real_)
  )
  
#Recode numeric variable to factor
EDGI_BE_ICB_symptom_data.id$ed.DSM5_BN_binary <-
  recode_factor(EDGI_BE_ICB_symptom_data.id$ed.DSM5_BN_binary_numeric,
                "0" = "No DSM-5 BN",
                "1" = "DSM-5 BN")

#Summary
freq(EDGI_BE_ICB_symptom_data.id$ed.DSM5_BN_binary)
```





##GLAD MHD
```{r}
 glad.mhd.raw <- readRDS(file = "../data_raw/glad/mhd_glad.rds")
  dim(glad.mhd.raw)
  colnames(glad.mhd.raw)
```








##Select columns
```{r}
exclude_cols <- c("ID",
                  "cohort_name")

glad.mhd.raw.id <- glad.mhd.raw %>%
    drop_na(externalDataReference) %>% # Drop NAs
    distinct(externalDataReference, .keep_all = TRUE) %>% # Remove duplicates based on ID
    #separate(externalDataReference, into = c("Sample", "ID"), sep = 4) %>% # Split ID in Sample and Number
    # mutate(ID = as.numeric(ID)) %>%
    add_column(cohort_name = "glad", .before = "mhd.an") %>% #create new column 
    select(
      ID = externalDataReference, # ID
      cohort_name, # Sample
      mhd.anorexia_signup = mhd.an,
      mhd.bulimia_signup = mhd.bn,
      mhd.bed_signup = mhd.bed

    ) %>%
    add_numeric(., exclude = exclude_cols) %>%
    mutate_if(is.numeric, ~na_if(., -88)) %>% # Recode missing values to NAs in numeric variables
    mutate_if(is.numeric, ~na_if(., -99)) %>%
    mutate_if(is.numeric, ~na_if(., -77)) %>%
    mutate_if(is.factor, ~na_if(., "Seen but not answered")) %>% # Recode missing values to NAs in factor variables
    mutate_if(is.factor, ~na_if(., "Don't know")) %>%
    mutate_if(is.factor, ~na_if(., "Prefer not to say")) %>%
    mutate_if(is.factor, ~na_if(., "Prefer not to answer")) %>%
    mutate_if(is.factor, ~forcats::fct_drop(., only = "Seen but not answered")) %>% # Drop empty factor levels
    mutate_if(is.factor, ~forcats::fct_drop(., only = "Don't know")) %>%
    mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to answer")) %>%
    mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to say"))
  # Inspect dimensions
  dim(glad.mhd.raw.id)
  # Inspect colnames
  colnames(glad.mhd.raw.id)
  #Differences
  dim(glad.mhd.raw)[1]-dim(glad.mhd.raw.id)[1]
```
##GLAD MHD
```{r}
edgi.mhd.raw <- readRDS(file = "../data_raw/edgi/mhd_edgi.rds")
  dim(edgi.mhd.raw)
  colnames(edgi.mhd.raw)
```

##Select columns
```{r}
exclude_cols <- c("ID",
                  "cohort_name")

edgi.mhd.raw.id <- edgi.mhd.raw %>%
    drop_na(externalDataReference) %>% # Drop NAs
    distinct(externalDataReference, .keep_all = TRUE) %>% # Remove duplicates based on ID
    #separate(externalDataReference, into = c("Sample", "ID"), sep = 4) %>% # Split ID in Sample and Number
    # mutate(ID = as.numeric(ID)) %>%
    add_column(cohort_name = "edgi", .before = "mhd.anorexia_nervosa") %>% #create new column 
    select(
      ID = externalDataReference, # ID
      cohort_name, # Sample
      mhd.anorexia_signup = mhd.anorexia_nervosa,
      mhd.bulimia_signup = mhd.bulimia_nervosa,
      mhd.bed_signup = mhd.bingeeating_disorder

    ) %>%
    add_numeric(., exclude = exclude_cols) %>%
    mutate_if(is.numeric, ~na_if(., -88)) %>% # Recode missing values to NAs in numeric variables
    mutate_if(is.numeric, ~na_if(., -99)) %>%
    mutate_if(is.numeric, ~na_if(., -77)) %>%
    mutate_if(is.factor, ~na_if(., "Seen but not answered")) %>% # Recode missing values to NAs in factor variables
    mutate_if(is.factor, ~na_if(., "Don't know")) %>%
    mutate_if(is.factor, ~na_if(., "Prefer not to say")) %>%
    mutate_if(is.factor, ~na_if(., "Prefer not to answer")) %>%
    mutate_if(is.factor, ~forcats::fct_drop(., only = "Seen but not answered")) %>% # Drop empty factor levels
    mutate_if(is.factor, ~forcats::fct_drop(., only = "Don't know")) %>%
    mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to answer")) %>%
    mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to say"))
  # Inspect dimensions
  dim(glad.mhd.raw.id)
  # Inspect colnames
  colnames(glad.mhd.raw.id)
  #Differences
  dim(glad.mhd.raw)[1]-dim(glad.mhd.raw.id)[1]
```






















### Read in ED data: AN GLAD COPING
```{r}
dat.ed.glad.coping <- readRDS(file = "../data_raw/diagnostics/an_coping_glad.rds")

# Inspect dimensions
dim(dat.ed.glad.coping)
# Inspect colnames
colnames(dat.ed.glad.coping)

nrow(dat.ed.glad.coping)

```

### Select variables: GLAD AN
```{r glad select variables}

exclude_cols_dem <- c("ID",
                  "cohort_name")

dat.ed.glad.coping.id <- dat.ed.glad.coping %>% #new dataset with ID
  drop_na(externalDataReference) %>% # Drop NAs
  distinct(externalDataReference, .keep_all = TRUE) %>% 
  add_column(cohort_name = "coping_glad", .before = "an.1.lowest_weight_weigh_weighed") %>% #create new column 
  select(
         ID = externalDataReference,# ID
         cohort_name, # Sample
         an.1.lowest_weight_weigh_weighed,           
         an.1.what_was_the_illness.txt,                
         an.1.low_weight_time,                         
         an.1.low_weight_time.1,                        
         an.1.low_weight_time.2,                       
         an.1.how_old_were_you_then.txt,                
         an.1.how_tall_were_you_then,                  
         an.1.how_tall_were_you_then.1,                 
         an.1.how_tall_were_you_then.2,                
         an.1.feel_fat_low_weight,                      
         an.1.gain_weight_low_weight,                  
         an.1.anorexia_nervosa_low_weight,              
         an.1.anorexia_nervosa_low_weight.1,           
         an.1.not_at_all_dependentcompletely_dependent, 
         an.1.low_weight_health_negative,              
         an.1.body_larger_low_weight,                   
         an.1.started_time_periods,                    
         an.1.low_weight_periods_stop,                  
         an.1.roughly_periods_stopped.txt,             
         an.1.for_how_long_did_your_periods_stop,       
         an.1.for_how_long_did_your_periods_stop.1
         ) %>%
  add_numeric(., exclude = exclude_cols_dem) %>%
  mutate_if(is.numeric, ~na_if(., -88)) %>% # Recode missing values to NAs in numeric variables
  mutate_if(is.numeric, ~na_if(., -99)) %>%
  mutate_if(is.numeric, ~na_if(., -77)) %>%
  mutate_if(is.factor, ~na_if(., "Seen but not answered")) %>% # Recode missing values to NAs in factor variables
  mutate_if(is.factor, ~na_if(., "Don't know")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to say")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Seen but not answered")) %>% # Drop empty factor levels
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Don't know")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to say"))

# Inspect dimensions
dim(dat.ed.glad.coping.id)
# Inspect colnames
colnames(dat.ed.glad.coping.id)
#Differences
dim(dat.ed.glad.coping)[1]-dim(dat.ed.glad.coping.id)[1]


```

### Read in ED data: GLAD ICB 
```{r}
dat.icb.glad <- readRDS(file = "../data_raw/diagnostics/icb_coping_glad.rds")

# Inspect dimensions
dim(dat.icb.glad)
# Inspect colnames
colnames(dat.icb.glad)

nrow(dat.icb.glad)

```

### Select variables: GLAD ICB
```{r glad select variables}

exclude_cols_dem <- c("ID",
                  "cohort_name")

dat.icb.glad.id <- dat.icb.glad %>% #new dataset with ID
  drop_na(externalDataReference) %>% # Drop NAs
  distinct(externalDataReference, .keep_all = TRUE) %>% 
#  add_column(cohort_name = "coping_glad", .before = "icb.making_yourself_vomit") %>% #create new column 
  select(
         ID = externalDataReference,# ID
     #    cohort_name, # Sample
        icb.making_yourself_vomit,
        icb.laxatives,
        icb.diuretics,
        icb.weight_loss_pills,
        icb.excessive_exercise,
        icb.fasting,
        icb.other_methods,
        icb.none,
        icb.making_yourself_vomit.1,
        icb.laxatives.1,
        icb.diuretics.1,
        icb.weight_loss_pills.1,
        icb.excessive_exercise.1,
        icb.fasting.1,
        icb.other_methods.1,
        icb.none.1,
        icb.average_made_low_weight,
      icb.binge_eating_wasthere_made,
      icb.any_other_methods_not_previously_listed,
      icb.any_other_methods_not_previously_listed.1,
      icb.exercised_excessively.1,
      icb.exercised_excessively.2,
      icb.fasted_or_did_not_eat.2,
      icb.made_yourself_vomit.1,
      icb.any_other_methods_not_previously_listed,
      icb.any_other_methods_not_previously_listed.1,
      icb.any_other_methods_not_previously_listed.2,
     icb.binge_eating_average_months,
     icb.icb_bingeing_engage_months
       
         ) %>%
  add_numeric(., exclude = exclude_cols_dem) %>%
  mutate_if(is.numeric, ~na_if(., -88)) %>% # Recode missing values to NAs in numeric variables
  mutate_if(is.numeric, ~na_if(., -99)) %>%
  mutate_if(is.numeric, ~na_if(., -77)) %>%
  mutate_if(is.factor, ~na_if(., "Seen but not answered")) %>% # Recode missing values to NAs in factor variables
  mutate_if(is.factor, ~na_if(., "Don't know")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to say")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Seen but not answered")) %>% # Drop empty factor levels
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Don't know")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to say"))

# Inspect dimensions
dim(dat.icb.glad.id)
# Inspect colnames
colnames(dat.icb.glad.id)
#Differences
dim(dat.icb.glad)[1]-dim(dat.icb.glad.id)[1]

```


### Read in ED data: GLAD BE
```{r}
dat.be.glad <- readRDS(file = "../data_raw/diagnostics/be_coping_glad.rds")

# Inspect dimensions
dim(dat.be.glad)
# Inspect colnames
colnames(dat.be.glad)

nrow(dat.be.glad)

```


### Select variables: GLAD BE
```{r glad select variables}

exclude_cols_dem <- c("ID",
                  "cohort_name")

dat.be.glad.id <- dat.be.glad %>% #new dataset with ID
  drop_na(externalDataReference) %>% # Drop NAs
  distinct(externalDataReference, .keep_all = TRUE) %>% 
 # add_column(cohort_name = "coping_glad", .before = "be.experience_regular_episodes_binge") %>% #create new column 
  select(
         ID = externalDataReference,# ID
       #  cohort_name, # Sample
        be.experience_regular_episodes_binge,
       be.binge_eating_follow_enter.txt,
       be.regularly_occurring_episodes_binge.txt,
       be.experience_regularly_occurring_binge,
       be.experience_regularly_occurring_binge.1,
       be.ate_regard_eating_binges,
       be.not_at_all_dependentcompletely_dependent,
       be.experience_regular_episodes_binge,
       be.binge_eating_episodes_experience.txt,
       be.regularly_occurring_episodes_binge,
        be.eat_much_more_rapidly_than_usual,
      be.eat_much_more_rapidly_than_usual.1,
      be.eat_much_more_rapidly_than_usual.2,
      be.eat_until_you_felt_uncomfortably_full,
      be.eat_until_you_felt_uncomfortably_full.1,
      be.feel_distressed_overeating_episodes

       
         ) %>%
  add_numeric(., exclude = exclude_cols_dem) %>%
  mutate_if(is.numeric, ~na_if(., -88)) %>% # Recode missing values to NAs in numeric variables
  mutate_if(is.numeric, ~na_if(., -99)) %>%
  mutate_if(is.numeric, ~na_if(., -77)) %>%
  mutate_if(is.factor, ~na_if(., "Seen but not answered")) %>% # Recode missing values to NAs in factor variables
  mutate_if(is.factor, ~na_if(., "Don't know")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to say")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Seen but not answered")) %>% # Drop empty factor levels
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Don't know")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to say"))

# Inspect dimensions
dim(dat.be.glad.id )
# Inspect colnames
colnames(dat.be.glad.id )
#Differences
dim(dat.be.glad)[1]-dim(dat.be.glad.id )[1]

```


### Read in ED data: AN NBR COPING
```{r}
dat.ed.nbr.coping <- readRDS(file = "../data_raw/diagnostics/an_coping_nbr.rds")

# Inspect dimensions
dim(dat.ed.nbr.coping)
# Inspect colnames
colnames(dat.ed.nbr.coping)

nrow(dat.ed.nbr.coping)

```

### Select variables: NBR AN
```{r glad select variables}

exclude_cols_dem <- c("ID",
                  "cohort_name")

dat.ed.nbr.coping.id <- dat.ed.nbr.coping %>% #new dataset with ID
  drop_na(subjectid) %>% # Drop NAs
  distinct(subjectid, .keep_all = TRUE) %>% 
  add_column(cohort_name = "coping_nbr", .before = "an.1.lowest_weight_weigh_weighed") %>% #create new column 
  select(
         ID = subjectid,# ID
         cohort_name, # Sample
         an.1.lowest_weight_weigh_weighed,           
         an.1.what_was_the_illness.txt,                
         an.1.low_weight_time,                         
         an.1.low_weight_time.1,                        
         an.1.low_weight_time.2,                       
         an.1.how_old_were_you_then.txt,                
         an.1.how_tall_were_you_then,                  
         an.1.how_tall_were_you_then.1,                 
         an.1.how_tall_were_you_then.2,                
         an.1.feel_fat_low_weight,                      
         an.1.gain_weight_low_weight,                  
         an.1.anorexia_nervosa_low_weight,              
         an.1.anorexia_nervosa_low_weight.1,           
         an.1.not_at_all_dependentcompletely_dependent, 
         an.1.low_weight_health_negative,              
         an.1.body_larger_low_weight = an.1.body_larger_people_thought, #Rename to same as GLAD               
         an.1.started_time_periods,                    
         an.1.low_weight_periods_stop = an.1.periods_stop_low_weight, #Rename to same as GLAD                   
         an.1.roughly_periods_stopped.txt,             
         an.1.for_how_long_did_your_periods_stop,       
         an.1.for_how_long_did_your_periods_stop.1
         ) %>%
  add_numeric(., exclude = exclude_cols_dem) %>%
  mutate_if(is.numeric, ~na_if(., -88)) %>% # Recode missing values to NAs in numeric variables
  mutate_if(is.numeric, ~na_if(., -99)) %>%
  mutate_if(is.numeric, ~na_if(., -77)) %>%
  mutate_if(is.factor, ~na_if(., "Seen but not answered")) %>% # Recode missing values to NAs in factor variables
  mutate_if(is.factor, ~na_if(., "Don't know")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to say")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Seen but not answered")) %>% # Drop empty factor levels
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Don't know")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to say"))

# Inspect dimensions
dim(dat.ed.nbr.coping.id)
# Inspect colnames
colnames(dat.ed.nbr.coping.id)
#Differences
dim(dat.ed.nbr.coping)[1]-dim(dat.ed.nbr.coping.id)[1]


```



### Read in ED data: NBR ICB 
```{r}
dat.icb.nbr <- readRDS(file = "../data_raw/diagnostics/icb_coping_nbr.rds")

# Inspect dimensions
dim(dat.icb.nbr)
# Inspect colnames
colnames(dat.icb.nbr)

nrow(dat.icb.nbr)

```

### Select variables: NBR ICB
```{r glad select variables}

exclude_cols_dem <- c("ID",
                  "cohort_name")

dat.icb.nbr.id <- dat.icb.nbr %>% #new dataset with ID
  drop_na(subjectid) %>% # Drop NAs
  distinct(subjectid, .keep_all = TRUE) %>% 
 # add_column(cohort_name = "coping_nbr", .before = "icb.making_yourself_vomit") %>% #create new column 
  select(
         ID = subjectid,# ID
      #   cohort_name, # Sample
        icb.making_yourself_vomit,
        icb.laxatives,
        icb.diuretics,
        icb.weight_loss_pills,
        icb.excessive_exercise,
        icb.fasting,
        icb.other_methods,
        icb.none,
        icb.making_yourself_vomit.1,
        icb.laxatives.1,
        icb.diuretics.1,
        icb.weight_loss_pills.1,
        icb.excessive_exercise.1,
        icb.fasting.1,
        icb.other_methods.1,
        icb.none.1,
        icb.average_made_low_weight = icb.made_average_low_weight,
      icb.binge_eating_wasthere_made,
      icb.any_other_methods_not_previously_listed,
      icb.any_other_methods_not_previously_listed.1,
      icb.exercised_excessively.1,
      icb.exercised_excessively.2,
      icb.fasted_or_did_not_eat.2,
      icb.made_yourself_vomit.1,
      icb.any_other_methods_not_previously_listed,
      icb.any_other_methods_not_previously_listed.1,
      icb.any_other_methods_not_previously_listed.2,
      icb.binge_eating_average_months,
      icb.icb_bingeing_engage_months
         ) %>%
  add_numeric(., exclude = exclude_cols_dem) %>%
  mutate_if(is.numeric, ~na_if(., -88)) %>% # Recode missing values to NAs in numeric variables
  mutate_if(is.numeric, ~na_if(., -99)) %>%
  mutate_if(is.numeric, ~na_if(., -77)) %>%
  mutate_if(is.factor, ~na_if(., "Seen but not answered")) %>% # Recode missing values to NAs in factor variables
  mutate_if(is.factor, ~na_if(., "Don't know")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to say")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Seen but not answered")) %>% # Drop empty factor levels
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Don't know")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to say"))

# Inspect dimensions
dim(dat.icb.nbr.id)
# Inspect colnames
colnames(dat.icb.nbr.id)
#Differences
dim(dat.icb.nbr)[1]-dim(dat.icb.nbr.id)[1]

```


### Read in ED data: GLAD BE
```{r}
dat.be.nbr <- readRDS(file = "../data_raw/diagnostics/be_coping_nbr.rds")

# Inspect dimensions
dim(dat.be.nbr)
# Inspect colnames
colnames(dat.be.nbr)

nrow(dat.be.nbr)

```


### Select variables: NBR BE
```{r glad select variables}

exclude_cols_dem <- c("ID",
                  "cohort_name")

dat.be.nbr.id <- dat.be.nbr %>% #new dataset with ID
  drop_na(subjectid) %>% # Drop NAs
  distinct(subjectid, .keep_all = TRUE) %>% 
  #add_column(cohort_name = "coping_nbr", .before = "be.experience_regular_episodes_binge") %>% #create new column 
  select(
         ID = subjectid,# ID
        # cohort_name, # Sample
        be.experience_regular_episodes_binge ,
        be.binge_eating_follow_enter.txt = be.binge_eating_follow_question.txt,
       be.regularly_occurring_episodes_binge.txt,
       be.regularly_occurring_episodes_binge,
       be.experience_regularly_occurring_binge,
       be.experience_regularly_occurring_binge.1,
       be.ate_regard_eating_binges,
       be.not_at_all_dependentcompletely_dependent,
       be.experience_regular_episodes_binge,
       be.binge_eating_episodes_experience.txt = be.binge_eating_experience_episodes.txt, #rename to same as GLAD
       be.eat_much_more_rapidly_than_usual,
      be.eat_much_more_rapidly_than_usual.1,
      be.eat_much_more_rapidly_than_usual.2,
      be.eat_until_you_felt_uncomfortably_full,
      be.eat_until_you_felt_uncomfortably_full.1,
      be.feel_distressed_overeating_episodes
         ) %>%
  add_numeric(., exclude = exclude_cols_dem) %>%
  mutate_if(is.numeric, ~na_if(., -88)) %>% # Recode missing values to NAs in numeric variables
  mutate_if(is.numeric, ~na_if(., -99)) %>%
  mutate_if(is.numeric, ~na_if(., -77)) %>%
  mutate_if(is.factor, ~na_if(., "Seen but not answered")) %>% # Recode missing values to NAs in factor variables
  mutate_if(is.factor, ~na_if(., "Don't know")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to say")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Seen but not answered")) %>% # Drop empty factor levels
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Don't know")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to say"))

# Inspect dimensions
dim(dat.be.nbr.id )
# Inspect colnames
colnames(dat.be.nbr.id )
#Differences
dim(dat.be.nbr)[1]-dim(dat.be.nbr.id )[1]

```

##Merge data - GLAD
```{r}

##GLAD data 1
dat.glad.1 <- left_join(dat.ed.glad.coping.id,
                  dat.be.glad.id,
                  by = "ID"
                )

##colnames 
colnames(dat.glad.1)

##number of people
nrow(dat.glad.1)

##GLAD data 2
dat.glad.2 <- left_join(dat.glad.1,
                        dat.icb.glad.id,
                        by = "ID"
                )

##colnames 
colnames(dat.glad.2)

##number of people
nrow(dat.glad.2)

```

##Merge data - NBR
```{r}
##NBR data 1
dat.nbr.1 <- left_join(dat.ed.nbr.coping.id,
                  dat.be.nbr.id,
                  by = "ID"
                )

##colnames 
colnames(dat.nbr.1)

##number of people
nrow(dat.nbr.1)

##GLAD data 2
dat.nbr.2 <- left_join(dat.nbr.1,
                        dat.icb.nbr.id,
                        by = "ID"
                )

##colnames 
colnames(dat.nbr.2)

##number of people
nrow(dat.nbr.2)
```
##Merge data - GLAD + NBR
```{r}
##NBR data 1
dat.ed <- rbind(dat.nbr.2,
                   dat.glad.2
                )

##colnames 
colnames(dat.ed)

##number of people
nrow(dat.ed)
```


############# DERIVED VARIABLES #####################

#Work out BMI 
BMI = kg/m2 

##Weight in kg
```{r}

##First need all numeric variables (lbs and kg are character for some reason)
dat.ed$weight_lbs_raw <- as.numeric(dat.ed$an.1.low_weight_time.1_numeric)

dat.ed$weight_kg_raw <- as.numeric(dat.ed$an.1.low_weight_time.2_numeric)
  
##To convert stone to kg, multiply by 6.35029
dat.ed$weight_kg <- NA_real_

dat.ed$weight_kg <-
  if_else(condition = is.na(dat.ed$weight_kg), 
         true = (
           (dat.ed$an.1.low_weight_time_numeric*6.35029) + 
             (dat.ed$weight_lbs_raw*0.453592)
           ), #weight in st and lbs converted to kg
         false = NA_real_,
         missing = NA_real_)


# Kilograms
dat.ed$weight_kg_unc <- 
  if_else(condition = is.na(dat.ed$weight_kg), 
         true = dat.ed$weight_kg_raw, #weight in kilos
         false = dat.ed$weight_kg,
         missing = NA_real_) 

# Summary
summary(dat.ed$weight_kg_unc)

```
## Clean weight in kg
```{r}
#Weight outlier
  # Define weight limits ***These are fairly arbitary and taken from the ED100K issue log. Will need to make final decisions soon.
  weight_upper_limit = 150 
  weight_lower_limit = 25
  
  #Identify number of outliers
  length(
    which(
      dat.ed$weight_kg_unc > weight_upper_limit |
        dat.ed$weight_kg_unc < weight_lower_limit
    )
  )
  
  #Remove weight outliers
  dat.ed <- dat.ed %>%
    mutate(
      weight_kg_final =
        if_else(
          weight_kg_unc > weight_upper_limit |
            weight_kg_unc < weight_lower_limit,
          true = NA_real_,
          false = weight_kg_unc,
          missing = NA_real_
        )
    )
  
  ##Check
  dat.ed %>%
    freq(weight_kg_final)
  
  
```

##Height in m
```{r}

##Change character variables to numeric
dat.ed$height_inches_numeric <- as.numeric(dat.ed$an.1.how_tall_were_you_then.1_numeric)

dat.ed$height_cm_numeric <- as.numeric(dat.ed$an.1.how_tall_were_you_then.2_numeric)


# Feet and inches to metres
dat.ed$height_m <- NA


dat.ed$height_m <- 
  if_else(
    condition = is.na(dat.ed$height_m),
    true = (
      (dat.ed$an.1.how_tall_were_you_then_numeric*0.3048) +
      (dat.ed$height_inches_numeric*0.0254)
       ),
    false = NA_real_,
    missing = NA_real_
    )

# Centimetres to metres
dat.ed$height_m_unc <- 
  if_else(
    condition = is.na(dat.ed$height_m),
    true = dat.ed$height_cm_numeric/100,
    false = dat.ed$height_m)

# Summary
summary(dat.ed$height_m_unc)
```
## Clean height in m
```{r}
#Height outlier
  # Define height limits ***These are fairly arbitary and taken from the ED100K issue log. Will need to make final decisions soon.
  height_upper_limit = 2.31 ##tallest person in the world is 2.31 metres
  height_lower_limit = 1
  
  #Identify number of outliers
  length(
    which(
      dat.ed$weight_kg_unc > height_upper_limit |
        dat.ed$weight_kg_unc < height_lower_limit
    )
  )
  
  #Remove height outliers
  dat.ed <- dat.ed %>%
    mutate(
     height_m_final =
        if_else(
          height_m_unc > height_upper_limit |
            height_m_unc < height_lower_limit,
          true = NA_real_,
          false = height_m_unc,
          missing = NA_real_
        )
    )
  
  ##Check
  dat.ed %>%
    freq(height_m_final)
  
  
```

## Work out BMI
```{r}

# Calculated from height and weight **This should be based on min weight and height - have quite low values <10 - need to check
dat.ed$bmi_unc <- NA

dat.ed$bmi_unc <- 
  if_else(condition = is.na(dat.ed$bmi_unc), 
         true = dat.ed$weight_kg_final/dat.ed$height_m_final^2, 
         false = NA_real_,
         missing = NA_real_)

# Summary
summary(dat.ed$bmi_unc)

```
#Frequency binge eating [GLAD+NBR]
Question: "How many episodes of binge eating would you usually experience in one month/one year/one week?"

One year = 52.1429 weeks
One month = 4.34524 weeks 
```{r ed.BE_freq conversion}
#Empty columns
dat.ed$ed.BE_freq_per_week <- NA

##Convert factors to numeric
dat.ed$binge_freq_per_yr <- as.numeric(dat.ed$be.binge_eating_episodes_experience.txt_numeric)

dat.ed$binge_freq_per_month <- as.numeric(dat.ed$be.binge_eating_follow_enter.txt_numeric)

dat.ed$binge_freq_per_wk <- as.numeric(dat.ed$be.regularly_occurring_episodes_binge.txt_numeric)


# Calculate frequency per week
dat.ed$ed.BE_freq_per_week <- 
  with(dat.ed,
    case_when(
      binge_freq_per_yr > 0 ~ round(binge_freq_per_yr/52.1429, digits = 2), #Episodes in one year
      binge_freq_per_month > 0 ~ round(binge_freq_per_month/4.34524, digits = 2),  #Episodes in one month
      binge_freq_per_wk > 0 ~ binge_freq_per_wk #Episodes in one week
      )
  )
  
#Summary
freq(dat.ed$ed.BE_freq_per_week) 
```

#Binge eating duration (BE) [EDGI & GLAD]
Converting to smallest unit first gives you more accurate estimates
One year = 365.25 days; One month = 30.4167 days
```{r ed.BE_duration conversion}
# Empty column
dat.ed$ed.BE_duration_months <- NA

# Change factor to numeric
dat.ed$binge_duration_years <- as.numeric(dat.ed$be.experience_regularly_occurring_binge_numeric)
dat.ed$binge_duration_months <- as.numeric(dat.ed$be.experience_regularly_occurring_binge.1_numeric)

##Contains -77, need to change to NA
dat.ed$binge_duration_years[dat.ed$binge_duration_years == -77] <- NA_real_
dat.ed$binge_duration_months[dat.ed$binge_duration_months == -77] <- NA_real_


# Sum years and months into months (first covert to days [i.e., smallest unit], then convert to months)
dat.ed$ed.BE_duration_months <- 
  if_else(condition = is.na(dat.ed$ed.BE_duration_months),
         true = (
           (dat.ed$binge_duration_years*365.25) + #Duration in years
             (dat.ed$binge_duration_months*30.4167)  #Duration in months
           ) / 30.4167, 
        false = NA_real_,
        missing = NA_real_)

# Summary
freq(dat.ed$ed.BE_duration_months)
```
#BE Behaviour score - Number of BE behaviours

#Export error in naming
be.eat_much_more_rapidly_than_usual = Eat much more rapidly than usual?
be.eat_much_more_rapidly_than_usual.1 = Eat until you felt uncomfortably full?
be.eat_much_more_rapidly_than_usual.2 = Eat large amounts of food when you didn't feel physically hungry?
be.eat_until_you_felt_uncomfortably_full = Eat alone because you were embarrassed by what/how much you were eating?
be.eat_until_you_felt_uncomfortably_full.1 = Feel ashamed/disgusted with yourself, depressed, or very guilty after overeating?
```{r ed.BE_behaviour_sum_numeric}

#Sum of binge eating behaviours
dat.ed$ed.BE_behaviour_sum_numeric <- rowSums(dat.ed[ ,
                                 c("be.eat_much_more_rapidly_than_usual_numeric",
                                   "be.eat_much_more_rapidly_than_usual.1_numeric",
                                   "be.eat_much_more_rapidly_than_usual.2_numeric",
                                   "be.eat_until_you_felt_uncomfortably_full_numeric",
                                   "be.eat_until_you_felt_uncomfortably_full.1_numeric")],
                                  na.rm = TRUE)

#Summary
freq(dat.ed$ed.BE_behaviour_sum_numeric)                                 
```

#### DSM 5 AN restricting
A. Restriction of energy intake relative to requirements,leading to a significantly low body weight in the context of age, sex, developmental trajectory, and physical health. Significantly low weight is defined as a weight that is less than minimally normal or, for children and adolescents, less than that minimally expected.

B. Intense fear of gaining weight or of becoming fat, or persistent behavior that interferes with weight gain, even though at a significantly low weight.

C. Disturbance in the way in which ones body weight or shape is experienced, undueinfluence of body weight or shape on self-evaluation, or persistent lack of recognition of the seriousness of the current low body weight.

Subtype of DSM-5 AN; All DSM5 AN symptoms are met, but...

Restricting type: During the last 3 months, the individual has not engaged in recurrent episodes of binge eating or purging behavior (i.e., self-induced vomiting or the misuse of laxatives, diuretics, or enemas). This subtype describes presentations in which weight loss is accomplished primarily through dieting, fasting, and/or excessive exercise.
```{r}
dat.ed$ed.DSM5_AN_restricting_binary_numeric <- 
  with(dat.ed,
  dplyr::if_else(
#A. Restriction of energy intake relative to requirements,leading to a significantly low body weight in the context of age, sex, developmental trajectory, and physical health. Significantly low weight is defined as a weight that is less than minimally normal or, for children and adolescents, less than that minimally expected.
    (
      bmi_unc <= 18.55 |
       bmi_unc <= 18.55 |
       bmi_unc <= 18.55
      ) &
      
      
#When you weighed much less than other people thought you ought to weigh or were at your lowest weight, was this due to an illness other than an eating disorder?
  an.1.lowest_weight_weigh_weighed == "No" &
 
#B. Intense fear of gaining weight or of becoming fat, or persistent behavior that interferes with weight gain, even though at a significantly low weight.
   
  #During the time when you were at this low weight, how afraid were you that you might gain weight or become fat?
  (
        an.1.gain_weight_low_weight == "Slightly afraid" |
      an.1.gain_weight_low_weight == "Somewhat afraid" |
      an.1.gain_weight_low_weight == "Very afraid" |
      an.1.gain_weight_low_weight == "Extremely afraid"
      ) &


#C. Disturbance in the way in which ones body weight or shape is experienced... 

  #During the time when you were at this low weight, did you still feel fat? 
  (
  (
    an.1.feel_fat_low_weight == "Slightly" | #***Check cut off!
     an.1.feel_fat_low_weight == "Somewhat" | 
     an.1.feel_fat_low_weight == "Very" |
     an.1.feel_fat_low_weight == "Extremely"
    ) |
    
  #During the time when you were at this low weight did you ever experience your body or parts of your body to be larger than they actually were or than other people thought they were?
  (
    an.1.body_larger_low_weight == "Somewhat" | 
     an.1.body_larger_low_weight == "Very much"
    ) |
  
#...undue influence of body weight or shape on self-evaluation
 
   #During the time when you were at this low weight, how dependent was your self-worth on your body shape or weight?
    (
    an.1.not_at_all_dependentcompletely_dependent == "1" | #***Check cut off!
    an.1.not_at_all_dependentcompletely_dependent == "2" | 
    an.1.not_at_all_dependentcompletely_dependent == "3" |
      an.1.not_at_all_dependentcompletely_dependent == "4" |
      an.1.not_at_all_dependentcompletely_dependent == "5" |
      an.1.not_at_all_dependentcompletely_dependent == "Completely Dependent"
  ) |

#...or persistent lack of recognition of the seriousness of the current low body weight.
  
  #Did you ever think your low weight had negative consequences for your health?
      an.1.low_weight_health_negative == "Not at all"
) &

  #Restricting type: During the last 3 months... 
  
  #...the individual has not engaged in recurrent episodes of binge eating or purging behavior (i.e., self-induced vomiting or the misuse of laxatives, diuretics, or enemas)...

  #Did you experience regular episodes of binge eating while at your lowest weight?
  (
  (
    be.experience_regular_episodes_binge == "No" |
     is.na(be.experience_regular_episodes_binge) #***Perhaps don't include NA??
   ) & 

  ##During the period of time when you were at your lowest weight, did you use any of the following as a way to control yourweight or shape? .
  (
    icb.making_yourself_vomit.1 == "Not Making yourself vomit" |
     is.na(icb.making_yourself_vomit.1)
    ) & 

      (
    icb.laxatives.1 == "Not Laxatives"
   | is.na(icb.laxatives.1)
   ) &
  
  (icb.diuretics.1 == "Not Diuretics" |
     is.na(icb.diuretics.1)
   ) &  

  #...This subtype describes presentations in which weight loss is accomplished primarily through dieting, fasting, and/or excessive exercise.
  
    #During the period of time when you were at your lowest weight, did you use any of the following as a way to control yourweight or shape? .
    (
      icb.excessive_exercise.1 == "Excessive exercise" |
     icb.fasting.1 == "Fasting"
     )
  ),

    true = 1,
    false = 0,
    missing = NA_real_)
  )
  
#Recode numeric to factor
dat.ed$ed.DSM5_AN_restricting_binary <-
  recode_factor(dat.ed$ed.DSM5_AN_restricting_binary_numeric,
                "0" = "No DSM5 AN restricting",
                "1" = "DSM5 AN restricting"
                )

#Summary
freq(dat.ed$ed.DSM5_AN_restricting_binary)


#Check which cohort they are from
ANR_cases <- dat.ed %>%
  filter(ed.DSM5_AN_restricting_binary == "DSM5 AN restricting")

freq(ANR_cases$cohort_name)
```
#### DSM 5 AN binge eating/purging

A. Restriction of energy intake relative to requirements,leading to a significantly low body weight in the context of age, sex, developmental trajectory, and physical health. Significantly low weight is defined as a weight that is less than minimally normal or, for children and adolescents, less than that minimally expected.

B. Intense fear of gaining weight or of becoming fat, or persistent behavior that interferes with weight gain, even though at a significantly low weight.

C. Disturbance in the way in which ones body weight or shape is experienced, undueinfluence of body weight or shape on self-evaluation, or persistent lack of recognition of the seriousness of the current low body weight.

Subtype of DSM-5 AN; All DSM5 AN symptoms are met, but...

Binge eating/purging subtype: During the last 3 months, the individual has engaged in recurrent episodes of binge-eating or purging behavior (i.e., self-induced vomiting or the misuse of laxatives, diuretics, or enemas).
```{r}
dat.ed$ed.DSM5_AN_binge_purge_binary_numeric <- 
  with(dat.ed,
  dplyr::if_else(
#A. Restriction of energy intake relative to requirements,leading to a significantly low body weight in the context of age, sex, developmental trajectory, and physical health. Significantly low weight is defined as a weight that is less than minimally normal or, for children and adolescents, less than that minimally expected.
    (
      bmi_unc <= 18.55 |
       bmi_unc <= 18.55 |
       bmi_unc <= 18.55
      ) &
      
      
#When you weighed much less than other people thought you ought to weigh or were at your lowest weight, was this due to an illness other than an eating disorder?
  an.1.lowest_weight_weigh_weighed == "No" &
 
#B. Intense fear of gaining weight or of becoming fat, or persistent behavior that interferes with weight gain, even though at a significantly low weight.
   
  #During the time when you were at this low weight, how afraid were you that you might gain weight or become fat?
  (
        an.1.gain_weight_low_weight == "Slightly afraid" |
      an.1.gain_weight_low_weight == "Somewhat afraid" |
      an.1.gain_weight_low_weight == "Very afraid" |
      an.1.gain_weight_low_weight == "Extremely afraid"
      ) &


#C. Disturbance in the way in which ones body weight or shape is experienced... 

  #During the time when you were at this low weight, did you still feel fat? 
  (
  (
    an.1.feel_fat_low_weight == "Slightly" | #***Check cut off!
     an.1.feel_fat_low_weight == "Somewhat" | 
     an.1.feel_fat_low_weight == "Very" |
     an.1.feel_fat_low_weight == "Extremely"
    ) |
    
  #During the time when you were at this low weight did you ever experience your body or parts of your body to be larger than they actually were or than other people thought they were?
  (
    an.1.body_larger_low_weight == "Somewhat" | 
     an.1.body_larger_low_weight == "Very much"
    ) |
  
#...undue influence of body weight or shape on self-evaluation
 
   #During the time when you were at this low weight, how dependent was your self-worth on your body shape or weight?
    (
    an.1.not_at_all_dependentcompletely_dependent == "1" | #***Check cut off!
    an.1.not_at_all_dependentcompletely_dependent == "2" | 
    an.1.not_at_all_dependentcompletely_dependent == "3" |
      an.1.not_at_all_dependentcompletely_dependent == "4" |
      an.1.not_at_all_dependentcompletely_dependent == "5" |
      an.1.not_at_all_dependentcompletely_dependent == "Completely Dependent"
  ) |

#...or persistent lack of recognition of the seriousness of the current low body weight.
  
  #Did you ever think your low weight had negative consequences for your health?
      an.1.low_weight_health_negative == "Not at all"
) &
  
  ##Binge eating/purging subtype: During the last 3 months... 
  
  #...the individual has engaged in recurrent episodes of binge-eating... 
  
  #Did you experience regular episodes of binge eating while at your lowest weight?
  (
    (be.experience_regular_episodes_binge == "only during times of low weight" |
     be.experience_regular_episodes_binge == "At times of low weight and at times outside of low weight" |
      is.na(be.experience_regular_episodes_binge)
     ) | 
      
      #...or purging behavior (i.e., self-induced vomiting or the misuse of laxatives, diuretics, or enemas).
      
      #During the period of time when you were at your lowest weight, did you use any of the following as a way to control your weight or shape?
      
  (
    icb.making_yourself_vomit.1 == "Making yourself vomit" |
      icb.laxatives.1 == "Laxatives" |
     icb.diuretics.1 == "Diuretics"
    )
  ),

#Not included absence of fasting and/or exercise because ANBP captures people who are restricting but ALSO binge and/or purge (on top of restricting behaviour)
    true = 1,
    false = 0,
    missing = NA_real_)
  )
  
#Recode numeric to factor
dat.ed$ed.DSM5_ANBP_binary <-
  recode_factor(dat.ed$ed.DSM5_AN_binge_purge_binary_numeric,
                "0" = "No DSM5 AN binge eating/purging",
                "1" = "DSM5 AN binge eating/purging")


#Summary
freq(dat.ed$ed.DSM5_ANBP_binary)

#Check which cohort they are from
ANBP_cases <- dat.ed %>%
  filter(ed.DSM5_ANBP_binary == "DSM5 AN binge eating/purging")

freq(ANBP_cases$cohort_name)
```


##DSM 5 BULIMIA NERVOSA
A. Recurrent episodes of binge eating. An episode of binge eating is characterized by both of the following:

  1. Eating, in a discrete period of time (e.g., within any 2-hour period), an amount of food that is definitely larger than what most individuals would eat in a similar period of time under similar circumstances.
  2. A sense of lack of control over eating during the episode (e.g., a feeling that one cannot stop eating or control what or how much one is eating).

B. Recurrent inappropriate compensatory behaviors in order to prevent weight gain,such as self-induced vomiting; misuse of laxatives, diuretics, or other medications; fasting; or excessive exercise.

C. The binge eating and inappropriate compensatory behaviors both occur, on average, at least once a week for 3 months.

D. Self-evaluation is unduly influenced by body shape and weight.

E. The disturbance does not occur exclusively during episodes of anorexia nervosa.


NB: Variables have been mislabelled in COPING. I think: 

icb.exercised_excessively.1 = Fasted or did not eat
icb.exercised_excessively.2 = Used diet pills
icb.fasted_or_did_not_eat.2 = Exercised excessively
icb.made_yourself_vomit.1 = Made yourself vomit
icb.any_other_methods_not_previously_listed = Used laxatives
icb.any_other_methods_not_previously_listed.1 = Used diuretics
icb.any_other_methods_not_previously_listed.2 = Any other methods not previously listed

```{r ed.BN_DSM5_binary}

#Bulimia nervosa numeric variable
dat.ed$ed.DSM5_BN_binary_numeric <- 
  with(dat.ed,
  dplyr::if_else(

#A. Recurrent episodes of binge eating. An episode of binge eating is characterized by both of the following:

    #1. Eating, in a discrete period of time (e.g., within any 2-hour period), an amount of food that is definitely larger than what most individuals would eat in a similar period of time under similar circumstances.
    
    ##Have you ever had regular episodes of overeating or eating binges when you ate what most people would regard as an unusually large amount of food in a short period of time?
    be.ate_regard_eating_binges == "Yes" & 

      #2. A sense of lack of control over eating during the episode (e.g., a feeling that one cannot stop eating or control what or how much one is eating).
      
      #When you were having regularly occurring episodes of binge eating or overeating, did you feel that your eating was out of control such that you felt you could not stop eating, or that you could not control what or how much you were eating?
      
        (
          be.regularly_occurring_episodes_binge == "Slightly" | #**Check cut off!
         be.regularly_occurring_episodes_binge == "Somewhat" |
         be.regularly_occurring_episodes_binge == "Very" |
         be.regularly_occurring_episodes_binge == "Extremely"
         ) & 

      #B. Recurrent inappropriate compensatory behaviors in order to prevent weight gain, such as self-induced vomiting; misuse of laxatives, diuretics, or other medications; fasting; or excessive exercise. [these variables are referring to ICBs to control weight or shape, i.e. not necessarily in response to binge eating]
          (
            icb.made_yourself_vomit.1 == "A few times" |  #Vomiting
          icb.made_yourself_vomit.1 == "Often" | 
            
          icb.any_other_methods_not_previously_listed == "A few times" | #Laxtives
          icb.any_other_methods_not_previously_listed == "Often" |
            
          icb.any_other_methods_not_previously_listed.1  == "A few times" | #Diuretics
          icb.any_other_methods_not_previously_listed.1  =="Often" |
            
          icb.exercised_excessively.2 == "A few times" | #Diet pills
          icb.exercised_excessively.2 == "Often" |
            
          icb.fasted_or_did_not_eat.2 == "A few times" | #Excessive exercise
          icb.fasted_or_did_not_eat.2 == "Often" |
            
          icb.exercised_excessively.1 == "A few times" | #Fasting
          icb.exercised_excessively.1 == "Often"
          ) & 

      #C. The binge eating and inappropriate compensatory behaviors both occur, on average, at least once a week for 3 months.
      (
        ed.BE_freq_per_week >= 0.95 & # Binge eating per week 
      ed.BE_duration_months >= 2.95 # Binge eating total duration 
      ) & 

      #B. Recurrent inappropriate compensatory behaviors in order to prevent weight gain, such as self-induced vomiting; misuse of laxatives, diuretics, or other medications; fasting; or excessive exercise. [these variables are referring to ICBs in response to binge eating]
        (
          icb.making_yourself_vomit == "Making yourself vomit" |
        icb.laxatives == "Laxatives" |
        icb.diuretics == "Diuretics" |
        icb.weight_loss_pills == "Weight loss pills" |
        icb.excessive_exercise == "Excessive exercise" |
        icb.fasting == "Fasting"
        ) & 

      #C. The binge eating and inappropriate compensatory behaviors both occur, on average, at least once a week for 3 months.
      
      #Did the binge eating and compensatory behaviours occur at the same time, on average, once a week for 3 months?
      
      (
        icb.binge_eating_average_months == "Yes" | #***Ask Molly - does everyone get asked this? 
  is.na(icb.binge_eating_average_months)
  ) & 

    #D. Self-evaluation is unduly influenced by body shape and weight.
         
    #During the time when you were binge eating, how dependent was your self-worth on your body shape or weight?
    (
    be.not_at_all_dependentcompletely_dependent == "1" | #***Check cut off!
    be.not_at_all_dependentcompletely_dependent == "2" | 
    be.not_at_all_dependentcompletely_dependent == "3" |
      be.not_at_all_dependentcompletely_dependent == "4" |
      be.not_at_all_dependentcompletely_dependent == "5" |
      be.not_at_all_dependentcompletely_dependent == "Completely Dependent"
  ) &

    #E. The disturbance does not occur exclusively during episodes of anorexia nervosa.
        (
          be.experience_regular_episodes_binge == "At times of low weight and at times outside of low weight" | 
         be.experience_regular_episodes_binge == "No" |
         is.na(be.experience_regular_episodes_binge)
         ),
    true = 1,
    false = 0,
    missing = NA_real_)
  )
  
#Recode numeric variable to factor
dat.ed$ed.DSM5_BN_binary <-
  recode_factor(dat.ed$ed.DSM5_BN_binary_numeric,
                "0" = "No DSM-5 BN",
                "1" = "DSM-5 BN")

#Summary
freq(dat.ed$ed.DSM5_BN_binary)
```

#DSM-5 BED algorithm [EDGI]
A. Recurrent episodes of binge eating. An episode of binge eating is characterized by both of the following:
  1. Eating, in a discrete period of time (e.g., within any 2-hour period), an amount of food that is definitely larger than what most people would eat in a similar period of time under similar circumstances.

2. A sense of lack of control over eating during the episode (e.g., a feeling that one cannot stop eating or control what or how much one is eating).

B. The binge-eating episodes are associated with three (or more) of the following:
  1. Eating much more rapidly than normal.
  2. Eating until feeling uncomfortably full.
  3. Eating large amounts of food when not feeling physically hungry.
  4. Eating alone because of feeling embarrassed by how much one is eating.
  5. Feeling disgusted with oneself, depressed, or very guilty afterward.

C. Marked distress regarding binge eating is present.

D. The binge eating occurs, on average, at least once a week for 3 months.

E. The binge eating is not associated with the recurrent use of inappropriate compensatory behavior as in bulimia nen/osa and does not occur exclusively during the course of bulimia nervosa or anorexia nervosa.
```{r ed.BED_DSM5_binary}

#BED numeric variable
dat.ed$ed.DSM5_BED_binary_numeric <- 
  with(dat.ed,
  dplyr::if_else(
#A. Recurrent episodes of binge eating. An episode of binge eating is characterized by both of the following:

    #1. Eating, in a discrete period of time (e.g., within any 2-hour period), an amount of food that is definitely larger than what most people would eat in a similar period of time under similar circumstances
    be.ate_regard_eating_binges == "Yes" & 

  #2. A sense of lack of control over eating during the episode (e.g., a feeling that one cannot stop eating or control what or how much one is eating)
      (
          be.regularly_occurring_episodes_binge == "Slightly" | #**Check cut off!
         be.regularly_occurring_episodes_binge == "Somewhat" |
         be.regularly_occurring_episodes_binge == "Very" |
         be.regularly_occurring_episodes_binge == "Extremely"
         ) &  
#B. The binge-eating episodes are associated with three (or more) of the following:
  #1. Eating much more rapidly than normal.
  #2. Eating until feeling uncomfortably full.
  #3. Eating large amounts of food when not feeling physically hungry.
  #4. Eating alone because of feeling embarrassed by how much one is eating.
  #5. Feeling disgusted with oneself, depressed, or very guilty afterward.
 
   ed.BE_behaviour_sum_numeric >= 3 & 

  #C. Marked distress regarding binge eating is present.       
  (be.feel_distressed_overeating_episodes == "Yes") & 

  #D. The binge eating occurs, on average, at least once a week for 3 months.
 
   (ed.BE_freq_per_week >= 0.95 & # Binge eating per week 
      ed.BE_duration_months >= 2.95) & # Binge eating total duration 

  #E. The binge eating is not associated with the recurrent use of inappropriate compensatory behavior as in bulimia nervosa... 
  (icb.icb_bingeing_engage_months == "Yes, 3 months DID NOT engage in ICB while bingeing") &
    # is.na(ed.ICB_BE_no_ICB_3_mo)) &  

  #...and does not occur exclusively during the course of bulimia nervosa or anorexia nervosa.  
  (be.experience_regular_episodes_binge == "At times of low weight and at times outside of low weight"
    | be.experience_regular_episodes_binge == "No"
    | is.na(be.experience_regular_episodes_binge)),
    true = 1,
    false = 0,
    missing = NA_real_)
    )
    
#Recode numeric to factor
dat.ed$ed.DSM5_BED_binary <-
  recode_factor(dat.ed$ed.DSM5_BED_binary_numeric,
                "0" = "No DSM-5 BED",
                "1" = "DSM-5 BED")

#Summary
freq(dat.ed$ed.DSM5_BED_binary)

```

## SELF-REPORTED DIAGNOSES ##

```{r}
 glad.coping.mhd.raw <- readRDS(file = "../data_raw/glad/mhd_coping_glad.rds")
  dim(glad.coping.mhd.raw)
  colnames(glad.coping.mhd.raw)
```

```{r}

exclude_cols <- c("cohort_name",
                  "ID")

 glad.coping.mhd.raw.id <- glad.coping.mhd.raw  %>%
    drop_na(externalDataReference) %>% # Drop NAs
    distinct(externalDataReference, .keep_all = TRUE) %>% # Remove duplicates based on ID
    #separate(externalDataReference, into = c("Sample", "ID"), sep = 4) %>% # Split ID in Sample and Number
    # mutate(ID = as.numeric(ID)) %>%
    add_column(cohort_name = "coping_glad", .before = "startDate") %>% #create new column 
    select(
      ID = externalDataReference, # ID
     cohort_name, # Sample
       mhd.anorexia_nervosa,
       mhd.atypical_anorexia_nervosa,
       mhd.bulimia_nervosa,
       mhd.bingeeating_disorder
    ) %>%
    add_numeric(., exclude = exclude_cols) %>%
    mutate_if(is.numeric, ~na_if(., -88)) %>% # Recode missing values to NAs in numeric variables
    mutate_if(is.numeric, ~na_if(., -99)) %>%
    mutate_if(is.numeric, ~na_if(., -77)) %>%
    mutate_if(is.factor, ~na_if(., "Seen but not answered")) %>% # Recode missing values to NAs in factor variables
    mutate_if(is.factor, ~na_if(., "Don't know")) %>%
    mutate_if(is.factor, ~na_if(., "Prefer not to say")) %>%
    mutate_if(is.factor, ~na_if(., "Prefer not to answer")) %>%
    mutate_if(is.factor, ~forcats::fct_drop(., only = "Seen but not answered")) %>% # Drop empty factor levels
    mutate_if(is.factor, ~forcats::fct_drop(., only = "Don't know")) %>%
    mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to answer")) %>%
    mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to say"))
  # Inspect dimensions
  dim(glad.coping.mhd.raw.id)
  # Inspect colnames
  colnames(glad.coping.mhd.raw.id)
  #Differences
  dim(glad.coping.mhd.raw)[1]-dim(glad.coping.mhd.raw.id)[1]
  
```


```{r}
nbr.mhd.raw <- readRDS(file = "../data_raw/nbr/mhd_coping_nbr.rds")
  dim(nbr.mhd.raw)
  colnames(nbr.mhd.raw)
```


```{r}
exclude_cols <- c("cohort_name",
                    "ID")
  nbr.mhd.raw.id <- nbr.mhd.raw %>%
    drop_na(subjectid) %>% # Drop NAs
    distinct(subjectid, .keep_all = TRUE) %>% # Remove duplicates based on ID
    #separate(subjectid, into = c("Sample", "ID.intm"), sep = 6) %>% # Split ID in Sample and Number
    #separate(ID.intm, into = "ID", sep = 7) %>%
    add_column(cohort_name = "nbr", .after = "subjectid") %>% #create new column 
    select(
     ID = subjectid, # ID
     cohort_name, # Sample
       mhd.anorexia_nervosa,
       mhd.atypical_anorexia_nervosa,
       mhd.bulimia_nervosa,
       mhd.bingeeating_disorder
    ) %>%
    add_numeric(., exclude = exclude_cols) %>%
    mutate_if(is.numeric, ~na_if(., -88)) %>% # Recode missing values to NAs in numeric variables
    mutate_if(is.numeric, ~na_if(., -99)) %>%
    mutate_if(is.numeric, ~na_if(., -77)) %>%
    mutate_if(is.factor, ~na_if(., "Seen but not answered")) %>% # Recode missing values to NAs in factor variables
    mutate_if(is.factor, ~na_if(., "Don't know")) %>%
    mutate_if(is.factor, ~na_if(., "Prefer not to say")) %>%
    mutate_if(is.factor, ~na_if(., "Prefer not to answer")) %>%
    mutate_if(is.factor, ~forcats::fct_drop(., only = "Seen but not answered")) %>% # Drop empty factor levels
    mutate_if(is.factor, ~forcats::fct_drop(., only = "Don't know")) %>%
    mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to answer")) %>%
    mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to say"))
  # Inspect dimensions
  dim(nbr.mhd.raw.id)
  # Inspect colnames
  colnames(nbr.mhd.raw.id)
  #Differences
  dim(nbr.mhd.raw)[1]-dim(nbr.mhd.raw.id)[1]
```

## RAMP MHD
```{r}
ramp.mhd.raw <- readRDS(file = "../data_raw/ramp/health_mhq_ramp.rds")
  dim(ramp.mhd.raw)
  colnames(ramp.mhd.raw)
```

# Select columns
```{r}
  
  exclude_cols <- c("cohort_name",
                    "ID")
  
  ramp.mhd.raw.id <- ramp.mhd.raw %>%
    drop_na(`Login ID`) %>% # Drop NAs
    distinct(`Login ID`, .keep_all = TRUE) %>% # Remove duplicates based on ID
    #separate(`Login ID`, into = c("Sample", "ID"), sep = 4) %>% # Split ID in Sample and Number
    #separate(ID, into = "ID", sep = 7) %>%
    add_column(cohort_name = "ramp", .before = "startDate") %>% #create new column 
    select(
      ID = `Login ID`, # ID
      cohort_name, # Sample
       mhd.anorexia_nervosa = mhq.anorexia_nervosa,
      mhd.atypical_anorexia_nervosa = mhq.atypical_anorexia_nervosa,
      mhd.bulimia_nervosa = mhq.bulimia_nervosa,
      mhd.bingeeating_disorder= mhq.psychological_overeating_or_bingeeating_disorder
    ) %>%
    add_numeric(., exclude = exclude_cols) %>%
    mutate_if(is.numeric, ~na_if(., -88)) %>% # Recode missing values to NAs in numeric variables
    mutate_if(is.numeric, ~na_if(., -99)) %>%
    mutate_if(is.numeric, ~na_if(., -77)) %>%
    mutate_if(is.factor, ~na_if(., "Seen but not answered")) %>% # Recode missing values to NAs in factor variables
    mutate_if(is.factor, ~na_if(., "Don't know")) %>%
    mutate_if(is.factor, ~na_if(., "Prefer not to say")) %>%
    mutate_if(is.factor, ~na_if(., "Prefer not to answer")) %>%
    mutate_if(is.factor, ~forcats::fct_drop(., only = "Seen but not answered")) %>% # Drop empty factor levels
    mutate_if(is.factor, ~forcats::fct_drop(., only = "Don't know")) %>%
    mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to answer")) %>%
    mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to say"))
  # Inspect dimensions
  dim(ramp.mhd.raw.id)
  # Inspect colnames
  colnames(ramp.mhd.raw.id)
  #Differences
  dim(ramp.mhd.raw)[1]-dim(ramp.mhd.raw.id)[1]
```
##EDGI MHD
```{r}
 edgi.mhd.raw <- readRDS(file = "../data_raw/edgi/mhd_edgi.rds")
  dim(edgi.mhd.raw)
  colnames(edgi.mhd.raw)
```

## select columns 
```{r}
edgi.mhd.raw.id <- edgi.mhd.raw %>%
    drop_na(externalDataReference) %>% # Drop NAs
    distinct(externalDataReference, .keep_all = TRUE) %>% # Remove duplicates based on ID
    #separate(externalDataReference, into = c("Sample", "ID"), sep = 4) %>% # Split ID in Sample and Number
    # mutate(ID = as.numeric(ID)) %>%
    add_column(cohort_name = "coping_edgi", .before = "startDate") %>% #create new column 
    select(
      ID = externalDataReference, # ID
      cohort_name, # Sample
      mhd.anorexia_nervosa,
      mhd.atypical_anorexia_nervosa,
       mhd.bulimia_nervosa,
       mhd.bingeeating_disorder
    ) %>%
    add_numeric(., exclude = exclude_cols) %>%
    mutate_if(is.numeric, ~na_if(., -88)) %>% # Recode missing values to NAs in numeric variables
    mutate_if(is.numeric, ~na_if(., -99)) %>%
    mutate_if(is.numeric, ~na_if(., -77)) %>%
    mutate_if(is.factor, ~na_if(., "Seen but not answered")) %>% # Recode missing values to NAs in factor variables
    mutate_if(is.factor, ~na_if(., "Don't know")) %>%
    mutate_if(is.factor, ~na_if(., "Prefer not to say")) %>%
    mutate_if(is.factor, ~na_if(., "Prefer not to answer")) %>%
    mutate_if(is.factor, ~forcats::fct_drop(., only = "Seen but not answered")) %>% # Drop empty factor levels
    mutate_if(is.factor, ~forcats::fct_drop(., only = "Don't know")) %>%
    mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to answer")) %>%
    mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to say"))
  # Inspect dimensions
  dim(edgi.mhd.raw.id)
  # Inspect colnames
  colnames(edgi.mhd.raw.id)
  #Differences
  dim(edgi.mhd.raw.id)[1]-dim(edgi.mhd.raw.id)[1]
```


##Merge MHD data - GLAD + NBR
```{r}
##NMHD data
dat.mhd <- rbind(nbr.mhd.raw.id,
                   glad.coping.mhd.raw.id
                )

##colnames 
colnames(dat.mhd)

##number of people
nrow(dat.mhd)
```
##Merge MHD data - GLAD + NBR with EDGI
```{r}
##NMHD data
dat.mhd <- rbind(dat.mhd,
                   edgi.mhd.raw.id
                )

##colnames 
colnames(dat.mhd)

##number of people
nrow(dat.mhd)
```

##Merge MHD data - GLAD + NBR + EDGI with RAMP
```{r}
##MHD data with RAMP
all_mhd <- rbind(ramp.mhd.raw.id,
               dat.mhd
               )
##colnames 
colnames(all_mhd)

##number of people
nrow(all_mhd)
```



##Merge MHD data with ED data - ALL datasets

```{r}
dat.ed <- left_join(all_mhd,
                    dat.ed,
                        by = c("ID",
                               "cohort_name")
                )

##colnames 
colnames(dat.ed)

##number of people
nrow(dat.ed)

```

##Self reported AN
```{r}
#Freq
dat.ed %>%
  freq(mhd.anorexia_nervosa) #2760

```
## New column: self-reported AND/OR algorithm-derived ANR/ANBP
```{r}

dat.ed <- dat.ed %>%
  mutate(
    anorexia_group_numeric =
           case_when(mhd.anorexia_nervosa_numeric == 1 |
                       ed.DSM5_AN_restricting_binary_numeric == 1 ~ 1,
                     mhd.anorexia_nervosa_numeric == 0 &
                       ed.DSM5_AN_restricting_binary_numeric == 0 ~ 0,
                     mhd.anorexia_nervosa_numeric == 0 &
                       is.na(ed.DSM5_AN_restricting_binary_numeric) ~ 0,
                     is.na(mhd.anorexia_nervosa_numeric)  &
                       ed.DSM5_AN_restricting_binary_numeric == 0 ~ 0,
                     is.na(mhd.anorexia_nervosa_numeric) &
                       is.na(ed.DSM5_AN_restricting_binary_numeric) ~ NA_real_
           )
  )

#Check freq                    
dat.ed %>%
  freq(anorexia_group_numeric)
           
#Add factor variable 
dat.ed <- dat.ed %>%
    mutate(
      anorexia_group =
        recode_factor(anorexia_group_numeric,
                      "0" = "No anorexia nervosa",
                      "1" = "Self-reported and/or algorithm derived anorexia nervosa",
                      missing = NA_character_
        )
    )

#Check freq #2760 with AN
  dat.ed %>%
    freq(anorexia_group,
         cumul = F)
  
```

