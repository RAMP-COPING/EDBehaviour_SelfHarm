---
title: "COPING BN algorithm"
author: "Helena Davies"
date: "31/03/2021"
output: html_document
---

```{r Setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      comment=NA,
                      prompt=FALSE,
                      cache=FALSE)
```

Delete everything in your global environment
```{r Delete everything in your global environment}
remove(list = ls())
```

#### Call in library script

```{r source files}
source("./libraries.R")
```

#### Call in functions script

```{r source files}
source("./functions.R")
```

### Read in ED data: AN GLAD COPING
```{r}
dat.an.glad.coping <- readRDS(file = "../data_raw/diagnostics/an_coping_glad.rds")

# Inspect dimensions
dim(dat.an.glad.coping)
# Inspect colnames
colnames(dat.an.glad.coping)

nrow(dat.an.glad.coping)

```

### Select variables: GLAD BN
```{r glad select variables}

exclude_cols_dem <- c("ID",
                  "cohort_name")

dat.bn.glad.coping.id <- dat.an.glad.coping %>% #new dataset with ID
  drop_na(externalDataReference) %>% # Drop NAs
  distinct(externalDataReference, .keep_all = TRUE) %>% 
  add_column(cohort_name = "coping_glad", .before = "an.1.lowest_weight_weigh_weighed") %>% #create new column 
  select(
         ID = externalDataReference,# ID
         cohort_name, # Sample
         an.1.lowest_weight_weigh_weighed,           
         an.1.what_was_the_illness.txt,                
         an.1.low_weight_time,                         
         an.1.low_weight_time.1,                        
         an.1.low_weight_time.2,                       
         an.1.how_old_were_you_then.txt,                
         an.1.how_tall_were_you_then,                  
         an.1.how_tall_were_you_then.1,                 
         an.1.how_tall_were_you_then.2,                
         an.1.feel_fat_low_weight,                      
         an.1.gain_weight_low_weight,                  
         an.1.anorexia_nervosa_low_weight,              
         an.1.anorexia_nervosa_low_weight.1,           
         an.1.not_at_all_dependentcompletely_dependent, 
         an.1.low_weight_health_negative,              
         an.1.body_larger_low_weight,                   
         an.1.started_time_periods,                    
         an.1.low_weight_periods_stop,                  
         an.1.roughly_periods_stopped.txt,             
         an.1.for_how_long_did_your_periods_stop,       
         an.1.for_how_long_did_your_periods_stop.1
         ) %>%
  add_numeric(., exclude = exclude_cols_dem) %>%
  mutate_if(is.numeric, ~na_if(., -88)) %>% # Recode missing values to NAs in numeric variables
  mutate_if(is.numeric, ~na_if(., -99)) %>%
  mutate_if(is.numeric, ~na_if(., -77)) %>%
  mutate_if(is.factor, ~na_if(., "Seen but not answered")) %>% # Recode missing values to NAs in factor variables
  mutate_if(is.factor, ~na_if(., "Don't know")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to say")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Seen but not answered")) %>% # Drop empty factor levels
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Don't know")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to say"))

# Inspect dimensions
dim(dat.an.glad.coping.id)
# Inspect colnames
colnames(dat.an.glad.coping.id)
#Differences
dim(dat.an.glad.coping)[1]-dim(dat.an.glad.coping.id)[1]


```
### Read in ED data: AN GLAD ED100K 
```{r}
dat.an.glad.ed100k <- readRDS(file = "../data_raw/diagnostics/an_glad_ed.rds")

# Inspect dimensions
dim(dat.an.glad.ed100k)
# Inspect colnames
colnames(dat.an.glad.ed100k)

nrow(dat.an.glad.ed100k)

```



### Select variables: GLAD ED100K  ***Need to find the equivalent in the NBR dataset
```{r glad select variables}

exclude_cols_dem <- c("ID",
                  "cohort_name")

dat.an.glad.ed100k.id <- dat.an.glad.ed100k %>% #new dataset with ID
  drop_na(externalDataReference) %>% # Drop NAs
  distinct(externalDataReference, .keep_all = TRUE) %>% 
  add_column(cohort_name = "coping_glad", .before = "an.1.people_thought_weigh_weighed") %>% #create new column 
  select(
         ID = externalDataReference,# ID
         cohort_name, # Sample
        an.1.people_thought_weigh_weighed       
       ) %>%
  add_numeric(., exclude = exclude_cols_dem) %>%
  mutate_if(is.numeric, ~na_if(., -88)) %>% # Recode missing values to NAs in numeric variables
  mutate_if(is.numeric, ~na_if(., -99)) %>%
  mutate_if(is.numeric, ~na_if(., -77)) %>%
  mutate_if(is.factor, ~na_if(., "Seen but not answered")) %>% # Recode missing values to NAs in factor variables
  mutate_if(is.factor, ~na_if(., "Don't know")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to say")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Seen but not answered")) %>% # Drop empty factor levels
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Don't know")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to say"))

# Inspect dimensions
dim(dat.an.glad.ed100k.id)
# Inspect colnames
colnames(dat.an.glad.ed100k.id)
#Differences
dim(dat.an.glad.ed100k)[1]-dim(dat.an.glad.ed100k.id)[1]

```

### Read in ED data: GLAD ICB 
```{r}
dat.icb.glad <- readRDS(file = "../data_raw/diagnostics/icb_coping_glad.rds")

# Inspect dimensions
dim(dat.icb.glad)
# Inspect colnames
colnames(dat.icb.glad)

nrow(dat.icb.glad)

```

### Select variables: GLAD ICB
```{r glad select variables}

exclude_cols_dem <- c("ID",
                  "cohort_name")

dat.icb.glad.id <- dat.icb.glad %>% #new dataset with ID
  drop_na(externalDataReference) %>% # Drop NAs
  distinct(externalDataReference, .keep_all = TRUE) %>% 
#  add_column(cohort_name = "coping_glad", .before = "icb.making_yourself_vomit") %>% #create new column 
  select(
         ID = externalDataReference,# ID
     #    cohort_name, # Sample
        icb.making_yourself_vomit,
        icb.laxatives,
        icb.diuretics,
        icb.weight_loss_pills,
        icb.excessive_exercise,
        icb.fasting,
        icb.other_methods,
        icb.none,
        icb.making_yourself_vomit.1,
        icb.laxatives.1,
        icb.diuretics.1,
        icb.weight_loss_pills.1,
        icb.excessive_exercise.1,
        icb.fasting.1,
        icb.other_methods.1,
        icb.none.1,
        icb.average_made_low_weight,
     icb.binge_eating_wasthere_made
       
         ) %>%
  add_numeric(., exclude = exclude_cols_dem) %>%
  mutate_if(is.numeric, ~na_if(., -88)) %>% # Recode missing values to NAs in numeric variables
  mutate_if(is.numeric, ~na_if(., -99)) %>%
  mutate_if(is.numeric, ~na_if(., -77)) %>%
  mutate_if(is.factor, ~na_if(., "Seen but not answered")) %>% # Recode missing values to NAs in factor variables
  mutate_if(is.factor, ~na_if(., "Don't know")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to say")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Seen but not answered")) %>% # Drop empty factor levels
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Don't know")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to say"))

# Inspect dimensions
dim(dat.icb.glad.id)
# Inspect colnames
colnames(dat.icb.glad.id)
#Differences
dim(dat.icb.glad)[1]-dim(dat.icb.glad.id)[1]

```


### Read in ED data: GLAD BE
```{r}
dat.be.glad <- readRDS(file = "../data_raw/diagnostics/be_coping_glad.rds")

# Inspect dimensions
dim(dat.be.glad)
# Inspect colnames
colnames(dat.be.glad)

nrow(dat.be.glad)

```


### Select variables: GLAD BE
```{r glad select variables}

exclude_cols_dem <- c("ID",
                  "cohort_name")

dat.be.glad.id <- dat.be.glad %>% #new dataset with ID
  drop_na(externalDataReference) %>% # Drop NAs
  distinct(externalDataReference, .keep_all = TRUE) %>% 
 # add_column(cohort_name = "coping_glad", .before = "be.experience_regular_episodes_binge") %>% #create new column 
  select(
         ID = externalDataReference,# ID
       #  cohort_name, # Sample
        be.experience_regular_episodes_binge                    
       
         ) %>%
  add_numeric(., exclude = exclude_cols_dem) %>%
  mutate_if(is.numeric, ~na_if(., -88)) %>% # Recode missing values to NAs in numeric variables
  mutate_if(is.numeric, ~na_if(., -99)) %>%
  mutate_if(is.numeric, ~na_if(., -77)) %>%
  mutate_if(is.factor, ~na_if(., "Seen but not answered")) %>% # Recode missing values to NAs in factor variables
  mutate_if(is.factor, ~na_if(., "Don't know")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to say")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Seen but not answered")) %>% # Drop empty factor levels
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Don't know")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to say"))

# Inspect dimensions
dim(dat.be.glad.id )
# Inspect colnames
colnames(dat.be.glad.id )
#Differences
dim(dat.be.glad)[1]-dim(dat.be.glad.id )[1]

```


### Read in ED data: AN NBR COPING
```{r}
dat.an.nbr.coping <- readRDS(file = "../data_raw/diagnostics/an_coping_nbr.rds")

# Inspect dimensions
dim(dat.an.nbr.coping)
# Inspect colnames
colnames(dat.an.nbr.coping)

nrow(dat.an.nbr.coping)

```

### Select variables: NBR AN
```{r glad select variables}

exclude_cols_dem <- c("ID",
                  "cohort_name")

dat.an.nbr.coping.id <- dat.an.nbr.coping %>% #new dataset with ID
  drop_na(subjectid) %>% # Drop NAs
  distinct(subjectid, .keep_all = TRUE) %>% 
  add_column(cohort_name = "coping_nbr", .before = "an.1.lowest_weight_weigh_weighed") %>% #create new column 
  select(
         ID = subjectid,# ID
         cohort_name, # Sample
         an.1.lowest_weight_weigh_weighed,           
         an.1.what_was_the_illness.txt,                
         an.1.low_weight_time,                         
         an.1.low_weight_time.1,                        
         an.1.low_weight_time.2,                       
         an.1.how_old_were_you_then.txt,                
         an.1.how_tall_were_you_then,                  
         an.1.how_tall_were_you_then.1,                 
         an.1.how_tall_were_you_then.2,                
         an.1.feel_fat_low_weight,                      
         an.1.gain_weight_low_weight,                  
         an.1.anorexia_nervosa_low_weight,              
         an.1.anorexia_nervosa_low_weight.1,           
         an.1.not_at_all_dependentcompletely_dependent, 
         an.1.low_weight_health_negative,              
         an.1.body_larger_low_weight = an.1.body_larger_people_thought, #Rename to same as GLAD               
         an.1.started_time_periods,                    
         an.1.low_weight_periods_stop = an.1.periods_stop_low_weight, #Rename to same as GLAD                   
         an.1.roughly_periods_stopped.txt,             
         an.1.for_how_long_did_your_periods_stop,       
         an.1.for_how_long_did_your_periods_stop.1
         ) %>%
  add_numeric(., exclude = exclude_cols_dem) %>%
  mutate_if(is.numeric, ~na_if(., -88)) %>% # Recode missing values to NAs in numeric variables
  mutate_if(is.numeric, ~na_if(., -99)) %>%
  mutate_if(is.numeric, ~na_if(., -77)) %>%
  mutate_if(is.factor, ~na_if(., "Seen but not answered")) %>% # Recode missing values to NAs in factor variables
  mutate_if(is.factor, ~na_if(., "Don't know")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to say")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Seen but not answered")) %>% # Drop empty factor levels
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Don't know")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to say"))

# Inspect dimensions
dim(dat.an.nbr.coping.id)
# Inspect colnames
colnames(dat.an.nbr.coping.id)
#Differences
dim(dat.an.nbr.coping)[1]-dim(dat.an.nbr.coping.id)[1]


```



### Read in ED data: NBR ICB 
```{r}
dat.icb.nbr <- readRDS(file = "../data_raw/diagnostics/icb_coping_nbr.rds")

# Inspect dimensions
dim(dat.icb.nbr)
# Inspect colnames
colnames(dat.icb.nbr)

nrow(dat.icb.nbr)

```

### Select variables: NBR ICB
```{r glad select variables}

exclude_cols_dem <- c("ID",
                  "cohort_name")

dat.icb.nbr.id <- dat.icb.nbr %>% #new dataset with ID
  drop_na(subjectid) %>% # Drop NAs
  distinct(subjectid, .keep_all = TRUE) %>% 
 # add_column(cohort_name = "coping_nbr", .before = "icb.making_yourself_vomit") %>% #create new column 
  select(
         ID = subjectid,# ID
      #   cohort_name, # Sample
        icb.making_yourself_vomit,
        icb.laxatives,
        icb.diuretics,
        icb.weight_loss_pills,
        icb.excessive_exercise,
        icb.fasting,
        icb.other_methods,
        icb.none,
        icb.making_yourself_vomit.1,
        icb.laxatives.1,
        icb.diuretics.1,
        icb.weight_loss_pills.1,
        icb.excessive_exercise.1,
        icb.fasting.1,
        icb.other_methods.1,
        icb.none.1,
        icb.average_made_low_weight = icb.made_average_low_weight,
      icb.binge_eating_wasthere_made
       
         ) %>%
  add_numeric(., exclude = exclude_cols_dem) %>%
  mutate_if(is.numeric, ~na_if(., -88)) %>% # Recode missing values to NAs in numeric variables
  mutate_if(is.numeric, ~na_if(., -99)) %>%
  mutate_if(is.numeric, ~na_if(., -77)) %>%
  mutate_if(is.factor, ~na_if(., "Seen but not answered")) %>% # Recode missing values to NAs in factor variables
  mutate_if(is.factor, ~na_if(., "Don't know")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to say")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Seen but not answered")) %>% # Drop empty factor levels
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Don't know")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to say"))

# Inspect dimensions
dim(dat.icb.nbr.id)
# Inspect colnames
colnames(dat.icb.nbr.id)
#Differences
dim(dat.icb.nbr)[1]-dim(dat.icb.nbr.id)[1]

```


### Read in ED data: GLAD BE
```{r}
dat.be.nbr <- readRDS(file = "../data_raw/diagnostics/be_coping_nbr.rds")

# Inspect dimensions
dim(dat.be.nbr)
# Inspect colnames
colnames(dat.be.nbr)

nrow(dat.be.nbr)

```


### Select variables: NBR BE
```{r glad select variables}

exclude_cols_dem <- c("ID",
                  "cohort_name")

dat.be.nbr.id <- dat.be.nbr %>% #new dataset with ID
  drop_na(subjectid) %>% # Drop NAs
  distinct(subjectid, .keep_all = TRUE) %>% 
  #add_column(cohort_name = "coping_nbr", .before = "be.experience_regular_episodes_binge") %>% #create new column 
  select(
         ID = subjectid,# ID
        # cohort_name, # Sample
        be.experience_regular_episodes_binge                    
       
         ) %>%
  add_numeric(., exclude = exclude_cols_dem) %>%
  mutate_if(is.numeric, ~na_if(., -88)) %>% # Recode missing values to NAs in numeric variables
  mutate_if(is.numeric, ~na_if(., -99)) %>%
  mutate_if(is.numeric, ~na_if(., -77)) %>%
  mutate_if(is.factor, ~na_if(., "Seen but not answered")) %>% # Recode missing values to NAs in factor variables
  mutate_if(is.factor, ~na_if(., "Don't know")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to say")) %>%
  mutate_if(is.factor, ~na_if(., "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Seen but not answered")) %>% # Drop empty factor levels
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Don't know")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to answer")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to say"))

# Inspect dimensions
dim(dat.be.nbr.id )
# Inspect colnames
colnames(dat.be.nbr.id )
#Differences
dim(dat.be.nbr)[1]-dim(dat.be.nbr.id )[1]

```

##Merge data - GLAD
```{r}

##GLAD data 1
dat.glad.1 <- left_join(dat.an.glad.coping.id,
                  dat.be.glad.id,
                  by = "ID"
                )

##colnames 
colnames(dat.glad.1)

##number of people
nrow(dat.glad.1)

##GLAD data 2
dat.glad.2 <- left_join(dat.glad.1,
                        dat.icb.glad.id,
                        by = "ID"
                )

##colnames 
colnames(dat.glad.2)

##number of people
nrow(dat.glad.2)

```

##Merge data - NBR
```{r}
##NBR data 1
dat.nbr.1 <- left_join(dat.an.nbr.coping.id,
                  dat.be.nbr.id,
                  by = "ID"
                )

##colnames 
colnames(dat.nbr.1)

##number of people
nrow(dat.nbr.1)

##GLAD data 2
dat.nbr.2 <- left_join(dat.nbr.1,
                        dat.icb.nbr.id,
                        by = "ID"
                )

##colnames 
colnames(dat.nbr.2)

##number of people
nrow(dat.nbr.2)
```
##Merge data - GLAD + NBR
```{r}
##NBR data 1
dat.an <- rbind(dat.nbr.2,
                   dat.glad.2
                )

##colnames 
colnames(dat.an)

##number of people
nrow(dat.an)
```


############# AN RESTRICTING #####################

#Work out BMI 
BMI = kg/m2 

##Weight in kg
```{r}

##First need all numeric variables (lbs and kg are character for some reason)
dat.an$weight_lbs_raw <- as.numeric(dat.an$an.1.low_weight_time.1_numeric)

dat.an$weight_kg_raw <- as.numeric(dat.an$an.1.low_weight_time.2_numeric)
  
##To convert stone to kg, multiply by 6.35029
dat.an$weight_kg <- NA_real_

dat.an$weight_kg <-
  if_else(condition = is.na(dat.an$weight_kg), 
         true = (
           (dat.an$an.1.low_weight_time_numeric*6.35029) + 
             (dat.an$weight_lbs_raw*0.453592)
           ), #weight in st and lbs converted to kg
         false = NA_real_,
         missing = NA_real_)


# Kilograms
dat.an$weight_kg_unc <- 
  if_else(condition = is.na(dat.an$weight_kg), 
         true = dat.an$weight_kg_raw, #weight in kilos
         false = dat.an$weight_kg,
         missing = NA_real_) 

# Summary
summary(dat.an$weight_kg_unc)

```
## Clean weight in kg
```{r}
#Weight outlier
  # Define weight limits ***These are fairly arbitary and taken from the ED100K issue log. Will need to make final decisions soon.
  weight_upper_limit = 150 
  weight_lower_limit = 25
  
  #Identify number of outliers
  length(
    which(
      dat.an$weight_kg_unc > weight_upper_limit |
        dat.an$weight_kg_unc < weight_lower_limit
    )
  )
  
  #Remove weight outliers
  dat.an <- dat.an %>%
    mutate(
      weight_kg_final =
        if_else(
          weight_kg_unc > weight_upper_limit |
            weight_kg_unc < weight_lower_limit,
          true = NA_real_,
          false = weight_kg_unc,
          missing = NA_real_
        )
    )
  
  ##Check
  dat.an %>%
    freq(weight_kg_final)
  
  
```

##Height in m
```{r}

##Change character variables to numeric
dat.an$height_inches_numeric <- as.numeric(dat.an$an.1.how_tall_were_you_then.1_numeric)

dat.an$height_cm_numeric <- as.numeric(dat.an$an.1.how_tall_were_you_then.2_numeric)


# Feet and inches to metres
dat.an$height_m <- NA


dat.an$height_m <- 
  if_else(
    condition = is.na(dat.an$height_m),
    true = (
      (dat.an$an.1.how_tall_were_you_then_numeric*0.3048) +
      (dat.an$height_inches_numeric*0.0254)
       ),
    false = NA_real_,
    missing = NA_real_
    )

# Centimetres to metres
dat.an$height_m_unc <- 
  if_else(
    condition = is.na(dat.an$height_m),
    true = dat.an$height_cm_numeric/100,
    false = dat.an$height_m)

# Summary
summary(dat.an$height_m_unc)
```
## Clean height in m
```{r}
#Height outlier
  # Define height limits ***These are fairly arbitary and taken from the ED100K issue log. Will need to make final decisions soon.
  height_upper_limit = 2.31 ##tallest person in the world is 2.31 metres
  height_lower_limit = 1
  
  #Identify number of outliers
  length(
    which(
      dat.an$weight_kg_unc > height_upper_limit |
        dat.an$weight_kg_unc < height_lower_limit
    )
  )
  
  #Remove height outliers
  dat.an <- dat.an %>%
    mutate(
     height_m_final =
        if_else(
          height_m_unc > height_upper_limit |
            height_m_unc < height_lower_limit,
          true = NA_real_,
          false = height_m_unc,
          missing = NA_real_
        )
    )
  
  ##Check
  dat.an %>%
    freq(height_m_final)
  
  
```

## Work out BMI
```{r}

# Calculated from height and weight **This should be based on min weight and height - have quite low values <10 - need to check
dat.an$bmi_unc <- NA

dat.an$bmi_unc <- 
  if_else(condition = is.na(dat.an$bmi_unc), 
         true = dat.an$weight_kg_final/dat.an$height_m_final^2, 
         false = NA_real_,
         missing = NA_real_)

# Summary
summary(dat.an$bmi_unc)

```

#### DSM 5 AN restricting
A. Restriction of energy intake relative to requirements,leading to a significantly low body weight in the context of age, sex, developmental trajectory, and physical health. Significantly low weight is defined as a weight that is less than minimally normal or, for children and adolescents, less than that minimally expected.

B. Intense fear of gaining weight or of becoming fat, or persistent behavior that interferes with weight gain, even though at a significantly low weight.

C. Disturbance in the way in which one’s body weight or shape is experienced, undueinfluence of body weight or shape on self-evaluation, or persistent lack of recognition of the seriousness of the current low body weight.

Subtype of DSM-5 AN; All DSM5 AN symptoms are met, but...

Restricting type: During the last 3 months, the individual has not engaged in recurrent episodes of binge eating or purging behavior (i.e., self-induced vomiting or the misuse of laxatives, diuretics, or enemas). This subtype describes presentations in which weight loss is accomplished primarily through dieting, fasting, and/or excessive exercise.
```{r}
dat.an$ed.DSM5_AN_restricting_binary_numeric <- 
  with(dat.an,
  dplyr::if_else(
#A. Restriction of energy intake relative to requirements,leading to a significantly low body weight in the context of age, sex, developmental trajectory, and physical health. Significantly low weight is defined as a weight that is less than minimally normal or, for children and adolescents, less than that minimally expected.
    (
      bmi_unc <= 18.55 |
       bmi_unc <= 18.55 |
       bmi_unc <= 18.55
      ) &
      
      
#When you weighed much less than other people thought you ought to weigh or were at your lowest weight, was this due to an illness other than an eating disorder?
  an.1.lowest_weight_weigh_weighed == "No" &
 
#B. Intense fear of gaining weight or of becoming fat, or persistent behavior that interferes with weight gain, even though at a significantly low weight.
   
  #During the time when you were at this low weight, how afraid were you that you might gain weight or become fat?
  (
        an.1.gain_weight_low_weight == "Slightly afraid" |
      an.1.gain_weight_low_weight == "Somewhat afraid" |
      an.1.gain_weight_low_weight == "Very afraid" |
      an.1.gain_weight_low_weight == "Extremely afraid"
      ) &


#C. Disturbance in the way in which one’s body weight or shape is experienced... 

  #During the time when you were at this low weight, did you still feel fat? 
  (
  (
    an.1.feel_fat_low_weight == "Slightly" | #***Check cut off!
     an.1.feel_fat_low_weight == "Somewhat" | 
     an.1.feel_fat_low_weight == "Very" |
     an.1.feel_fat_low_weight == "Extremely"
    ) |
    
  #During the time when you were at this low weight did you ever experience your body or parts of your body to be larger than they actually were or than other people thought they were?
  (
    an.1.body_larger_low_weight == "Somewhat" | 
     an.1.body_larger_low_weight == "Very much"
    ) |
  
#...undue influence of body weight or shape on self-evaluation
 
   #During the time when you were at this low weight, how dependent was your self-worth on your body shape or weight?
    (
    an.1.not_at_all_dependentcompletely_dependent == "1" | #***Check cut off!
    an.1.not_at_all_dependentcompletely_dependent == "2" | 
    an.1.not_at_all_dependentcompletely_dependent == "3" |
      an.1.not_at_all_dependentcompletely_dependent == "4" |
      an.1.not_at_all_dependentcompletely_dependent == "5" |
      an.1.not_at_all_dependentcompletely_dependent == "Completely Dependent"
  ) |

#...or persistent lack of recognition of the seriousness of the current low body weight.
  
  #Did you ever think your low weight had negative consequences for your health?
      an.1.low_weight_health_negative == "Not at all"
) &

  #Restricting type: During the last 3 months... 
  
  #...the individual has not engaged in recurrent episodes of binge eating or purging behavior (i.e., self-induced vomiting or the misuse of laxatives, diuretics, or enemas)...

  #Did you experience regular episodes of binge eating while at your lowest weight?
  (
  (
    be.experience_regular_episodes_binge == "No" |
     is.na(be.experience_regular_episodes_binge) #***Perhaps don't include NA??
   ) & 

  ##During the period of time when you were at your lowest weight, did you use any of the following as a way to control yourweight or shape? .
  (
    icb.making_yourself_vomit.1 == "Not Making yourself vomit" |
     is.na(icb.making_yourself_vomit.1)
    ) & 

      (
    icb.laxatives.1 == "Not Laxatives"
   | is.na(icb.laxatives.1)
   ) &
  
  (icb.diuretics.1 == "Not Diuretics" |
     is.na(icb.diuretics.1)
   ) &  

  #...This subtype describes presentations in which weight loss is accomplished primarily through dieting, fasting, and/or excessive exercise.
  
    #During the period of time when you were at your lowest weight, did you use any of the following as a way to control yourweight or shape? .
    (
      icb.excessive_exercise.1 == "Excessive exercise" |
     icb.fasting.1 == "Fasting"
     )
  ),

    true = 1,
    false = 0,
    missing = NA_real_)
  )
  
#Recode numeric to factor
dat.an$ed.DSM5_AN_restricting_binary <-
  recode_factor(dat.an$ed.DSM5_AN_restricting_binary_numeric,
                "0" = "No DSM5 AN restricting",
                "1" = "DSM5 AN restricting"
                )

#Summary
freq(dat.an$ed.DSM5_AN_restricting_binary)


#Check which cohort they are from
ANR_cases <- dat.an %>%
  filter(ed.DSM5_AN_restricting_binary == "DSM5 AN restricting")

freq(ANR_cases$cohort_name)
```
#### DSM 5 AN binge eating/purging

A. Restriction of energy intake relative to requirements,leading to a significantly low body weight in the context of age, sex, developmental trajectory, and physical health. Significantly low weight is defined as a weight that is less than minimally normal or, for children and adolescents, less than that minimally expected.

B. Intense fear of gaining weight or of becoming fat, or persistent behavior that interferes with weight gain, even though at a significantly low weight.

C. Disturbance in the way in which one’s body weight or shape is experienced, undueinfluence of body weight or shape on self-evaluation, or persistent lack of recognition of the seriousness of the current low body weight.

Subtype of DSM-5 AN; All DSM5 AN symptoms are met, but...

Binge eating/purging subtype: During the last 3 months, the individual has engaged in recurrent episodes of binge-eating or purging behavior (i.e., self-induced vomiting or the misuse of laxatives, diuretics, or enemas).
```{r}
dat.an$ed.DSM5_AN_binge_purge_binary_numeric <- 
  with(dat.an,
  dplyr::if_else(
#A. Restriction of energy intake relative to requirements,leading to a significantly low body weight in the context of age, sex, developmental trajectory, and physical health. Significantly low weight is defined as a weight that is less than minimally normal or, for children and adolescents, less than that minimally expected.
    (
      bmi_unc <= 18.55 |
       bmi_unc <= 18.55 |
       bmi_unc <= 18.55
      ) &
      
      
#When you weighed much less than other people thought you ought to weigh or were at your lowest weight, was this due to an illness other than an eating disorder?
  an.1.lowest_weight_weigh_weighed == "No" &
 
#B. Intense fear of gaining weight or of becoming fat, or persistent behavior that interferes with weight gain, even though at a significantly low weight.
   
  #During the time when you were at this low weight, how afraid were you that you might gain weight or become fat?
  (
        an.1.gain_weight_low_weight == "Slightly afraid" |
      an.1.gain_weight_low_weight == "Somewhat afraid" |
      an.1.gain_weight_low_weight == "Very afraid" |
      an.1.gain_weight_low_weight == "Extremely afraid"
      ) &


#C. Disturbance in the way in which one’s body weight or shape is experienced... 

  #During the time when you were at this low weight, did you still feel fat? 
  (
  (
    an.1.feel_fat_low_weight == "Slightly" | #***Check cut off!
     an.1.feel_fat_low_weight == "Somewhat" | 
     an.1.feel_fat_low_weight == "Very" |
     an.1.feel_fat_low_weight == "Extremely"
    ) |
    
  #During the time when you were at this low weight did you ever experience your body or parts of your body to be larger than they actually were or than other people thought they were?
  (
    an.1.body_larger_low_weight == "Somewhat" | 
     an.1.body_larger_low_weight == "Very much"
    ) |
  
#...undue influence of body weight or shape on self-evaluation
 
   #During the time when you were at this low weight, how dependent was your self-worth on your body shape or weight?
    (
    an.1.not_at_all_dependentcompletely_dependent == "1" | #***Check cut off!
    an.1.not_at_all_dependentcompletely_dependent == "2" | 
    an.1.not_at_all_dependentcompletely_dependent == "3" |
      an.1.not_at_all_dependentcompletely_dependent == "4" |
      an.1.not_at_all_dependentcompletely_dependent == "5" |
      an.1.not_at_all_dependentcompletely_dependent == "Completely Dependent"
  ) |

#...or persistent lack of recognition of the seriousness of the current low body weight.
  
  #Did you ever think your low weight had negative consequences for your health?
      an.1.low_weight_health_negative == "Not at all"
) &
  
  ##Binge eating/purging subtype: During the last 3 months... 
  
  #...the individual has engaged in recurrent episodes of binge-eating... 
  
  #Did you experience regular episodes of binge eating while at your lowest weight?
  (
    (be.experience_regular_episodes_binge == "only during times of low weight" |
     be.experience_regular_episodes_binge == "At times of low weight and at times outside of low weight" |
      is.na(be.experience_regular_episodes_binge)
     ) | 
      
      #...or purging behavior (i.e., self-induced vomiting or the misuse of laxatives, diuretics, or enemas).
      
      #During the period of time when you were at your lowest weight, did you use any of the following as a way to control your weight or shape?
      
  (
    icb.making_yourself_vomit.1 == "Making yourself vomit" |
      icb.laxatives.1 == "Laxatives" |
     icb.diuretics.1 == "Diuretics"
    )
  ),

#Not included absence of fasting and/or exercise because ANBP captures people who are restricting but ALSO binge and/or purge (on top of restricting behaviour)
    true = 1,
    false = 0,
    missing = NA_real_)
  )
  
#Recode numeric to factor
dat.an$ed.DSM5_ANBP_binary <-
  recode_factor(dat.an$ed.DSM5_AN_binge_purge_binary_numeric,
                "0" = "No DSM5 AN binge eating/purging",
                "1" = "DSM5 AN binge eating/purging")


#Summary
freq(dat.an$ed.DSM5_ANBP_binary)

#Check which cohort they are from
ANBP_cases <- dat.an %>%
  filter(ed.DSM5_ANBP_binary == "DSM5 AN binge eating/purging")

freq(ANBP_cases$cohort_name)
```






