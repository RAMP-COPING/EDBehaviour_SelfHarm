---
title: "Regressions"
author: "Helena Davies"
date: "24/05/2021"
output: html_document
---

Configure global options for all chunks
```{r Setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  comment = '',
  prompt = FALSE,
  cache = FALSE
  )
```

Clear global environment prior to initiation
```{r Clear global environment}
remove(list = ls())
```

Add the add_numeric function - used to convert character variables into numeric variables
Add the remove_duplicates function - used to deduplicate and remove NAs from IDs
Add the sumscores function - used to generate sumscores
Add the package_check function - used to install and load dependencies
Add the imp_check function - used to check variables for implausible values
```{r Read in functions}
source(file = "/Users/helenadavies/werk/ilovedata/scripts/functions/add_numeric.R")
source(file = "/Users/helenadavies/werk/ilovedata/scripts/functions/remove_duplicates.R")
source(file = "/Users/helenadavies/werk/ilovedata/scripts/functions/package_check.R")
source("./functions.R")
```

Use package_check to install and load dependencies
Load tidyverse last
```{r Install load dependencies}
packages <- c("summarytools",
              "sjlabelled",
              "Amelia",
              "gtsummary",
              "broom",
              "tidyverse")
package_check(packages)
```

Retrieve recent date
We are using the recent date to save files with paste0() as an extension to not overwrite old versions
```{r Recent date}
date <- Sys.Date()
date
```

# Read in data
```{r Read in data}
dat <- readRDS(file = "../data_cleaned/final_dat_merged_exclusions_2022-04-26.rds")
dim(dat)
   colnames(dat)
```

### Re-ordering variables / converting to factors
First, re-order all variables to get desired reference category for plotting - put largest category as reference
Age
```{r Re-order age levels}
dat <- dat %>%
  mutate(age_category_COVID_baseline = factor(age_category_COVID_baseline,
                       levels = c("56-65", # Largest category
                                  "16-25",
                                  "26-35",
                                  "36-45",
                                  "46-55",
                                   "66-70",
                                   "71+")
                       )
         )

# Check
dat %>%
  freq(age_category_COVID_baseline)
```

Race
```{r Re-order race levels}
dat <- dat %>%
  mutate(race_binary = factor(race_binary,
                       levels = c("White", # Largest category
                                  "Racially minoritised"
                                  )))
dat %>%
  freq(race_binary)
```

Psychiatric disorder
```{r  Re-order psych disorder levels}
# First recode to "Yes" and "No"
dat <- dat %>%
  mutate(psych_disorder_factor =
           case_when(
            mental_health_diagnosis == "Psychiatric disorder" ~ "Yes", 
            mental_health_diagnosis == "No psychiatric disorder" ~ "No")
  )

# Check 
dat %>%
  freq(psych_disorder_factor)

# Then change order
dat <- dat %>%
  mutate(psych_disorder_factor = factor(psych_disorder_factor,
                       levels = c( "No", # Ref category
                                  "Yes"
                                  )))

# Check again
dat %>%
  freq(psych_disorder_factor)
```

Employment
```{r Re-order employment levels}
dat <- dat%>%
  mutate(paid_employment_key_worker = factor(paid_employment_key_worker,
                       levels = c("Paid employment",  
                                  "Key worker",
                                  "Not paid employment",
                                  "Retired",
                                  "Student"
                                  )
                       )
         )

# Check
dat %>%
  freq(paid_employment_key_worker)
```

# EXTENDED MODELS
Adding: Key worker/employment status, vulnerable group member, pandemic worry, positive COVID test, loss of loved one, lonelieness, change in main eco activity, change in living situation

## Binge eating - extended model
Age, gender, race, education, psych disorder, key worker/employment status, vulnerable group member, pandemic worry, positive COVID test, loss of loved one, lonelieness, change in main eco activity, change in living situation

Pandemic worry: If you include a continuous predictor in your logistic regression, the exponentiated coefficient represents the odds ratio for one unit change in the predictor. Often, one unit isn't meaningful and you want the odds ratio for, say, 10 units. To calculate this, just exponentiate the coefficient multiplied by 10: ùëÇùëÖ10=exp(ùõΩ‚ãÖ10). 
```{r Binge eating extended model}
model6 <- glm(NEW_binge_eating_pandemic ~  
                 age_category_COVID_baseline +
                 gender_cleaned +
                 race_binary +
                 highest_education +
                 psych_disorder_factor +
                 paid_employment_key_worker +
                 vulnerable_group_member +
                 panworry_total_score + 
                 positive_covid_test_before_BE_final +
                 lost_someone_before_BE_final +
                 main_eco_change_before_BE_final +
                 living_situation_change_before_BE_final,
                 data = dat,
                 family = "binomial"
              )

binge_eating_main <- tidy(model6,
     conf.int=TRUE,
     exponentiate=TRUE)

fitted(model6) %>% 
  length()

# Pseudo R2
DescTools::PseudoR2(model6, which = "McFadden")
DescTools::PseudoR2(model6, which = "McFaddenAdj")
DescTools::PseudoR2(model6, which = "Nagelkerke")

```

Plot
```{r Binge eating extended model plot}
dat_plot <- dat %>%
  select("Age" = "age_category_COVID_baseline",
         "Gender" = "gender_cleaned",
         "Race" = "race_binary",
         "Pandemic_binge_eating" = "NEW_binge_eating_pandemic",
         "Education" = "highest_education",
         "Psych_disorder" = "psych_disorder_factor",
         "Employment" = "paid_employment_key_worker",
         "Vulnerable_group_member" ="vulnerable_group_member",
         "Pandemic_worry" = "panworry_total_score",
         "Covid_test" = "positive_covid_test_before_BE_final", 
         "Loss" = "lost_someone_before_BE_final", 
         "Main_eco_act_change" = "main_eco_change_before_BE_final", 
         "Living_sit_change" = "living_situation_change_before_BE_final" 
        )


# 1. Plot
explanatory <- c("Age",
                 "Gender",
                 "Race",
                 "Education",
                 "Psych_disorder",
                 "Employment",
                 "Vulnerable_group_member",
                 "Pandemic_worry",
                 "Covid_test",
                 "Loss",
                 "Main_eco_act_change",
                 "Living_sit_change"
               )

dependent <- "Pandemic_binge_eating"

BE_extended_dat_plot <- dat_plot %>%
  finalfit::or_plot(dependent,
                    explanatory, 
          breaks = c(0.5, 1, 5, 10, 20, 30),
          table_text_size = 3.0,
          title_text_size = 15,
          dependent_label = "New experience binge eating during pandemic",
          remove_ref = FALSE) 
```

```{r Save BE extended level plot}
ggsave(
  paste0("BE_extended_dat_plot",
                    date,
                    ".png"),
  plot = BE_extended_dat_plot,
  device = "png", 
  path = "/Users/helenadavies/werk/EDBEHSELFHARM2/gitEDBEHSELFHARM/plots/extended", 
  scale = 1,
  width = 25,
  height = 20,
  units = "cm"
  )
version
```


# Low weight - extended model
Age, gender, race, education, psych disorder, key worker/employment status, vulnerable group member, pandemic worry, positive COVID test, loss of loved one, lonelieness, change in main eco activity, change in living situation
```{r Low weight extended model}
model7 <- glm(NEW_low_weight_pandemic ~ age_category_COVID_baseline +
                 gender_cleaned +
                 race_binary +
                 highest_education +
                 psych_disorder_factor +
                 paid_employment_key_worker +
                 vulnerable_group_member +
                 panworry_total_score + 
                 positive_covid_test_before_LW_final + 
                 lost_someone_before_LW_final + 
                 main_eco_change_before_LW_final + 
                 living_situation_change_before_LW_final +
                 ocd.compulsive_beh_mental_act_binary +
                 ocd.repetitive_unpleasant_thoughts_binary,
                 data = dat,
                 family = "binomial")

low_weight_main <- tidy(model7,
     conf.int=TRUE,
     exponentiate=TRUE)

fitted(model7) %>% 
  length()

# Pseudo R2
DescTools::PseudoR2(model7, which = "McFadden")
DescTools::PseudoR2(model7, which = "McFaddenAdj")
DescTools::PseudoR2(model7, which = "Nagelkerke")
```

Plot
```{r Low weight extended model plot}
dat_plot <- dat %>%
  select("Age" = "age_category_COVID_baseline",
         "Gender" = "gender_cleaned",
         "Race" = "race_binary",
         "Pandemic_low_weight" = "NEW_low_weight_pandemic",
         "Education" = "highest_education",
         "Psych_disorder" = "psych_disorder_factor",
         "Employment" = "paid_employment_key_worker",
         "Vulnerable_group_member" ="vulnerable_group_member",
        "Pandemic_worry" = "panworry_total_score",
         "Covid_test" = "positive_covid_test_before_LW_final",
         "Loss" = "lost_someone_before_LW_final",
         "Main_eco_act_change" = "main_eco_change_before_LW_final",
         "Living_sit_change" = "living_situation_change_before_LW_final",
        "Compulsive_beh_mental_act" = "ocd.compulsive_beh_mental_act_binary",
         "Repetitive_unpleasant_thoughts" = "ocd.repetitive_unpleasant_thoughts_binary"
        )

# 1. Plot
explanatory <- c("Age",
                 "Gender",
                 "Race",
                 "Education",
                 "Psych_disorder",
                 "Employment",
                 "Vulnerable_group_member",
                 "Pandemic_worry",
                 "Covid_test",
                 "Loss",
                 "Main_eco_act_change",
                 "Living_sit_change",
                "Compulsive_beh_mental_act",
                "Repetitive_unpleasant_thoughts")

dependent <- "Pandemic_low_weight"

LW_extended_dat_plot <- dat_plot %>%
  finalfit::or_plot(dependent,
                    explanatory, 
          breaks = c(0.5, 1, 5, 10, 20, 30),
          table_text_size = 3.0,
          title_text_size = 15,
          dependent_label = "New onset low weight during pandemic",
           remove_ref = FALSE) 
```

```{r Save LW extended level plot}
ggsave(
  paste0("LW_extended_dat_plot",
                    date,
                    ".png"),
  plot = LW_extended_dat_plot,
  device = "png", 
  path = "/Users/helenadavies/werk/EDBEHSELFHARM2/gitEDBEHSELFHARM/plots/extended", 
  scale = 1,
  width = 25,
  height = 20,
  units = "cm"
  )
```

# Self-harm/suicidal ideation - extended model
Age, gender, race, education, psych disorder, key worker/employment status, vulnerable group member, pandemic worry, positive COVID test, loss of loved one, lonelieness, change in main eco activity, change in living situation
```{r Harmful ideation extended model}
model8 <- glm(NEW_harmful_ideation_pandemic ~ age_category_COVID_baseline + 
                 gender_cleaned + 
                 race_binary + 
                 highest_education + 
                 psych_disorder_factor + 
                 paid_employment_key_worker + 
                 vulnerable_group_member + 
                 panworry_total_score + 
                 positive_covid_test_before_HI_final + 
                 lost_someone_before_HI_final + 
                 main_eco_change_before_HI_final +
                 living_situation_change_before_HI_final,
               data = dat,
               family = "binomial")

harmful_ideation_main <- tidy(model8,
     conf.int=TRUE,
     exponentiate=TRUE)

fitted(model8) %>% 
  length()

# Psuedo R2
DescTools::PseudoR2(model8, which = "McFadden")
DescTools::PseudoR2(model8, which = "McFaddenAdj")
DescTools::PseudoR2(model8, which = "Nagelkerke")
```


Plot
```{r Harmful ideation extended model plot}
dat_plot <- dat %>%
  select("Age" = "age_category_COVID_baseline",
         "Gender" = "gender_cleaned",
         "Race" = "race_binary",
         "Pandemic_harmful_ideation" = "NEW_harmful_ideation_pandemic",
         "Education" = "highest_education",
         "Psych_disorder" = "psych_disorder_factor",
         "Employment" = "paid_employment_key_worker",
         "Vulnerable_group_member" ="vulnerable_group_member",
         "Pandemic_worry" = "panworry_total_score",
         "Covid_test" = "positive_covid_test_before_HI_final",
         "Loss" = "lost_someone_before_HI_final",
         "Main_eco_act_change" = "main_eco_change_before_HI_final",
         "Living_sit_change" = "living_situation_change_before_HI_final"
         
        )

# 1. Plot
explanatory <- c("Age",
                "Gender",
                 "Race",
                 "Education",
                 "Psych_disorder",
                 "Employment",
                 "Vulnerable_group_member",
                 "Pandemic_worry",
                 "Covid_test",
                 "Loss",
                 "Main_eco_act_change",
                 "Living_sit_change")

dependent <- "Pandemic_harmful_ideation"

HI_extended_dat_plot <- dat_plot %>%
  finalfit::or_plot(dependent, explanatory, 
          breaks = c(0.5, 1, 5, 10, 20, 30),
          table_text_size = 3.0,
          title_text_size = 13,
          dependent_label = "New onset self-harm/suicidal ideation during pandemic",
           remove_ref = FALSE) 
```

```{r Save HI extended level plot}
ggsave(
  paste0("HI_extended_dat_plot",
                    date,
                    ".png"),
  plot = HI_extended_dat_plot,
  device = "png", 
  path = "/Users/helenadavies/werk/EDBEHSELFHARM2/gitEDBEHSELFHARM/plots/extended", 
  scale = 1,
  width = 25,
 height = 20,
  units = "cm"
  )
```

# Self-harm - extended model
Age, gender, race, education, psych disorder, key worker/employment status, vulnerable group member, pandemic worry, positive COVID test, loss of loved one, lonelieness, change in main eco activity, change in living situation
```{r Self-harm extended model}
model10 <- glm(NEW_selfharm_pandemic ~ age_category_COVID_baseline + 
                 gender_cleaned + 
                 race_binary + 
                 highest_education + 
                 psych_disorder_factor + 
                 paid_employment_key_worker + 
                 vulnerable_group_member + 
                 panworry_total_score + 
                 positive_covid_test_before_SH_final + 
                 lost_someone_before_SH_final + 
                 main_eco_change_before_SH_final +
                 living_situation_change_before_SH_final,
               data = dat,
               family = "binomial")

selfharm_main <-  tidy(model10,
     conf.int=TRUE,
     exponentiate=TRUE)

fitted(model10) %>% 
  length()

# Psuedo R2
DescTools::PseudoR2(model10, which = "McFadden")
DescTools::PseudoR2(model10, which = "McFaddenAdj")
DescTools::PseudoR2(model10, which = "Nagelkerke")
```

Plot 
```{r Self-harm extended model plot}
dat_plot <- dat %>%
  select("Age" = "age_category_COVID_baseline",
         "Gender" = "gender_cleaned",
         "Race" = "race_binary",
         "Pandemic_selfharm" = "NEW_selfharm_pandemic",
         "Education" = "highest_education",
         "Psych_disorder" = "psych_disorder_factor",
         "Employment" = "paid_employment_key_worker",
         "Vulnerable_group_member" ="vulnerable_group_member",
         "Pandemic_worry" = "panworry_total_score",
         "Covid_test" = "positive_covid_test_before_SH_final",
         "Loss" = "lost_someone_before_SH_final",
         "Main_eco_act_change" = "main_eco_change_before_SH_final",
         "Living_sit_change" = "living_situation_change_before_SH_final"
         
        )

#1. Plot
explanatory <- c("Age",
                 "Gender",
                 "Race",
                 "Education",
                 "Psych_disorder",
                 "Employment",
                 "Vulnerable_group_member",
                 "Pandemic_worry",
                 "Covid_test",
                 "Loss",
                 "Main_eco_act_change",
                 "Living_sit_change")

dependent <- "Pandemic_selfharm"

SH_extended_dat_plot <- dat_plot %>%
  finalfit::or_plot(dependent, explanatory, 
          breaks = c(0.5, 1, 5, 10, 20, 30),
          table_text_size = 3.0,
          title_text_size = 13,
          dependent_label = "New onset self-harm during pandemic",
          remove_ref = FALSE)
```

```{r Save SH extended level plot}
ggsave(
  paste0("SH_extended_dat_plot",
                    date,
                    ".png"),
  plot = SH_extended_dat_plot,
  device = "png", 
  path = "/Users/helenadavies/werk/EDBEHSELFHARM2/gitEDBEHSELFHARM/plots/extended", 
  scale = 1,
  width = 25,
  height = 20,
  units = "cm"
  )
```

# Save environment
Need this to run correlations with OR of other sensitivity analysis (i.e., exposure ONLY before outcome and not in same phase)
```{r save environment}
save.image(file='COVID_main_analysis_regressions.RData')
```

