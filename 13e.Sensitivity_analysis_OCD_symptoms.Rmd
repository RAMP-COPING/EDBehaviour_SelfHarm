---
title: "Sensitivity analysis: OCD symptoms"
author: "Helena Davies"
date: "11/05/2022"
output: html_document
---

Configure global options for all chunks
```{r Setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  comment = '',
  prompt = FALSE,
  cache = FALSE
  )
```

Clear global environment prior to initiation
```{r Clear global environment}
remove(list = ls())
```

Read in file with path to data channel
```{r Read in file with path to data channel}
source(file = "../credentials/paths.R")
```

Add the add_numeric function - used to convert character variables into numeric variables
Add the remove_duplicates function - used to deduplicate and remove NAs from IDs
Add the sumscores function - used to generate sumscores
Add the package_check function - used to install and load dependencies
Add the imp_check function - used to check variables for implausible values
```{r Read in functions}
source(file = paste0(filepath_functions, "add_numeric.R"))
source(file = paste0(filepath_functions, "remove_duplicates.R"))
source(file = paste0(filepath_functions, "package_check.R"))
source("./functions.R")
```

Use package_check to install and load dependencies
Load tidyverse last
```{r Install load dependencies}
packages <- c("summarytools",
              "sjlabelled",
              "Amelia",
              "gtsummary",
              "broom",
              "tidyverse")
package_check(packages)
```

Retrieve recent date
We are using the recent date to save files with paste0() as an extension to not overwrite old versions
```{r Recent date}
date <- Sys.Date()
date
```

# Read in data
```{r Read in data}
dat <- readRDS(file = "../data_cleaned/final_dat_merged_exclusions_2022-06-21.rds")
dim(dat)
   colnames(dat)
```

```{r change panworry to factor}
dat <- dat %>%
  mutate(panworry_factor =
           case_when(panworry_total_score > -1 &
                       panworry_total_score <= 20 ~ "0-20",
             
                     panworry_total_score > 20 &
                       panworry_total_score <= 40 ~ "21-40",
                     
                     panworry_total_score > 40 &
                      panworry_total_score <= 60 ~ "41-60",
                     
                      panworry_total_score > 60 &
                      panworry_total_score <= 80 ~ "61-80"
                     )
         )
```


### Re-ordering variables / converting to factors
First, re-order all variables to get desired reference category for plotting - put largest category as reference
Age
```{r Re-order age levels}
dat <- dat %>%
  mutate(age_category_COVID_baseline = factor(age_category_COVID_baseline,
                       levels = c("46-55", # Mid-life
                                   "16-25",
                                  "26-35",
                                   "36-45",
                                  "56-65", 
                                   "66-70",
                                   "71+")
                       )
         )

# Check
dat %>%
  freq(age_category_COVID_baseline)
```

Race
```{r Re-order race levels}
dat <- dat %>%
  mutate(race_binary = factor(race_binary,
                       levels = c("White", # Largest category
                                  "Racially minoritised"
                                  )))
dat %>%
  freq(race_binary)
```

Psychiatric disorder
```{r  Re-order psych disorder levels}
# First recode to "Yes" and "No"
dat <- dat %>%
  mutate(psych_disorder_factor =
           case_when(
            mental_health_diagnosis == "Psychiatric disorder" ~ "Yes", 
            mental_health_diagnosis == "No psychiatric disorder" ~ "No")
  )

# Check 
dat %>%
  freq(psych_disorder_factor)

# Then change order
dat <- dat %>%
  mutate(psych_disorder_factor = factor(psych_disorder_factor,
                       levels = c( "No", # Ref category
                                  "Yes"
                                  )))

# Check again
dat %>%
  freq(psych_disorder_factor)
```

Employment
```{r Re-order employment levels}
dat <- dat%>%
  mutate(paid_employment_key_worker = factor(paid_employment_key_worker,
                       levels = c("Paid employment",  
                                  "Key worker",
                                  "Not paid employment",
                                  "Retired",
                                  "Student"
                                  )
                       )
         )

# Check
dat %>%
  freq(paid_employment_key_worker)
```

# Calculate n with new onset
```{r}
dat %>% 
  filter(!is.na(NEW_low_weight_pandemic) &
                 !is.na(age_category_COVID_baseline ) &
                 !is.na(sex_binary) &
                 !is.na(minoritised_gender) &
                 !is.na(race_binary) &
                 !is.na(psych_disorder_factor) &
                 !is.na(paid_employment_key_worker) &
                 !is.na(vulnerable_group_member) &
                 !is.na(panworry_total_score) &
                 !is.na(increased_loneliness_during_pandemic) &
                 !is.na(positive_covid_test_before_LW_final) &
                 !is.na(lost_someone_before_LW_final) &
                 !is.na(main_eco_change_before_LW_final) &
                 !is.na(living_situation_change_before_LW_final) &
                 !is.na(OCD_symptoms)) %>%
  freq(NEW_low_weight_pandemic) 

```



# Low weight 
Age, gender, race, education, psych disorder, key worker/employment status, vulnerable group member, pandemic worry, positive COVID test, loss of loved one, change in main eco activity, change in living situation, *OCD symptoms ADDED*
```{r Low weight extended model}
model2 <- glm(NEW_low_weight_pandemic ~ 
                 age_category_COVID_baseline +
                 sex_binary +
                 minoritised_gender +
                 race_binary +
                 psych_disorder_factor +
                 paid_employment_key_worker +
                 vulnerable_group_member +
                 panworry_factor + 
                 increased_loneliness_during_pandemic + 
                 positive_covid_test_before_LW_final + 
                 lost_someone_before_LW_final + 
                 main_eco_change_before_LW_final + 
                 living_situation_change_before_LW_final +
                 OCD_symptoms,
                 data = dat,
                 family = "binomial")

low_weight_sens3 <- tidy(model2,
     conf.int=TRUE,
     exponentiate=TRUE)

fitted(model2) %>% 
  length()

# Pseudo R2
DescTools::PseudoR2(model2, which = "McFadden")
DescTools::PseudoR2(model2, which = "McFaddenAdj")
DescTools::PseudoR2(model2, which = "Nagelkerke")
```

Plot
```{r Low weight extended model plot}
dat_plot <- dat %>%
  select("Age" = "age_category_COVID_baseline",
         "Sex" = "sex_binary",
         "Minoritised_gender" = "minoritised_gender",
         "Race"="race_binary",
         "New_onset_low_weight" = "NEW_low_weight_pandemic",
         "Psychiatric_disorder" = "psych_disorder_factor",
         "Employment_status" = "paid_employment_key_worker",
         "Vulnerable_group_member" ="vulnerable_group_member",
         "Pandemic_worry_score" = "panworry_factor",
         "Pandemic_loneliness" = "increased_loneliness_during_pandemic",
         "COVID19_illness_or_positive_test" = "positive_covid_test_before_LW_final",
         "Loss_due_to_COVID19" = "lost_someone_before_LW_final",
         "Change_in_main_eco_activity" = "main_eco_change_before_LW_final",
         "Change_in_living_situation" = "living_situation_change_before_LW_final",
         "OCD_symptoms"
        )
       
# 1. Plot
explanatory <- c("Age",
                 "Sex",
                 "Minoritised_gender",
                 "Race",
                 "Psychiatric_disorder",
                 "Employment_status",
                 "Vulnerable_group_member",
                 "Pandemic_worry_score",
                 "Pandemic_loneliness",
                 "COVID19_illness_or_positive_test",
                 "Loss_due_to_COVID19",
                 "Change_in_main_eco_activity",
                 "Change_in_living_situation",
                 "OCD_symptoms")

dependent <- "New_onset_low_weight"

LW_extended_dat_plot <- dat_plot %>%
  finalfit::or_plot(dependent,
                    explanatory, 
          breaks = c(0.5, 1, 5, 10, 20, 30),
          table_text_size = 3.5,
          title_text_size = 15,
          dependent_label = "Sensitivity analysis (adding OCD symptoms): New onset low weight during pandemic",
          remove_ref = FALSE) 
```

```{r Save LW extended level plot}
ggsave(
  paste0("LW_extended_dat_plot",
                    date,
                    ".png"),
  plot = LW_extended_dat_plot,
  device = "png", 
  path = paste0(filepath_plots_sensitivity_OCD_symptoms), 
   scale = 1,
  width = 25,
  height = 25,
  units = "cm"
  )
```

# Calculate correlation between effect sizes of main and sensitivity analysis (3 no's)
## Load main analysis environment
```{r load main analysis env}
load(file='COVID_main_analysis_regressions.RData')
```

## Low weight
```{r Calculate correlation between effect sizes low weight}
# Extract columns from model - sens analysis
low_weight_sens_extracted <- low_weight_sens3 %>%
  select(term,
         estimate,
         conf.high,
         conf.low) %>%
  rename(estimate_sens = estimate,
         conf.high_sens = conf.high,
         conf.low_sens = conf.low,
         Exposure = term)

# Check
low_weight_sens_extracted

# Extract columns from model - main analysis
low_weight_extracted <- low_weight_main %>%
  select(term,
         estimate,
         conf.high,
         conf.low) %>%
  rename(estimate_main = estimate,
         conf.high_main = conf.high,
         conf.low_main = conf.low,
         Exposure = term)

# Check
low_weight_extracted

# Join
low_weight_joined <- merge(x = low_weight_sens_extracted,
                         y = low_weight_extracted,
                         by = "Exposure")


# Check
low_weight_joined

# Summarise ORs
summary(low_weight_joined$estimate_main)
summary(low_weight_joined$estimate_sens)

# Correlation
low_weight_cor <- psych::corr.test(low_weight_joined$estimate_main,
          low_weight_joined$estimate_sens,
          ci = TRUE)

low_weight_cor$r

print(low_weight_cor,
      short=F)
low_weight_joined
```

```{r plot OR correlation low weight}
# Delete intercept row
low_weight_joined <- low_weight_joined[-1, ]

# Rename exposures for plotting
low_weight_joined[1,1] <- "16-25 years (vs. 46-55 years)"
low_weight_joined[2,1] <- "26-35 years (vs. 46-55 years)"
low_weight_joined[3,1] <- "36-45 years (vs. 46-55 years)"
low_weight_joined[4,1] <- "56-65 years (vs. 46-55 years)"
low_weight_joined[5,1] <- "66-70 years (vs. 46-55 years)"
low_weight_joined[6,1] <- "71+ years (vs. 46-55 years)"
low_weight_joined[7,1] <- "Pandemic loneliness"
low_weight_joined[8,1] <- "Change in living situation (vs. not)"
low_weight_joined[9,1] <- "Lost someone due to COVID-19 (vs. not)"
low_weight_joined[10,1] <- "Change in main economic activity (vs. not)"
low_weight_joined[11,1] <- "Minoritised gender (vs. not)"
low_weight_joined[12,1] <- "Key worker (vs. paid employment)"
low_weight_joined[13,1] <- "Not in paid employment (vs. paid employment)"
low_weight_joined[14,1] <- "Retired (vs. paid employment)"
low_weight_joined[15,1] <- "Student (vs. paid employment)"
low_weight_joined[16,1] <- "Pandemic worry score: 21-40 (vs. 0-20)"
low_weight_joined[17,1] <- "Pandemic worry score: 41-60 (vs. 0-20)"
low_weight_joined[18,1] <- "Pandemic worry score: 61-80 (vs. 0-20)"
low_weight_joined[19,1] <-"COVID-19 infection (vs. not)"
low_weight_joined[20,1] <- "Psychiatric disorder (vs. not)" 
low_weight_joined[21,1] <- "Racially minoritised (vs. white)"
low_weight_joined[22,1] <-  "Male (vs. female)"
low_weight_joined[23,1] <- "Vulnerable group member (vs. not)"


# Plot
cor_ORs_low_weight_adding_OCD <- ggplot(data = low_weight_joined,
       mapping = aes(
         x = estimate_sens,
         y = estimate_main,
         colour = Exposure
         )) +
  ggplot2::labs(
    y = "OR main analysis",
    x = "OR sensitivity analysis: Adding OCD symptoms",
    title = "Correlation of Odds Ratio in low weight regression models") +
  geom_point() +
  geom_hline(yintercept = 1) +
  geom_vline(xintercept = 1) +
  theme_minimal() +
  # Add perfect correlation line
  geom_abline(intercept = 0,
              slope = 1,
              color="black", 
              size=0.5) 
  
cor_ORs_low_weight_adding_OCD<- cor_ORs_low_weight_adding_OCD + 
  coord_cartesian(
  xlim = c(0.3, 5),
  ylim = c(0.3, 5),
  expand = TRUE,
  default = FALSE,
  clip = "on"
) +
  # Add error bars (both main and sens)
  geom_errorbar(aes(ymin = conf.low_main, ymax = conf.high_main)) +
  geom_errorbarh(aes(xmin = conf.low_sens, xmax = conf.high_sens)) 

# Save
ggsave(
  paste0("cor_ORs_low_weight_adding_OCD",
                    date,
                    ".jpeg"),
  plot = cor_ORs_low_weight_adding_OCD,
  device = "jpeg", 
  path = paste0(filepath_plots_sensitivity_OCD_symptoms), 
  scale = 1,
  width = 50,
  height = 20,
  units = "cm"
  )
```
