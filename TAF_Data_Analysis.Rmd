---
title: "Data_Analysis_EDBeh_SelfHarm"
author: "Helena Davies"
date: "28/01/2021"
output: html_document
---

```{r Setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      comment=NA,
                      prompt=FALSE,
                      cache=FALSE)
```

Delete everything in your global environment
```{r Delete everything in your global environment}
remove(list = ls())
```

#### Call in library script

```{r source files}
source("./libraries.R")
```

### Read in TAF data
```{r}
dat.taf <- readRDS(file = "../data_cleaned/dat.taf.rds")
dim(dat.taf)
colnames(dat.taf)

```


##PLOTS - TAF 


##**RETRO PREPAN - need to rename these the same as baseline / waves

taf.pandemic_felt_.Wavebaseline: Had you felt that way [life not worth living] before the pandemic?
taf.pandemic_felt.1_.Wavebaseline: Had you felt that way [contemplated harm] before the pandemic?
taf.meant_end_life_pandemic_.Wavebaseline: Before the pandemic, had you deliberately harmed yourself, whether or not you meant to end your life?
```{r}
dat.taf <- dat.taf %>% 
  rename(
   taf.worth_living_life_people_.Waveretro_prepan = taf.pandemic_felt_.Wavebaseline,
   taf.have_you_contemplated_harming_yourself_.Waveretro_prepan = taf.pandemic_felt.1_.Wavebaseline,
   taf.meant_life_end_weeks_.Waveretro_prepan = taf.meant_end_life_pandemic_.Wavebaseline
    )

```


#1. First, need to re-structure data so that "wave" is a single column with rows of "1", "2", "3", and each taf item is a separate column in which rows are values
```{r}
dat.taf <- dat.taf %>%
  pivot_longer(
    cols = (starts_with("taf") &
              contains(".Wave")),
    names_to = "wave_taf",
    values_to = "value") %>%
  separate(wave_taf, into = c("taf", "wave"), sep = "_.Wave", remove = TRUE) %>%
  pivot_wider(
     names_from = "taf",
     values_from = "value")

colnames(dat.taf)

```

#2. Get rid of NAs and change taf to factor
```{r}
#get rid of nas
dat.no.nas <- dat.taf[!is.na(dat.taf$taf.worth_living_life_people),]

#change taf to factor (get rid of 'yes' as its an empty level)
dat.no.nas$taf.worth_living_life_people_factor <- factor(dat.no.nas$taf.worth_living_life_people)
```

#3. Change wave to factor and re-order
```{r}

# change order of wave factor 1
dat.no.nas <- dat.no.nas %>%
 mutate(wave_factor = fct_relevel(wave,
                                  "retro_prepan",
                                  "baseline",
                                  "0",
                           "1",
                           "2",
                           "3",
                           "4",
                           "5",
                           "6",
                           "7",
                           "8",
                           "9")
        )


#Check that this worked

summary(dat.no.nas$wave_factor)
```

#4. Rename waves to dates
```{r}

##Rename waves
levels(dat.no.nas$wave_factor)[1] <- "test"


```


#5. Format data to plot
```{r}
#get data in format to plot
dat_plot <- dat.no.nas %>%
  group_by(wave_factor) %>%
  dplyr::summarise(wcount = table(taf.worth_living_life_people_factor) / sum(table(taf.worth_living_life_people_factor))) %>%
  ungroup() %>%
  mutate(taf.worth_living_life_people_factor = rep(levels(dat.no.nas[["taf.worth_living_life_people_factor"]]),
                    length(levels(dat.no.nas[["wave_factor"]]))))


```

6. Change taf variable to ordered factor
```{r}
dat_plot <- dat_plot %>%
  mutate(taf.worth_living_life_people_factor = fct_relevel(taf.worth_living_life_people_factor,
                           "Prefer not to answer",
                           "No",
                           "Yes, once",
                           "Yes, more than once"))


```


7. PLOT ! [WHAT TO DO WITH "YES" FROM RAMP RETRO PREPAN?]
```{r}
ggplot(dat_plot,
       aes(x = taf.worth_living_life_people_factor,
           y = wcount,
           fill = wave_factor)) +
  geom_bar(aes(group = wave_factor),
           stat = "identity",
           position = "dodge",
           colour = "black") + 
  scale_y_continuous(labels = scales::percent)

```


##PLOTS - TAF (LIFE NOT WORTH LIVING, 2 WEEKS)
### Read in TAF data (again, because variable needs to be renamed again and data restructured)
```{r}
dat.taf <- readRDS(file = "../data_cleaned/dat.taf.rds")
dim(dat.taf)
colnames(dat.taf)

```

##**RETRO PREPAN - need to rename these the same as baseline / waves

```{r}
dat.taf <- dat.taf %>% 
  rename(
   taf.felt_weeks_past_.Waveretro_prepan = taf.pandemic_felt_.Wavebaseline)

 
```

#1. First, need to re-structure data so that "wave" is a single column with rows of "baseline, 2a, 2b etc", and each taf item is a separate column in which rows are values
```{r}
dat.taf <- dat.taf %>%
  pivot_longer(
    cols = (starts_with("taf") &
              contains(".Wave")),
    names_to = "wave_taf",
    values_to = "value") %>%
  separate(wave_taf, into = c("taf", "wave"), sep = "_.Wave", remove = TRUE) %>%
  pivot_wider(
     names_from = "taf",
     values_from = "value")

colnames(dat.taf)

```



#2. Get rid of NAs and change taf to factor
```{r}
#get rid of nas
dat.no.nas <- dat.taf[!is.na(dat.taf$taf.felt_weeks_past),]

#change taf to factor (get rid of 'yes' as its an empty level)
dat.no.nas$taf.felt_weeks_past_factor <- factor(dat.no.nas$taf.felt_weeks_past)
```

#3. Change wave to factor and re-order
```{r}

# change order of wave factor 1
dat.no.nas <- dat.no.nas %>%
 mutate(wave_factor = fct_relevel(wave,
                                  "retro_prepan",
                                  "baseline",
                           "1a",
                           "1b",
                           "2a",
                           "2b",
                           "3a",
                           "3b",
                           "4a",
                           "4b",
                           "5",
                           "6",
                           "7",
                           "8"))


#Check that this worked
str(dat.no.nas$wave_factor)
```

#4. Rename waves to dates
```{r}

##Rename waves
levels(dat.no.nas$wave_factor)[1] <- "test"

"21st April - 5th May (2020)" A

"6th May - 19th May (2020)" B

"20th May - 2nd June (2020)"

"3rd June - 16th June (2020)"

"17th June - 30th June (2020)"

"31st June - 14th July (2020)"

"15th July - 28th July (2020)"

"29th July - 25th August (2020)"

"26th August - 22nd September (2020)"

"23rd September - 20th October (2020)"

"23rd September - 20th October (2020)"

"21st October - 17th November (2020)"

"18th November - 15th December (2020)"

"16th December - 11th January (2021)"

```


#5. Format data to plot
```{r}
#get data in format to plot
dat_plot <- dat.no.nas %>%
  group_by(wave_factor) %>%
  dplyr::summarise(wcount = table(taf.felt_weeks_past_factor) / sum(table(taf.felt_weeks_past_factor))) %>%
  ungroup() %>%
  mutate(taf.felt_weeks_past_factor = rep(levels(dat.no.nas[["taf.felt_weeks_past_factor"]]),
                    length(levels(dat.no.nas[["wave_factor"]]))))


```

6. Change taf variable to ordered factor
```{r}
dat_plot <- dat_plot %>%
  mutate(taf.felt_weeks_past_factor = fct_relevel(taf.felt_weeks_past_factor,
                           "Prefer not to answer",
                           "No",
                           "Yes"))



```


7. PLOT !
```{r}
ggplot(dat_plot,
       aes(x = taf.felt_weeks_past_factor,
           y = wcount,
           fill = wave_factor)) +
  geom_bar(aes(group = wave_factor),
           stat = "identity",
           position = "dodge",
           colour = "black") + 
  scale_y_continuous(labels = scales::percent)

```

































