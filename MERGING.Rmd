---
title: "MERGING"
author: "Helena Davies"
date: "04/05/2021"
output: html_document
---

#Set up
```{r Setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      comment=NA,
                      prompt=FALSE,
                      cache=FALSE)
options(bitmapType = 'quartz') # to render fonts better
```

Clear global environment
```{r Clear global environment}
remove(list = ls())
```

Retrieve the current date to use it for file endings to not overwrite files when one exports files
```{r Recent date}
date = Sys.Date()
```

Load packages
```{r}
library(tidyverse)
library(skimr)
```

# Import baseline data
```{r export data}
glad_baseline <- readRDS(file = "../data_cleaned/NEW_baseline_glad.rds")
dim(glad_baseline)

edgi_baseline <- readRDS(file = "../data_cleaned/NEW_baseline_edgi.rds")
dim(edgi_baseline)

nbr_baseline <- readRDS(file = "../data_cleaned/NEW_baseline_nbr.rds")
dim(nbr_baseline)

ramp_baseline <- readRDS(file = "../data_cleaned/NEW_baseline_ramp.rds")
dim(ramp_baseline)

```
##Make list of edeq baseline columns only in RAMP
```{r}
edeq_baseline_columnNames <- c("edeq.deliberately_limit_amount_influence_baseline",                     
                               "edeq.calories_made_body_shape_baseline",                               
                               "edeq.weight_influenced_person_baseline",                                
                               "edeq.dissatisfied_shape_weight_baseline",                              
                               "edeq.nibbled_picked_snacks_grazed_baseline",                            
                               "edeq.felt_anxious_blue_bored_baseline",                                
                               "edeq.felt_anxious_blue_bored.1_baseline",                              
                               "edeq.eating_behaviours_concerns_distressed_baseline",                  
                               "edeq.deliberately_limit_amount_influence.1_baseline",                   
                               "edeq.calories_made_body_shape.1_baseline",                              
                               "edeq.weight_influenced_person.1_baseline",                              
                               "edeq.dissatisfied_shape_weight.1_baseline",                            
                               "edeq.eating_behaviours_concerns_distressed.1_baseline",                 
                               "edeq.feelings_pandemic_felt_baseline",                                  
                               "edeq.actively_been_monitoring_your_shape_or_weight_baseline",           
                               "edeq.regard_lost_control_eaten_baseline",                               
                               "edeq.sick_means_made_shape_baseline",                                   
                               "edeq.diuretics_laxatives_means_shape_baseline",                         
                               "edeq.compulsive_driven_burn_calories_baseline",                         
                               "edeq.nibbled_picked_snacks_grazed.1_baseline",                         
                               "edeq.felt_anxious_blue_bored.2_baseline",                               
                               "edeq.felt_anxious_blue_bored.3_baseline",                               
                               "edeq.actively_been_monitoring_your_shape_or_weight_.1_baseline",        
                               "edeq.regard_lost_control_eaten.1_baseline",                             
                               "edeq.sick_means_made_shape.1_baseline",                                 
                               "edeq.diuretics_laxatives_means_shape.1_baseline",                       
                               "edeq.compulsive_driven_burn_calories.1_baseline",                       
                               "edeq.deliberately_limit_amount_influence_baseline_numeric",             
                               "edeq.calories_made_body_shape_baseline_numeric",                        
                               "edeq.weight_influenced_person_baseline_numeric",                        
                               "edeq.dissatisfied_shape_weight_baseline_numeric",                       
                               "edeq.nibbled_picked_snacks_grazed_baseline_numeric",                    
                               "edeq.felt_anxious_blue_bored_baseline_numeric",                         
                               "edeq.felt_anxious_blue_bored.1_baseline_numeric",                       
                               "edeq.eating_behaviours_concerns_distressed_baseline_numeric",           
                               "edeq.deliberately_limit_amount_influence.1_baseline_numeric",           
                               "edeq.calories_made_body_shape.1_baseline_numeric",                      
                               "edeq.weight_influenced_person.1_baseline_numeric",                      
                               "edeq.dissatisfied_shape_weight.1_baseline_numeric",                     
                               "edeq.eating_behaviours_concerns_distressed.1_baseline_numeric",         
                               "edeq.feelings_pandemic_felt_baseline_numeric",                          
                               "edeq.actively_been_monitoring_your_shape_or_weight_baseline_numeric",   
                               "edeq.regard_lost_control_eaten_baseline_numeric",                       
                               "edeq.sick_means_made_shape_baseline_numeric",                           
                               "edeq.diuretics_laxatives_means_shape_baseline_numeric",
                               "edeq.compulsive_driven_burn_calories_baseline_numeric",                 
                               "edeq.nibbled_picked_snacks_grazed.1_baseline_numeric",                  
                               "edeq.felt_anxious_blue_bored.2_baseline_numeric",                       
                               "edeq.felt_anxious_blue_bored.3_baseline_numeric",                       
                               "edeq.actively_been_monitoring_your_shape_or_weight_.1_baseline_numeric",
                               "edeq.regard_lost_control_eaten.1_baseline_numeric",                     
                               "edeq.sick_means_made_shape.1_baseline_numeric",                         
                               "edeq.diuretics_laxatives_means_shape.1_baseline_numeric",               
                               "edeq.compulsive_driven_burn_calories.1_baseline_numeric") 
                               
```

##EDEQ baseline only in RAMP, so add all above columns as NA in nbr, edgi + glad
```{r}
nbr_baseline[edeq_baseline_columnNames] <- NA

glad_baseline[edeq_baseline_columnNames] <- NA

edgi_baseline[edeq_baseline_columnNames] <- NA
```
                                                          
 [3] "sex"       - not in ramp                                                            
 [4] "gender_unc"                                                            
 [5] "uk_location"                                                           
 [6] "current_country"                                                       
 [7] "age_category_numeric"    - called "age_unc" in ramp                                              
 [8] "age_category"                                                          
 [9] "ethnicity"                                                             
[10] "highest_education_prepan_numeric"    - not in ramp, nbr                                   
[11] "highest_education_prepan"           - not in ramp, nbr                                     
[12] "highest_education_numeric"                                             
[13] "highest_education"                                                     
[14] "employment_prior_covid"                                                
[15] "employment_prior_covid_numeric"                                        
[16] "employment_change"                                                     
[17] "employment_change_numeric" 

##Need same columns across all datasets in order to merge
```{r}
#sex & age_category_numeric not in RAMP
ramp_baseline$sex <- NA
ramp_baseline$age_category_numeric <- NA

#age called "age_unc" in RAMP
  ramp_baseline <- ramp_baseline %>% 
  rename(
    age_category = age_unc,
    )
  
  
#highest_education_prepan/numeric not in ramp or nbr
ramp_baseline$highest_education_prepan <- NA
ramp_baseline$highest_education_prepan_numeric <- NA
nbr_baseline$highest_education_prepan <- NA
nbr_baseline$highest_education_prepan_numeric <- NA
```

##Merge all baseline data
```{r glad/edgi/nbr/ramp data frame list}

#bind all baseline data
dat <- bind_rows(
  glad_baseline,
  edgi_baseline,
  nbr_baseline,
  ramp_baseline
)

##check col names
colnames(dat)
nrow(dat)
```


#Import follow up data
```{r}

taf_ramp <- readRDS(file = "../data_cleaned/NEW_taf_ramp.rds")
dim(taf_ramp)

taf_coping <- readRDS(file = "../data_cleaned/NEW_taf_coping.rds")
dim(taf_coping)

edeq_coping_screener <- readRDS(file = "../data_cleaned/NEW_edeq_screener_coping.rds")
dim(edeq_coping_screener)


edeq_ramp_screener <- readRDS(file = "../data_cleaned/NEW_edeq_screener_ramp.rds")
dim(edeq_ramp_screener)

```
##Create empty wave 1a and 1bs in COPING to merge with RAMP 

```{r}
edeq_coping_screener$ed_scid5.regular_episodes_eating_binges_.Wave_1a <- NULL 
edeq_coping_screener$ed_scid5.regular_episodes_eating_binges_.Wave_1b <- NULL 
edeq_coping_screener$ed_scid5.weigh_weighed_past_month_.Wave_1a <- NULL 
edeq_coping_screener$ed_scid5.weigh_weighed_past_month_.Wave_1b <- NULL 

```

#Bind coping and ramp's edeq and taf TOGETHER
```{r}

#bind all edeq data

EDEQ <- bind_rows(edeq_ramp_screener,
                 edeq_coping_screener)


#check col names edeq
colnames(EDEQ)

#check no of participants edeq
nrow(EDEQ)

#bind all taf data
TAF <- bind_rows(taf_ramp,
                 taf_coping)

#check col names taf
colnames(TAF)

#check no of participants
nrow(TAF)


##Merge TAF and EDEQ
taf_edeq <- merge(TAF,
                  EDEQ,
                  by = "ID"
  
  )

#check col names 
colnames(taf_edeq)

#check no of participants
nrow(taf_edeq)

```


#Bind edeq_taf with baseline data
```{r}

data.merged <- merge(dat,
                  taf_edeq,
                  by = "ID")

#check col names 
colnames(data.merged)

#check no of participants
nrow(data.merged)


```

### Read in ED group data
```{r}

##COPING (GLAD, EDGI, NBR) and RAMP
COPING_RAMP_ED_data <- readRDS(file = "../data_cleaned/COPING_ED_data_cleaned.rds")

# Inspect dimensions
dim(COPING_RAMP_ED_data)
# Inspect colnames
colnames(COPING_RAMP_ED_data)

nrow(COPING_RAMP_ED_data)

##GLAD original
GLAD_ED_data <- readRDS(file = "../data_cleaned/GLAD_ED_data_cleaned.rds")

# Inspect dimensions
dim(GLAD_ED_data)
# Inspect colnames
colnames(GLAD_ED_data)

nrow(GLAD_ED_data)

##EDGI original 
EDGI_ED_data <- readRDS(file = "../data_cleaned/EDGI_ED_data_cleaned.rds")

# Inspect dimensions
dim(EDGI_ED_data)
# Inspect colnames
colnames(EDGI_ED_data)

nrow(EDGI_ED_data)


```

##Create columns in EDGI that are only in GLAD (ready to merge)
```{r}
EDGI_ED_data$an.1.anorexia_nervosa_numeric <- NA
EDGI_ED_data$an.1.anorexia_nervosa <- NA
EDGI_ED_data$an.1.bulimia_nervosa <- NA
EDGI_ED_data$an.1.bulimia_nervosa_numeric <- NA
EDGI_ED_data$an.1.bingeeating_disorder_numeric <- NA
EDGI_ED_data$an.1.bingeeating_disorder <- NA


```

#Merge EDGI and GLAD
We will know where participants are from by looking at cohort name. Participants who are in EDGI should not, in theory, also be in GLAD. Therefore, we can combine all variables, because someone will not have a value for a variable in GLAD and also have a value for that same variable in EDGI. COPING will have variables with different names (i.e., we will not collapse the ED variables in COPING with those from EDGI and GLAD) because some individuals will have a value in a variable within COPING (e.g., DSM5 AN algorithm-derived diagnoses) and another, possible different, value of the same variable in GLAD or EDGI. We want to know whether people reach diagnostic criteria in the original EDGI/GLAD datasets or at COPING baseline.
```{r}

EDGI.and.GLAD.ed.data <- rbind(GLAD_ED_data,
                               EDGI_ED_data
                               )

#Check 
nrow(EDGI.and.GLAD.ed.data)
colnames(EDGI.and.GLAD.ed.data)

```

##Drop 'cohort_name' from the EDGI and GLAD merged data. We will be able to tell which one someone is from by looking at their cohort name in the COPING data, i.e. will be either coping_glad or coping_edgi
```{r}
EDGI.and.GLAD.ed.data$cohort_name <-NULL
```


#Merge the now combined data from EDGI and GLAD with the COPING data
```{r}

dfs.list <- list(COPING_RAMP_ED_data,
                 EDGI.and.GLAD.ed.data
                 

 )

#Merge
dat.ed.all <- plyr::join_all(dfs.list,
                                      by = c("ID"))


#Check rows
nrow(dat.ed.all)

#Check columns
colnames(dat.ed.all)
```
#Look at number of people who will make up final groups (i.e., have self-reported ED or reached ED diagnostic criteria in GLAD, EDGI, or COPING baseline)

##Binge-eating disorder group
NB: Only GLAD or EDGI will have positive values in the 'BED_group_numeric', as this means they were counted as a case in GLAD and EDGI original data
```{r}

#Binge-eating disorder; split by cohort
dat.ed.all %>%
  filter(COPING_bed_group_numeric == 1 |
           BED_group_numeric ==1) %>%
  group_by(cohort_name,
           BED_group_numeric,
           COPING_bed_group_numeric) %>%
  count()

#Final count #3183 cases
dat.ed.all %>%
  filter(COPING_bed_group_numeric == 1 |
           BED_group_numeric ==1) %>%
  count()


```

##Anorexia nervosa group
NB: Only GLAD or EDGI will have positive values in the 'anorexia_group_numeric', as this means they were counted as a case in GLAD and EDGI original data

```{r}

#Anorexia; split by cohort
dat.ed.all %>%
  filter(COPING_anorexia_group_numeric == 1 |
           anorexia_group_numeric ==1) %>%
  group_by(cohort_name,
           anorexia_group_numeric,
           COPING_anorexia_group_numeric) %>%
  count()

#Final count #3999 cases
dat.ed.all %>%
  filter(COPING_anorexia_group_numeric == 1 |
           anorexia_group_numeric ==1) %>%
  count()


```


##Bulimia nervosa group
NB: Only GLAD or EDGI will have positive values in the 'bulimia_group_numeric', as this means they were counted as a case in GLAD and EDGI original data

```{r}

#Anorexia; split by cohort
dat.ed.all %>%
  filter(COPING_bulimia_group_numeric == 1 |
           bulimia_group_numeric ==1) %>%
  group_by(cohort_name,
           bulimia_group_numeric,
           COPING_bulimia_group_numeric) %>%
  count()

#Final count #3235 cases
dat.ed.all %>%
  filter(COPING_bulimia_group_numeric == 1 |
           bulimia_group_numeric ==1) %>%
  count()


```

#Merge merged data with grouping ED data
```{r}

data.merged.grouped1 <- merge(dat.ed.all,
                  data.merged,
                  by = "ID")

dim(data.merged.grouped1)

```

##Import self-harm grouping data
```{r}
taf_grouping_data <- readRDS(file = "../data_cleaned/SelfHarm_groups2021-05-04.rds")
dim(taf_grouping_data)
```
#Bind edeq/baseline with grouping ED data
```{r}

data.merged.grouped2 <- merge(taf_grouping_data,
                  data.merged.grouped1,
                  by = "ID")

dim(data.merged.grouped2)

```
#Remove duplicate IDs 
```{r}

##Remove dupilcate IDs (as each wave is now a column, there should be NO dup IDs)
data.final  <- data.merged.grouped2  %>%
  filter(., !duplicated(ID)) 

##Check number of rows
nrow(data.final)

```

#Skim final data
```{r Skim taf + baseline data}
#look at the data
skimr::skim(data.final)
```

#Save final dataset
##Save dataset
```{r}
saveRDS(object = data.final,
        file = paste0("/Users/helenadavies/King's College London/MT-Translational Neuropsychiatric Genomics - Helena_Davies_PhD - Helena_Davies_PhD/EDBeh_SelfHarm/data_cleaned/data.final", date, ".rds"))

```



