---
title: "BE plots2"
author: "Helena Davies"
date: "31/05/2021"
output: html_document
---
```{r Setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      comment=NA,
                      prompt=FALSE,
                      cache=FALSE)
```

Delete everything in your global environment
```{r Delete everything in your global environment}
remove(list = ls())
```

#### Call in library script

```{r source files}
source("./libraries.R")
```

#### Call in functions script

```{r source files}
source("./functions.R")
```

#Retrieve the recent date
```{r Recent date}
date = Sys.Date()
date
```

# Read in data
```{r}
dat <- readRDS(file = "/Users/helenadavies/werk/EDBEHSELFHARM2/gitEDBEHSELFHARM/data_cleaned/dat.final2021-06-30.rds")
dim(dat)
colnames(dat)

```


# Restructure data into long 
```{r }

dat.wide <- dat %>%
  pivot_longer(
    cols = (starts_with("ed_scid5.regular_episodes_eating_binges_.") &
              contains("Wave")),
    names_to = "wave",
    values_to = "value") %>%
  separate(wave, into = c("edeq", "wave"), sep = "_.Wave", remove = TRUE) %>%
  pivot_wider(
     names_from = "edeq",
     values_from = "value")

```

# NEW experience of binge; phases
```{r}
dat.wide <- dat.wide %>%
  mutate(new_binge_eating_each_wave =
           case_when(lifetime_binge_eating_baseline_numeric == 0 &
                     ed_scid5.regular_episodes_eating_binges == "Yes" &
                      wave == "_1b"  ~ 1,
                     
                    lifetime_binge_eating_baseline_numeric == 0 &
                     ed_scid5.regular_episodes_eating_binges == "Yes" &
                      wave == "_2b"  ~ 2,
                     
                    lifetime_binge_eating_baseline_numeric == 0 &
                     ed_scid5.regular_episodes_eating_binges == "Yes" &
                      wave == "_3b"  ~ 3,
                    
                     lifetime_binge_eating_baseline_numeric == 0 &
                     ed_scid5.regular_episodes_eating_binges == "Yes" &
                      wave == "_4b"  ~ 4,
                    
                     
                     lifetime_binge_eating_baseline_numeric == 0 &
                     ed_scid5.regular_episodes_eating_binges == "Yes" &
                      wave == "_6b"  ~ 5,
                    
                     
                     lifetime_binge_eating_baseline_numeric == 0 &
                     ed_scid5.regular_episodes_eating_binges == "Yes" &
                      wave == "_8b"  ~ 6,
                    
                     lifetime_binge_eating_baseline_numeric == 0 &
                     ed_scid5.regular_episodes_eating_binges == "Yes" &
                      wave == "_10b"  ~ 7,
                    
                     
                     lifetime_binge_eating_baseline_numeric == 0 &
                     ed_scid5.regular_episodes_eating_binges == "Yes" &
                      wave == "_12b"  ~ 8
                  
                     )
                     )
                     
                     
        
#Check
dat.wide %>%
  freq(new_binge_eating_each_wave)

#Convert to individual variables
dat.wide <- dat.wide %>%
  mutate(ed.screener_new_binge_eating_phase_1b =
           case_when(new_binge_eating_each_wave == 1 ~ 1
                     )
         )
  

dat.wide <- dat.wide %>%
  mutate(ed.screener_new_binge_eating_phase_2b =
           case_when(new_binge_eating_each_wave == 2 ~ 1
                     )
         )
  
dat.wide <- dat.wide %>%
  mutate(ed.screener_new_binge_eating_phase_3b =
           case_when(new_binge_eating_each_wave == 3 ~ 1
                     )
         )
  
dat.wide <- dat.wide %>%
  mutate(ed.screener_new_binge_eating_phase_4b =
           case_when(new_binge_eating_each_wave == 4 ~ 1
                     )
         )
  
dat.wide <- dat.wide %>%
  mutate(ed.screener_new_binge_eating_phase_6b =
           case_when(new_binge_eating_each_wave == 5 ~ 1
                     )
         )
  
dat.wide <- dat.wide %>%
  mutate(ed.screener_new_binge_eating_phase_8b =
           case_when(new_binge_eating_each_wave == 6 ~ 1
                     )
         )
  
dat.wide <- dat.wide %>%
  mutate(ed.screener_new_binge_eating_phase_10b =
           case_when(new_binge_eating_each_wave == 7 ~ 1
                     )
         )
  

dat.wide <- dat.wide %>%
  mutate(ed.screener_new_binge_eating_phase_12b =
           case_when(new_binge_eating_each_wave == 8 ~ 1
                     )
         )



```

## Restructure data into long then wide again for new experiences
```{r }

dat.wide2 <- dat.wide %>%
  pivot_longer(
    cols = (starts_with("ed.screener_new_binge_eating_phase") &
              contains("phase")),
    names_to = "NEW_wave",
    values_to = "NEW_value") %>%
  separate(NEW_wave, into = c("edeq_NEW", "wave_NEW"), sep = "phase_", remove = TRUE) %>%
  pivot_wider(
     names_from = "edeq_NEW",
     values_from = "NEW_value")

```

# Create new column indicating if experience was new or not
```{r}
dat.wide2 <- dat.wide2 %>%
  split(factor(dat.wide2[["ID"]])) %>%
  map(function(dat){
        which_new <- which(dat[["ed_scid5.regular_episodes_eating_binges"]] == "Yes")[1]
        print(which_new)
        dat[["new_experience"]] <- "Not new"
        dat[["new_experience"]][which_new] <- "New"
        dat
    }) %>%
  bind_rows() %>%
  mutate(new_experience =
           if_else(
             lifetime_binge_eating_baseline_numeric == 1,
             "Not new",
             new_experience
           ))
#%>%
#  select(ID, #Check that it worked
 #        ed_scid5.regular_episodes_eating_binges,
 #        wave,
 #        new_experience,
 #       lifetime_binge_eating_baseline_numeric)
        
        
```
*** Have saved dataset here because above chunk took ~1 hour to run!

Save dataset (interim)
```{r Save dataset(interim)}

saveRDS(object = dat.wide2, file = paste0("/Users/helenadavies/werk/EDBEHSELFHARM2/gitEDBEHSELFHARM/data_cleaned/dat.wide2", date, ".rds"))
```

```{r Read in data}
dat <- readRDS(file = "/Users/helenadavies/werk/EDBEHSELFHARM2/gitEDBEHSELFHARM/data_cleaned/dat.wide22021-07-15.rds")
dim(dat)
colnames(dat)

```


##PLOTS - Over the past month, have you had regular episodes of overeating or eating binges when you ate what most people would regard as an unusually large amount of food in a short period of time ?

#1. Get rid of NAs and change edeq to factor
```{r}
#get rid of nas
dat.no.nas <- dat[!is.na(dat$ed_scid5.regular_episodes_eating_binges),]
```

#1. Change wave to factor and re-order
```{r}

# change order of wave factor 1
dat.no.nas <- dat.no.nas %>%
 mutate(phase = fct_relevel(wave,
                                  "_1b",
                                  "_2b",
                                  "_3b",
                           "_4b",
                           "_6b",
                           "_8b",
                           "_10b",
                           "_12b"))


#Check that this worked
summary(dat.no.nas$phase)
```

#4. Rename waves to dates
```{r}

##Rename waves

levels(dat.no.nas$phase)[1] <- "5th May - 19th May 2020"

levels(dat.no.nas$phase)[2] <- "2nd June - 16th June 2020" 

levels(dat.no.nas$phase)[3] <- "30th June - 14th July 2020"

levels(dat.no.nas$phase)[4] <- "28th July - 25th August 2020"

levels(dat.no.nas$phase)[5] <- "22nd Sept - 20th Oct 2020"

levels(dat.no.nas$phase)[6] <- "17th Nov - 15th Dec 2020"

levels(dat.no.nas$phase)[7] <- "12th Jan - 9th Feb 2021"

levels(dat.no.nas$phase)[8] <- "9th March - 6th April 2021"


```

#5. Format data to plot
```{r}
#get data in format to plot
dat_plot <- dat.no.nas %>%
  group_by(phase) %>%
  dplyr::summarise(wcount = table(ed_scid5.regular_episodes_eating_binges) / sum(table(ed_scid5.regular_episodes_eating_binges))) %>%
  ungroup() %>% ##Here - need to add a column of % of "Yes" that are new
  mutate(ed_scid5.regular_episodes_eating_binges = rep(levels(dat.no.nas[["ed_scid5.regular_episodes_eating_binges"]]),
                    length(levels(dat.no.nas[["phase"]])))) 
  

```

6. Change edeq variable to ordered factor
```{r}
dat_plot <- dat_plot %>%
  mutate(ed_scid5.regular_episodes_eating_binges = fct_relevel(ed_scid5.regular_episodes_eating_binges,
                           "No",
                           "Yes"))


```


7. PLOT ! Over the past month, have you had regular episodes of overeating or eating binges when you ate what most people would regard as an unusually large amount of food in a short period of time
```{r}

ggplot(dat_plot,
       aes(x = ed_scid5.regular_episodes_eating_binges,
           y = wcount,
           fill = phase,
           alpha = new_experience)) + #*****
  geom_bar(aes(group = phase),
           stat = "identity",
           position = "dodge",
           colour = "black") + 
  scale_y_continuous(labels = scales::percent) +
  labs(title = str_wrap("Over the past month, have you had regular episodes of overeating or eating binges when you ate what most people would regard as an unusually large amount of food in a short period of time?", 60),
       x = "Binge eating",
       y = "Percentage of participants",
       fill = "Time of survey") +
scale_x_discrete(guide = guide_axis(n.dodge=3))

```
